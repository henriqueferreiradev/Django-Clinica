{% extends 'core/base.html' %}
{% load static %}

{% block title %}Notas Fiscais - Ponto de Equilíbrio{% endblock %}

{% block extra_css %}

<link rel="stylesheet" href="{% static 'core/css/tema.css' %}">

{% endblock %}

{% block topbar_title %}Documentos{% endblock %}

{% block content %}

 <!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist Diário de Lembretes</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
          --roxoPrincipal: #6D398E;
          --roxoPrincipal-hover: #76378f11;
          --roxoPrincipal-hover2: #76378f;
          --roxo-primary-hover: #9b58b4;
          
          --verdePrincipal: #92cbad;
          --branco: #FFF;
          --bg-btn-1: #eee;
          --preto: #000;
          --cinzaBorda: #ccc;
          --cinzaEscuro: #6e6e6e;
          --fontePrincipal: 'Inter';
          --bg-color: #E4E9F7;
          --hover-dropdown: #F0F0F0;
          --shadowRoxo: rgba(118, 55, 143, 0.24) 0px 3px 6px, rgba(118, 55, 143, 0.24) 0px 3px 6px;
          --btn-red-exclude: #ff000025;
          --btn-red-font: #efc4c4;
          --cinza-escuro: #555;
          --cinza-medio: #888;
          --cinza-claro: #eee;
          --cinza-borda: #ddd;
          --erro: #ff0000;
          --titulo-perfil: #64748b;
          --dourado: #D4AF37;
          --verde-sucesso: #10B981;
          --vermelho-alerta: #EF4444;
          --sombra-suave: 0 10px 40px rgba(0, 0, 0, 0.08);
          --sombra-destaque: 0 15px 35px rgba(109, 57, 142, 0.15);
          --borda-arredondada: 16px;
          --transicao: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
          /* Espaçamentos */
          --espaco-xs: 0.5rem;
          --espaco-sm: 1rem;
          --espaco-md: 1.5rem;
          --espaco-lg: 2rem;
          --espaco-xl: 3rem;

          /* Bordas */
          --borda-radius: 8px;
          --borda-radius-sm: 4px;

          /* Sombras */
          --sombra: 0 2px 10px rgba(0, 0, 0, 0.1);
          --sombra-focus: 0 0 0 3px rgba(127, 67, 150, 0.3);

          --backgroundCard: #FFF;
          --backgroundCard-hover: #6d398e38;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--fontePrincipal), sans-serif;
            background-color: var(--bg-color);
            color: var(--cinza-escuro);
            line-height: 1.5;
            padding: var(--espaco-md);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            margin-bottom: var(--espaco-lg);
            text-align: center;
        }

        .header h1 {
            color: var(--roxoPrincipal);
            font-size: 2rem;
            margin-bottom: var(--espaco-xs);
        }

        .header-subtitle {
            color: var(--cinza-medio);
            font-size: 1rem;
            font-weight: 400;
        }

        /* Data e resumo */
        .date-summary {
            background: var(--backgroundCard);
            border-radius: var(--borda-arredondada);
            padding: var(--espaco-md);
            margin-bottom: var(--espaco-lg);
            box-shadow: var(--sombra-suave);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-info {
            display: flex;
            flex-direction: column;
            gap: var(--espaco-xs);
        }

        .date-title {
            font-weight: 600;
            color: var(--roxoPrincipal);
            font-size: 1.2rem;
        }

        .tomorrow-date {
            font-weight: 500;
            color: var(--cinza-escuro);
            font-size: 1.1rem;
        }

        .summary-box {
            display: flex;
            gap: var(--espaco-lg);
            text-align: center;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
        }

        .summary-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .summary-label {
            font-size: 0.9rem;
            color: var(--cinza-medio);
        }

        .total-patients .summary-value {
            color: var(--roxoPrincipal);
        }

        .pending-patients .summary-value {
            color: var(--vermelho-alerta);
        }

        .completed-patients .summary-value {
            color: var(--verde-sucesso);
        }

        /* Lista de pacientes */
        .patients-list {
            display: flex;
            flex-direction: column;
            gap: var(--espaco-sm);
            margin-bottom: var(--espaco-lg);
        }

        .patient-card {
            background: var(--backgroundCard);
            border-radius: var(--borda-radius);
            padding: var(--espaco-md);
            box-shadow: var(--sombra);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transicao);
            border-left: 4px solid var(--roxoPrincipal);
        }

        .patient-card:hover {
            box-shadow: var(--sombra-destaque);
            background-color: var(--backgroundCard-hover);
        }

        .patient-card.completed {
            border-left-color: var(--verde-sucesso);
            opacity: 0.85;
        }

        .patient-info {
            display: flex;
            flex-direction: column;
            gap: var(--espaco-xs);
        }

        .patient-name {
            font-weight: 600;
            color: var(--roxoPrincipal);
            font-size: 1.1rem;
        }

        .patient-completed .patient-name {
            color: var(--verde-sucesso);
        }

        .patient-details {
            display: flex;
            gap: var(--espaco-md);
            flex-wrap: wrap;
        }

        .patient-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--cinza-medio);
            font-size: 0.9rem;
        }

        .patient-detail i {
            color: var(--roxoPrincipal);
        }

        .patient-completed .patient-detail i {
            color: var(--verde-sucesso);
        }

        .patient-actions {
            display: flex;
            align-items: center;
            gap: var(--espaco-sm);
        }

        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: var(--borda-radius-sm);
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .status-pending {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--vermelho-alerta);
        }

        .status-completed {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--verde-sucesso);
        }

        .btn-send {
            background: var(--roxoPrincialGradient);
            color: var(--branco);
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: var(--borda-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transicao);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadowRoxo);
        }

        .btn-send:hover {
            background: var(--roxo-primary-hover);
            box-shadow: 0 5px 15px rgba(118, 55, 143, 0.3);
        }

        .btn-send:disabled {
            background: var(--cinza-medio);
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-send.completed {
            background: var(--verde-sucesso);
        }

        /* Footer e resumo final */
        .footer-summary {
            background: var(--backgroundCard);
            border-radius: var(--borda-arredondada);
            padding: var(--espaco-md);
            box-shadow: var(--sombra-suave);
            margin-top: var(--espaco-xl);
            text-align: center;
        }

        .summary-message {
            margin-bottom: var(--espaco-sm);
            font-size: 1.1rem;
            font-weight: 500;
        }

        .all-completed {
            color: var(--verde-sucesso);
        }

        .pending-exist {
            color: var(--vermelho-alerta);
        }

        .progress-bar {
            height: 8px;
            background-color: var(--cinza-claro);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: var(--espaco-sm);
        }

        .progress-fill {
            height: 100%;
            background: var(--roxoPrincialGradient);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--cinza-medio);
        }

        .empty-state {
            text-align: center;
            padding: var(--espaco-xl);
            color: var(--cinza-medio);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: var(--espaco-sm);
            color: var(--cinza-borda);
        }

        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: var(--espaco-xs);
            color: var(--cinza-escuro);
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .patient-card {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--espaco-sm);
            }

            .patient-actions {
                width: 100%;
                justify-content: space-between;
            }

            .date-summary {
                flex-direction: column;
                gap: var(--espaco-md);
                align-items: flex-start;
            }

            .summary-box {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="content">
        <!-- Cabeçalho -->
        <header class="header">
            <h1><i class="fas fa-check-circle"></i> Checklist Diário de Lembretes</h1>
            <p class="header-subtitle">Controle, conferência e segurança do processo de envio de lembretes</p>
        </header>

        <!-- Informações de data e resumo -->
        <div class="date-summary">
            <div class="date-info">
                <div class="date-title">Pacientes agendados para:</div>
                <div class="tomorrow-date" id="tomorrowDate">Carregando data...</div>
            </div>
            <div class="summary-box">
                <div class="summary-item total-patients">
                    <div class="summary-value" id="totalPatients">0</div>
                    <div class="summary-label">Total</div>
                </div>
                <div class="summary-item pending-patients">
                    <div class="summary-value" id="pendingPatients">0</div>
                    <div class="summary-label">Pendentes</div>
                </div>
                <div class="summary-item completed-patients">
                    <div class="summary-value" id="completedPatients">0</div>
                    <div class="summary-label">Concluídos</div>
                </div>
            </div>
        </div>

        <!-- Lista de pacientes -->
        <div class="patients-list" id="patientsList">
            <!-- Os pacientes serão inseridos aqui via JavaScript -->
        </div>

        <!-- Mensagem de lista vazia -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fas fa-calendar-check"></i>
            <h3>Nenhum paciente agendado para amanhã</h3>
            <p>Não há consultas agendadas para o dia seguinte. O checklist será atualizado automaticamente amanhã.</p>
        </div>

        <!-- Resumo final -->
        <div class="footer-summary">
            <div class="summary-message" id="summaryMessage">
                Verifique todos os pacientes pendentes antes de finalizar o dia.
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <div class="progress-text" id="progressText">0% concluído</div>
        </div>
    </div>



{% include "core/partials/alertas.html" %}
{% endblock %}

{% block scripts %}
<script src="{% static '/core/js/administrativo/nfBase.js' %}"></script>
     <script>
        // Função para formatar data
        function formatDate(date) {
            const options = { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('pt-BR', options);
        }

        // Função para obter a data de amanhã
        function getTomorrowDate() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return tomorrow;
        }

        // Função para simular dados de pacientes do sistema
        function getPatientsForTomorrow() {
            // Em um sistema real, isso viria da API/banco de dados
            // Aqui simulamos alguns pacientes para demonstração
            const tomorrow = getTomorrowDate();
            
            // Verifica se há dados salvos no localStorage
            const savedData = localStorage.getItem(`checklist_${tomorrow.toDateString()}`);
            if (savedData) {
                return JSON.parse(savedData);
            }
            
            // Dados simulados padrão
            const patients = [
                {
                    id: 1,
                    name: "Maria Silva Santos",
                    appointmentTime: "09:30",
                    phone: "(11) 98765-4321",
                    procedure: "Consulta de rotina",
                    reminderSent: false
                },
                {
                    id: 2,
                    name: "João Pereira Oliveira",
                    appointmentTime: "10:15",
                    phone: "(11) 99876-5432",
                    procedure: "Avaliação ortodôntica",
                    reminderSent: false
                },
                {
                    id: 3,
                    name: "Ana Claudia Mendes",
                    appointmentTime: "11:00",
                    phone: "(11) 97654-3210",
                    procedure: "Limpeza dental",
                    reminderSent: false
                },
                {
                    id: 4,
                    name: "Carlos Eduardo Lima",
                    appointmentTime: "14:00",
                    phone: "(11) 96543-2109",
                    procedure: "Restauração",
                    reminderSent: false
                },
                {
                    id: 5,
                    name: "Fernanda Costa Rodrigues",
                    appointmentTime: "15:30",
                    phone: "(11) 95432-1098",
                    procedure: "Consulta de rotina",
                    reminderSent: false
                },
                {
                    id: 6,
                    name: "Roberto Almeida Souza",
                    appointmentTime: "16:45",
                    phone: "(11) 94321-0987",
                    procedure: "Extração",
                    reminderSent: false
                }
            ];
            
            // Salva no localStorage para simular persistência
            localStorage.setItem(`checklist_${tomorrow.toDateString()}`, JSON.stringify(patients));
            return patients;
        }

        // Função para salvar o status atualizado
        function savePatientStatus(patientId, status) {
            const tomorrow = getTomorrowDate();
            const patients = getPatientsForTomorrow();
            
            // Atualiza o status do paciente
            const patientIndex = patients.findIndex(p => p.id === patientId);
            if (patientIndex !== -1) {
                patients[patientIndex].reminderSent = status;
                localStorage.setItem(`checklist_${tomorrow.toDateString()}`, JSON.stringify(patients));
            }
            
            return patients;
        }

        // Função para renderizar a lista de pacientes
        function renderPatientsList() {
            const patientsList = document.getElementById('patientsList');
            const emptyState = document.getElementById('emptyState');
            const patients = getPatientsForTomorrow();
            
            // Verifica se há pacientes
            if (patients.length === 0) {
                patientsList.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            } else {
                patientsList.style.display = 'flex';
                emptyState.style.display = 'none';
            }
            
            // Limpa a lista
            patientsList.innerHTML = '';
            
            // Calcula totais
            const totalPatients = patients.length;
            const completedPatients = patients.filter(p => p.reminderSent).length;
            const pendingPatients = totalPatients - completedPatients;
            
            // Atualiza os contadores
            document.getElementById('totalPatients').textContent = totalPatients;
            document.getElementById('pendingPatients').textContent = pendingPatients;
            document.getElementById('completedPatients').textContent = completedPatients;
            
            // Atualiza a barra de progresso
            const progressPercent = totalPatients > 0 ? Math.round((completedPatients / totalPatients) * 100) : 0;
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${progressPercent}% concluído`;
            
            // Atualiza a mensagem de resumo
            const summaryMessage = document.getElementById('summaryMessage');
            if (pendingPatients === 0 && totalPatients > 0) {
                summaryMessage.textContent = "✅ Todos os lembretes foram enviados com sucesso!";
                summaryMessage.className = "summary-message all-completed";
            } else if (pendingPatients > 0) {
                summaryMessage.textContent = `⚠️ Ainda há ${pendingPatients} paciente(s) pendente(s). Verifique antes de finalizar.`;
                summaryMessage.className = "summary-message pending-exist";
            } else {
                summaryMessage.textContent = "Verifique todos os pacientes pendentes antes de finalizar o dia.";
                summaryMessage.className = "summary-message";
            }
            
            // Renderiza cada paciente
            patients.forEach(patient => {
                const patientCard = document.createElement('div');
                patientCard.className = `patient-card ${patient.reminderSent ? 'completed' : ''}`;
                patientCard.id = `patient-${patient.id}`;
                
                patientCard.innerHTML = `
                    <div class="patient-info ${patient.reminderSent ? 'patient-completed' : ''}">
                        <div class="patient-name">${patient.name}</div>
                        <div class="patient-details">
                            <div class="patient-detail">
                                <i class="fas fa-clock"></i>
                                <span>${patient.appointmentTime}</span>
                            </div>
                            <div class="patient-detail">
                                <i class="fas fa-phone"></i>
                                <span>${patient.phone}</span>
                            </div>
                            <div class="patient-detail">
                                <i class="fas fa-stethoscope"></i>
                                <span>${patient.procedure}</span>
                            </div>
                        </div>
                    </div>
                    <div class="patient-actions">
                        <div class="status-badge ${patient.reminderSent ? 'status-completed' : 'status-pending'}">
                            <i class="fas ${patient.reminderSent ? 'fa-check-circle' : 'fa-clock'}"></i>
                            <span>${patient.reminderSent ? 'Lembrete enviado' : 'Pendente'}</span>
                        </div>
                        <button class="btn-send ${patient.reminderSent ? 'completed' : ''}" 
                                onclick="sendReminder(${patient.id})"
                                ${patient.reminderSent ? 'disabled' : ''}>
                            <i class="fab fa-whatsapp"></i>
                            ${patient.reminderSent ? 'Enviado' : 'Enviar lembrete'}
                        </button>
                    </div>
                `;
                
                patientsList.appendChild(patientCard);
            });
        }

        // Função para enviar lembrete (simulado)
        function sendReminder(patientId) {
            // Aqui em um sistema real, haveria integração com API para envio real
            // Neste caso, apenas registramos no sistema que foi enviado
            savePatientStatus(patientId, true);
            
            // Atualiza a interface
            renderPatientsList();
            
            // Feedback visual para o usuário
            const patientCard = document.getElementById(`patient-${patientId}`);
            patientCard.classList.add('completed');
            
            // Exibe mensagem de sucesso
            const patients = getPatientsForTomorrow();
            const patient = patients.find(p => p.id === patientId);
            
            alert(`Lembrete registrado como enviado para ${patient.name}.`);
            
            // Em um sistema real, aqui poderia ser acionada uma API para envio real pelo WhatsApp
            console.log(`Lembrete enviado para: ${patient.name} - Telefone: ${patient.phone}`);
        }

        // Função para inicializar a página
        function initPage() {
            // Configura a data de amanhã no cabeçalho
            const tomorrow = getTomorrowDate();
            document.getElementById('tomorrowDate').textContent = formatDate(tomorrow);
            
            // Renderiza a lista de pacientes
            renderPatientsList();
            
            // Simula atualização automática diária
            // Em um sistema real, isso seria gerenciado pelo backend
            console.log("Checklist diário carregado para:", formatDate(tomorrow));
        }

        // Inicializa a página quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', initPage);
        
        // Simula a geração automática diária limpando dados antigos
        // Em um sistema real, isso seria feito pelo backend
        function clearOldChecklists() {
            const today = new Date().toDateString();
            const keys = Object.keys(localStorage);
            
            keys.forEach(key => {
                if (key.startsWith('checklist_') && !key.includes(today)) {
                    // Remove checklists de dias anteriores (exceto o de amanhã)
                    const keyDate = key.replace('checklist_', '');
                    const keyDateObj = new Date(keyDate);
                    const tomorrow = getTomorrowDate();
                    
                    if (keyDateObj.toDateString() !== tomorrow.toDateString()) {
                        localStorage.removeItem(key);
                    }
                }
            });
        }
        
        // Executa a limpeza de dados antigos
        clearOldChecklists();
    </script>
 
{% endblock %}