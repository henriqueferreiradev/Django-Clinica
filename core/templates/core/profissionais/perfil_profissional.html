{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
      <script>
 
    (function() {
      const isDark = localStorage.getItem('theme') === 'dark';
      document.documentElement.classList.toggle('dark', isDark);
    })();
  </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Profissional - Ponto de Equilíbrio</title>.

    <link rel="stylesheet" href="{% static 'core/css/tema.css' %}">
    <link rel="stylesheet" href="{% static 'core/css/pacientes/perfil_paciente.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
 
</head>             
<body>
    <div class="container">
        <!-- Header Section -->
        <header>
            <div class="header-content">
                <div class="patient-info">
                    <div class="patient-avatar">
                    {% if profissional.foto %}
                    <img src="{{ profissional.foto.url }}" alt="Foto de {{ profissional.nome }}">
                    {% else %}
                    <img src="{% static 'core/img/defaultPerfil.png' %}" alt="Sem foto">
                    {% endif %}                    </div>
                    <div>
                        <h1 class="patient-name">{{ profissional.nome }} {{ profissional.sobrenome }}</h1>
                        <p class="patient-id">ID: {{ profissional.id }}</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="window.location.href='{% url 'editar_profissional' profissional.id %}'">
                        <i class="fas fa-edit"></i> Editar Dados
                    </button>
                    <button class="btn btn-secondary">
                        <i class="fas fa-plus"></i> Adicionar Observação
                    </button>
                    <button class="btn btn-gray">
                        <i class="fas fa-calendar"></i> Voltar para Agenda
                    </button>
                </div>
            </div>
        </header>

        <div class="grid-container">
            <!-- Left Column -->
            <div class="space-y-6">
                <!-- Section 1: Dados Cadastrais -->
                <section class="section">
                    <h2 class="section-title">Dados Cadastrais</h2>
                    <div class="data-grid">
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Nome Completo</label>
                            <p class="font-medium" > {{ profissional.nome }} {{ profissional.sobrenome }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Nome Social</label>
                            <p class="font-medium" > {{ profissional.nomeSocial }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">CPF/RG</label>
                            <p class="font-medium" >{{ profissional.cpf }} / {{profissional.rg }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Data de Nascimento</label>
                            <p class="font-medium" >{{ profissional.data_nascimento }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Idade</label>
                            <p class="font-medium">{{ profissional.idade_formatada}}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Telefone</label>
                            <p class="font-medium" > {{ profissional.telefone }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">WhatsApp</label>
                            <div class="flex items-center gap-2">
                                <p class="font-medium" >{{ profissional.celular }}</p>
                                <button class="text-green-500 hover:text-green-600">
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                            </div>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">E-mail</label>
                            <p class="font-medium" >{{profissional.email}}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Endereço</label>
                            <p class="font-medium" >{{ profissional.endereco_formatado }} </p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Cor/Raça</label>
                            <p class="font-medium" >{{ profissional.get_cor_raca_display }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Sexo/Gênero</label>
                            <p class="font-medium" >{{ profissional.get_sexo_display }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Estado Civil</label>
                            <p class="font-medium" >{{ profissional.get_estado_civil_display }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Profissão</label>
                            <p class="font-medium" >{{ profissional.especialidade }}</p>
                        </div>
 
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Rede Social</label>
                            <p class="font-medium" >{{ profissional.redeSocial }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Conselho Principal</label>
                            <p class="font-medium" >{{ profissional.get_conselho1_display  }} - {{ profissional.num1_conseho }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Conselho Complementar</label>
                            {% if profissional.get_conselho2_display %}
                                <p class="font-medium">{{ profissional.get_conselho2_display }} - {{ profissional.num2_conseho }}</p>
                            {% else %}
                                <p class="font-medium text-gray-400">Não informado</p>
                            {% endif %}
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Conselho Complementar</label>
                            {% if profissional.get_conselho2_display %}
                                <p class="font-medium">{{ profissional.get_conselho3_display }} - {{ profissional.num3_conseho }}</p>
                            {% else %}
                                <p class="font-medium text-gray-400">Não informado</p>
                            {% endif %}
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Conselho Complementar</label>
                            {% if profissional.get_conselho2_display %}
                                <p class="font-medium">{{ profissional.get_conselho4_display }} - {{ profissional.num4_conseho }}</p>
                            {% else %}
                                <p class="font-medium text-gray-400">Não informado</p>
                            {% endif %}
                        </div>

                    </div>
                </section>

                <!-- Section 2: Dados de Atendimento -->
                <section class="section">
                    <h2 class="section-title">Dados de Atendimento</h2>
                    <div class="data-grid data-grid-3">
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Primeiro Atendimento</label>
                            <p class="font-medium">{% if primeiro_agendamento %} {{primeiro_agendamento|date:"d/m/Y"}} {% else %} Sem registros {% endif %}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Último Atendimento</label>
                            <p class="font-medium">{% if ultimo_agendamento %} {{ultimo_agendamento|date:"d/m/Y"}} {% else %} Sem registros {% endif %}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Status</label>
                            <span class="badge badge-success">{% if profissional.ativo %} Ativo {% else %} Inativo {% endif %}</span>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Frequência Semanal</label>
                            <p class="font-medium">{% if frequencia_semanal %} {{ frequencia_semanal }}x/Semana {% else %} 0x/Semana {% endif %}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Total de Sessões</label>
                            <p class="font-medium">{{quantidade_agendamentos}}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Sessões Faltadas</label>
                            <p class="font-medium">{{quantidade_faltas}}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Sessões Remarcadas</label>
                            <p class="font-medium">{{quantidade_repostas}}</p>
                        </div>
                    </div>
                </section>
    <section class="section">
        <h2 class="section-title">Pacientes Mais Atendidos</h2>
        <div class="space-y-4">
            {% if pacientes_mais_atendidos %}
                {% for paciente in pacientes_mais_atendidos %}
                    <div class="professional-card">
                        <div class="professional-avatar">
                            {% if paciente.paciente__foto %}
                                <img src="{{ MEDIA_URL }}{{ paciente.paciente__foto }}" alt="Foto de {{ paciente.paciente__nome }}">
                            {% else %}
                                <div class="profile-placeholder">
                                    {{ paciente.paciente__nome|slice:":1" }}
                                </div>
                            {% endif %}
                        </div>
                        <div>
                            <h3 class="professional-name">{{ paciente.paciente__nome }}</h3>
                            <p class="professional-sessions">{{ paciente.total }} atendimentos</p>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-gray-500">Nenhum paciente atendido ainda.</p>
            {% endif %}
        </div>
    </section>
                <!-- Section 3: Pacotes e Sessões -->
                <section class="section">
                    <h2 class="section-title">Pacotes e Sessões</h2>
                    
                    <div class="mb-6">
                        <h3 class="font-medium text-gray-700 mb-2">Pacote Ativo</h3>
                        {% if pacote_ativo %}
                        <div class="package-card">
                            <div class="package-header">
                                <h4 class="package-title">{{pacote_ativo}} ({{qtd_total}} sessões)</h4>
                                <span class="badge badge-info">{% if pacote_ativo.ativo %} Ativo {% else %} Inativo {% endif %}</span>
                            </div>
                            <p class="package-description">Inclui: Sessões de 50min com psicólogo</p>
                            
                            <div class="progress-container">
                                <div class="progress-info">
                                    <span>Progresso: {{sessao_atual}}/{{qtd_total}} sessões</span>
                                    <span>{{progresso}}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: {{progresso}}%"></div>
                                </div>
                            </div>
                            
                            <div class="data-grid">
                                <div>
                                    <p class="text-gray-500 text-sm">Início</p>
                                    <p class="font-medium">{{data_inicio_pacote_ativo}}</p>
                                </div>
                                <div>
                                    <p class="text-gray-500 text-sm">Vencimento</p>
                                    <p class="font-medium">Sem vencimento</p>
                                </div>
                            </div>
                        </div>
                        {% else %}
                            <h4 class="package-title text-sm">Não há informações no momento.</h4>    
                        {% endif %}
                    </div>
                    
                    <h3 class="font-medium text-gray-700 mb-2">Histórico de Pacotes</h3>
                    
                    <div class="space-y-3">
                    {% if pacotes_dados %}
                        {% for pacote in pacotes_dados %}
                            <div class="note-card">
                                <div class="package-header">
                                    <h4 class="package-title text-sm">
                                        {{ pacote.pacote.servico.nome }} ({{ pacote.qtd_total }} sessões)
                                    </h4>
                                    <span class="badge {% if item.status == 'Ativo' %}badge-success{% else %}badge-gray{% endif %}">
                                        {{ pacote.status }}
                                    </span>
                                </div>
                    
                                <p class="text-gray-600 text-sm mb-1">
                                    {{ pacote.data_inicio|date:"d/m/Y" }}
                                    {% if pacote.data_fim %}
                                        - {{ pacote.data_fim|date:"d/m/Y" }}
                                    {% endif %}
                                </p>
                    
                                <p class="text-gray-600 text-sm">
                                    {{ pacote.sessoes_realizadas }}/{{ pacote.qtd_total }} sessões realizadas
                                </p>
                            </div>
                        {% endfor %}
                    {% else %}
                     <h4 class="package-title text-sm">Não há informações no momento.</h4>
                     {% endif %}
                    </div>
                    
                </section>

                <!-- Section 4: Serviços Mais Contratados -->
                <section class="section">
                
                    <h2 class="section-title">Serviços Mais Contratados</h2>
                    <div class="data-grid">
                    {% if mais_contratados %}
                        {% for especialidade in mais_contratados %}
                        <div class="note-card">
                            
                            <div class="package-header">
                                <h3 class="package-title text-sm"> {{especialidade.nome}}</h3>
                                <span class="badge badge-info" style= ' color:white; background:{{especialidade.cor}}'>{% if especialidade.total == 1 %}{{especialidade.total}} sessão {% else %} {{especialidade.total}} sessões {% endif %}</span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <h4 class="package-title text-sm">Não há informações no momento.</h4>    
                    {% endif %}

                    </div>
                </section>
            </div>

            <!-- Right Column -->
            <div class="space-y-6">
                <!-- Section 5: Profissionais que mais atenderam -->
                <section class="section">
                    <h2 class="section-title">Tempo de atendimento</h2>
                    <h2 class="section-subtitle">Como Condutor da Sessão</h2>
                    <div class="space-y-4">
                    {% if profissional_principal %}
                        {% for profissional in profissional_principal %}
                            <div class="professional-card">
                                <div class="professional-avatar">
                                    {% if profissional.profissional_1__foto %}
                                        <img src="{{ profissional.foto_url }}" alt="Foto de {{ profissional.nome }}" width="150">
                                    {% else %}
                                        <div class="profile-placeholder">
                                            {{ profissional.nome|slice:":1" }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div>
                                    <h3 class="professional-name">{{profissional.profissional_1__nome}}</h3>
                                    <p class="professional-sessions">{{profissional.total}} atendimentos | {{profissional.tempo_sessao}} totais</p>
                            
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <h3 class="professional-name">Não há informações no momento.</h3>
                    {% endif %}
                        <h2 class="section-subtitle">Como Apoio na Sessão</h2>
                    {% if profissional_auxiliar %}
                    {% for profissional in profissional_auxiliar %}
                        <div class="professional-card">
                            <div class="professional-avatar">
                                {% if profissional.profissional_1__foto %}
                                    <img src="{{ profissional.foto_url }}" alt="Foto de {{ profissional.nome }}" width="150">
                                {% else %}
                                    <div class="profile-placeholder">
                                        {{ profissional.nome|slice:":1" }}
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                <h3 class="professional-name">{{profissional.profissional_2__nome}}</h3>
                                <p class="professional-sessions">{{profissional.total}} atendimentos | {{profissional.tempo_sessao}} totais</p>
                            </div>
                        </div>
                     {% endfor %}
                    {% else %}
                        <h3 class="professional-name">Não há informações no momento.</h3>
                    {% endif %}
                    </div>
                </section>

                <!-- Section 6: Histórico de Agendamentos -->
                <section class="section">
                    <h2 class="section-title">Histórico de Agendamentos</h2>
                    <ul class="timeline space-y-4">
                        {% if tres_ultimos_agendamentos %}
                            {% for agendamento in tres_ultimos_agendamentos %}
                                <li class="timeline-item">
                                    <div class="timeline-dot"></div>
                                    <div class="timeline-content">
                                        <div class="timeline-header">
                                            <div>
                                                <h3 class="timeline-title">{{ agendamento.paciente.nome }}</h3>
                                                <p class="timeline-date text-sm">
                                                    {{ agendamento.data|date:"d/m/Y" }} - 
                                                    {{ agendamento.hora_inicio|time:"H:i" }} / 
                                                    {{ agendamento.hora_fim|time:"H:i" }}
                                                </p>
                                            </div>
                                            <span class="badge badge-success">{{ agendamento.get_status_display }}</span>
                                        </div>
                                        <p class="timeline-meta text-sm">{{ agendamento.especialidade.nome }}</p>
                                        {% if agendamento.observacoes %}
                                            <p class="timeline-note">{{ agendamento.observacoes|truncatechars:100 }}</p>
                                        {% endif %}
                                    </div>
                                </li>
                            {% endfor %}
                            <button style='width: 100%;' class="btn btn-primary">
                                Ver histórico completo
                            </button>
                        {% else %}
                            <p class="text-gray-500">Nenhum agendamento registrado.</p>
                        {% endif %}
                    </ul>
                </section>

                <!-- Section 7: Observações Gerais -->
                <section class="section">
                    <h2 class="section-title">Prontuários</h2>
                    <div class="space-y-3">
                        {% if prontuarios %}
                            {% for agendamento in prontuarios %}
                                <div class="note-card">
                                    <div class="note-header">
                                        <p class="note-author">
                                            {{ agendamento.paciente.nome }} - 
                                            {{ agendamento.data|date:"d/m/Y" }} - 
                                            {{ agendamento.hora_inicio|time:"H:i" }}
                                        </p>
                                        <p class="note-date">{{ agendamento.observacao_data|date:"d/m/Y" }}</p>
                                    </div>
                                    <p class="note-content">{{ agendamento.observacoes }}</p>
                                </div>
                            {% empty %}
                                <p class="text-gray-500">Nenhum prontuário registrado.</p>
                            {% endfor %}
                        {% else %}
                            <p class="text-gray-500">Nenhum prontuário registrado.</p>
                        {% endif %}
                    </div>
                </section>

                <!-- Section 8: Dados Financeiros -->
                <section class="section">
                    <h2 class="section-title">Dados Financeiros</h2>
                    <div class="space-y-4">
                        <div>
                            <p class="financial-label">Total gasto</p>
                            <p class="financial-total">{{soma_pagamentos}}</p>
                        </div>
                        <div class="payment-ranking">
    <p class="financial-label">Ranking de Pagamentos</p>
    <div class="table-wrapper">
        <table class="ranking-table">
            <thead>
                <tr>
                    <th>Ícone</th>
                    <th>Forma de Pagamento</th>
                    
                    <th>Quantidade</th>
                    <th>Porcentagem</th>
                </tr>
            </thead>
            <tbody>
                {% for pagamento in top_forma_pagamento %}
                <tr>
                <td>
                       <div class="{% if pagamento.forma_pagamento == 'pix' %}payment-icon blue
                                {% elif pagamento.forma_pagamento == 'dinheiro' %}payment-icon green
                                {% elif pagamento.forma_pagamento == 'credito' %}payment-icon yellow
                                {% elif pagamento.forma_pagamento == 'debito' %}payment-icon purple
                                {% else %}payment-icon red{% endif %}">
                                    <i class="{% if pagamento.forma_pagamento == 'pix' %}fas fa-qrcode blue
                                    {% elif pagamento.forma_pagamento == 'dinheiro' %}fas fa-money-bill-wave green
                                    {% elif pagamento.forma_pagamento == 'credito' %}fas fa-credit-card yellow
                                    {% elif pagamento.forma_pagamento == 'debito' %}fas fa-money-check purple
                                    {% else %}fas fa-question-circle red{% endif %}"></i> 
                                </div>
                                
                    </td>
                    <td>{{ pagamento.forma_pagamento|title }}</td>
                    
                    <td>{{ pagamento.quantidade }}x</td>
                    <td>{{ pagamento.porcentagem }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

                        <div>
                            <p class="financial-label">Débitos pendentes</p>
                            {% if total_debito %}
                            <p class=" financial-total font-medium text-green-600">R$ {{total_debito}}</p>
                            {% else %}
                            <p class="font-medium text-green-600">Nenhum débito pendente</p>
                            {% endif %}
                        </div>
                       <div class="payment-list">
        <h3 class="text-sm font-medium mb-2">Últimos pagamentos</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left">
                <thead>
                    <tr class="border-b">
                        <th class="py-2 px-3 ">Data</th>
                        <th class="py-2 px-3 ">Forma de Pagamento</th>
                        <th class="py-2 px-3 ">Valor</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    {% if ultimos_pagamentos %}
                    {% for pagamento in ultimos_pagamentos %}
                    <tr>
                        <td class="py-2 px-3">{{ pagamento.data|date:'d/m/Y' }}</td>
                        <td class="py-2 px-3">{{ pagamento.get_forma_pagamento_display }}</td>
                        <td class="py-2 px-3 text-green-600 font-medium">R$ {{ pagamento.valor }}</td>
                        
                    </tr>
                    {% endfor %}
                    {% else %}
                        <h3 class="professional-name">Não há informações no momento.</h3>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Quick Actions Footer -->
        <div class="quick-actions">
            <button class="action-btn action-btn-primary">
                <i class="fas fa-calendar-plus"></i>
            </button>
            <button class="action-btn action-btn-success">
                <i class="fab fa-whatsapp"></i>
            </button>
            <button class="action-btn action-btn-instagram" onclick="window.open('https://instagram.com/{{ profissional.redeSocial }}', '_blank')">
                <i class="fab fa-instagram"></i>
            </button>
            <button  class="action-btn action-btn-dark" onclick="abrirFicha('{% url 'ficha_profissional' profissional.id %}')">
                <i class="fas fa-file-pdf"></i>
            </button>
        </div>
    </div>
    {% include "core/partials/alertas.html" %}

    {% block scripts %}
<script>
const btnToggleObs = document.getElementById('btnToggleObs');
const btnCancelObs = document.getElementById('btnCancelObs');
const obsContainer = document.getElementById('obs-container');
const btnSave = document.getElementById('btnSave');

function toggleObservacao() {
    const isVisible = obsContainer.style.display === 'block';

    if (isVisible) {
        // Ocultar observação
        obsContainer.style.display = 'none';
        btnSave.style.display = 'none';
        btnToggleObs.style.display = 'inline-block';
    } else {
        // Mostrar observação
        obsContainer.style.display = 'block';
        btnSave.style.display = 'block';
        btnToggleObs.style.display = 'none';
    }
}

</script>
  
<script src="https://unpkg.com/imask"></script>

<script src="{% static '/core/js/profissionals/base.js' %}"></script>
<script src="{% static '/core/js/base/base.js' %}"></script>
<script src="{% static '/core/js/profissionals/cep.js' %}"></script>
{% endblock %}
</body>

</html>