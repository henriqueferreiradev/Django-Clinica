{% extends 'core/base.html' %}

{% load static %}
{% block title %}Dashboard - Ponto de Equilíbrio{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/dashboard.css' %}">
 

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

{% endblock %}




{% block topbar %}
<div class="topbar">
  <div class="topbar-div">
    <i class='bx bx-menu'></i>
    <span class="text">Dashboard</span>
  </div>

  <div class="topbar-div">
    <div class="dropdown">
      <div class="profile-button">
          {{ user.get_full_name }} <i class='bx bx-chevron-down'></i>
      </div>
      <div class="dropdown-content">
        <a href="{% url 'config' %}">Ver Perfil</a>
        <button onclick="toggleDarkMode()">Alternar Tema</button>
        <a href="{% url 'logout' %}">Sair</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block content %}
{% if messages %}
<div class="messages-container" id="alert-container">
    {% for message in messages %}
    <div class="alert {{ message.tags }}">
        <span class="icon">
            {% if message.tags == 'success' %}
            ✅
            {% elif message.tags == 'warning' %}
            ⚠️
            {% elif message.tags == 'error' %}
            ❌
            {% elif message.tags == 'info' %}
            ℹ️
            {% endif %}
        </span>
        {{ message }}

    </div>
    {% endfor %}
</div>
{% endif %}
<div class="content">

  <div class="cards-grid">
    <!-- Card 1 -->
    <div class="card card-blue">
        <div class="card-content">
            <div class="card-text">
                <p>Pacientes ativos</p>
                <h3>{{ total_pacientes_ativos }}</h3>
                <p class="trend trend-up"><i class="fas fa-arrow-up"></i> 12% desde a semana passada</p>
            </div>
            <div class="card-icon">
                <i class="fas fa-user-injured"></i>
            </div>
        </div>
    </div>
    
    <!-- Card 2 -->
    <div class="card card-green">
        <div class="card-content">
            <div class="card-text">
                <p>Profissionais ativos</p>
                <h3>{{ total_profissionais_ativos }}</h3>
                <p class="trend trend-up"><i class="fas fa-arrow-up"></i> 2 novos este mês</p>
            </div>
            <div class="card-icon">
                <i class="fas fa-user-md"></i>
            </div>
        </div>
    </div>
    
    <!-- Card 3 -->
    <div class="card card-purple">
        <div class="card-content">
            <div class="card-text">
                <p>Atendimentos semana</p>
                <h3>{{ agendamentos_semana }}</h3>
                <p class="trend trend-down"><i class="fas fa-arrow-down"></i> 5% menos que semana passada</p>
            </div>
            <div class="card-icon">
                <i class="fas fa-calendar-check"></i>
            </div>
        </div>
    </div>
        <div class="card card-yellow">
        <div class="card-content">
            <div class="card-text">
                <p>Sessões hoje</p>
                <h3>{{ agendamentos_dia }}</h3>
                <p> {% if agendamentos_dia_finalizados > 1 %}
                {{ agendamentos_dia_finalizados }} finalizados {% else %}  {{ agendamentos_dia_finalizados }} finalizado, {% endif %}
                {% if agendamentos_dia_pendentes > 0 %}
                {{ agendamentos_dia_pendentes }} pendentes {% else %} {{ agendamentos_dia_pendentes }} pendente  {% endif %}</p>
            </div>
            <div class="card-icon">
                <i class="fas fa-clock"></i>
            </div>
        </div>
    </div>
    <div class="card card-red">
        <div class="card-content">
            <div class="card-text">
                <p>Sessões finalizadas</p>
                <h3>3</h3>
                <p>25% do total de hoje</p>
            </div>
            <div class="card-icon">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
    </div>
    
    <!-- Card 6 -->
    <div class="card card-orange">
        <div class="card-content">
            <div class="card-text">
                <p>Faltas hoje</p>
                <h3>1</h3>
                <p>8% do total de hoje</p>
            </div>
            <div class="card-icon">
                <i class="fas fa-user-slash"></i>
            </div>
        </div>
    </div>

</div>
  <div class="section">
    <h2>Atendimentos do dia</h2>
    <table>
      <thead>
        <tr>
          <th></th>
          <th class='col-hora'>Horário</th>
          <th class='col-paciente'>Paciente</th>
          <th class='col-profissional'>Profissional</th>
          <th class='col-especialidade'>Especialidade</th>
          <th class='col-infos'>Informações do pacote</th>
          <th class='col-status'>Status</th>
          <th class='col-acoes'>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% if agendamentos %}
          {% for agendamento in agendamentos %}
            <tr>
              <td style="width: 5px; background-color: {{ agendamento.especialidade.cor }};"></td>
              <td>{{ agendamento.hora_inicio }} - {{ agendamento.hora_fim }}</td>
              <td>{{ agendamento.paciente.nome }} {{ agendamento.paciente.sobrenome }}</td>
              <td>{{ agendamento.profissional_1.nome }} {{ agendamento.profissional_1.sobrenome }}</td>
              <td>{{ agendamento.especialidade.nome }}</td>
              <td>
                {% if agendamento.sessao_atual %}
                  {% if agendamento.codigo|slice:":3" == "REP" %}
                    <span class="sessao vermelho">Sessão de Reposição | {{ agendamento.codigo }}</span>
                  {% else %}
                    <span class="sessao verde">
                      Sessão {{ agendamento.sessao_atual }} de {{ agendamento.sessoes_total }} | {{ agendamento.sessoes_restantes }} restante(s) | {{ agendamento.codigo }}
                    </span>
                  {% endif %}
                {% else %}
                  <span class="sessao">Sessões finalizadas</span>
                {% endif %}
              </td>
              <td class='status-col'>
                <form method="post" action="{% url 'alterar_status_dashboard' agendamento.id %}">
                  {% csrf_token %}
                  <select name="status" class="status-select">
                    <option value="pre" {% if agendamento.status == 'pre' %}selected{% endif %}>✅ Pré-Agendado</option>
                    <option value="agendado" {% if agendamento.status == 'agendado' %}selected{% endif %}>✅ Agendado</option>
                    <option value="finalizado" {% if agendamento.status == 'finalizado' %}selected{% endif %}>✅ Consulta finalizada!</option>
                    <option value="desistencia" {% if agendamento.status == 'desistencia' %}selected{% endif %}>❌ D - Desmarcação</option>
                    <option value="desistencia_remarcacao" {% if agendamento.status == 'desistencia_remarcacao' %}selected{% endif %}>⚠️ DCR - Desmarcação com reposição</option>
                    <option value="falta_remarcacao" {% if agendamento.status == 'falta_remarcacao' %}selected{% endif %}>⚠️ FCR - Falta com reposição</option>
                    <option value="falta_cobrada" {% if agendamento.status == 'falta_cobrada' %}selected{% endif %}>❌ FC - Falta cobrada</option>
                  </select>
              </td>
              <td>
                <div class="actions-col">
                  <button type="submit" class="action-btn tooltip"><i class='bx bx-save'></i><span class="tooltiptext">Salvar Status</span></button>
                  <a href="{% url 'confirmacao_agendamento' agendamento.id %}">
                    <button type="button" class="action-btn tooltip"><i class='bx bx-send'></i><span class="tooltiptext">Ver detalhes</span></button>
                  </a>
                </div>
              </td>
              </form>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td class='linha-vazia' colspan="8">Nenhum agendamento encontrado.</td></tr>
        {% endif %}
      </tbody>
      
    </table>
  </div>

<!-- Second Row of Quick Stats
<div class="cards-grid-2">
     

    
</div> -->

  <h2>Visão Geral dos Atendimentos</h2>
<div class="charts-row charts-row-1">
 
    <div class="chart-container">
        <div class="chart-header">
            <h3 class="chart-title">Atendimentos por dia (últimos 7 dias)</h3>
 
        </div>
    <div  style="position: relative; width: 100%; max-width: 900px; margin: auto;" class="chart-canvas-container">
        <canvas id="barChart"></canvas>
    </div>

    {{ chart_data|json_script:"chart-data" }}

    </div>
    
    <!-- Chart 2 -->
    <div class="chart-container">
        <div class="chart-header">
            <h3 class="chart-title">Evolução mensal de atendimentos</h3>

        </div>
        <div class="chart-canvas-container">
            <canvas id="evolucaoMensalChart"></canvas>
        </div>
        {{ evolucao_mensal_data|json_script:'evolucao-chart' }}
    </div>
        <!-- Chart 3 -->
    <div class="chart-container">
        <div class="chart-header">
            <h3 class="chart-title">Distribuição por profissional</h3>
           
        </div>
        <div class="chart-canvas-container">
            <canvas id="distribuicaoProfissionalChart"></canvas>
            {{ distribuicao_por_profissional|json_script:'distribuicao_por_profissional-chart' }}
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="charts-row charts-row-2">

    
    <!-- Chart 4 -->
    <div class="chart-container">
        <div class="chart-header">
            <h3 class="chart-title">Serviços mais contratados</h3>
       
        </div>
        <div class="chart-canvas-container"  style="display: flex; align-items: center;">
            <canvas id="servicosChart"></canvas>
            {{ servicos_mais_contratados|json_script:'servicos-chart' }}
        </div>
    </div>
    
    <!-- Chart 5 -->
    <div class="chart-container">
        <div class="chart-header">
            <h3 class="chart-title">Status dos agendamentos</h3>
 
        </div>
        <div class="chart-canvas-container">
            <canvas id="statusChart"></canvas>
            {{ grafico_status_agendamentos|json_script:'status-chart' }}
        </div>
    </div>
        <div class="chart-container">
        <div class="chart-header">
            <h3 class="chart-title">Formas de pagamento</h3>
 
        </div>
        <div class="chart-canvas-container">
            <canvas id="pagamentoChart"></canvas>
            {{ grafico_formas_pagamento|json_script:'formas_pagamento-chart' }}
        </div>
    </div>
</div>


  <div class="section">
    <h2>Avisos</h2>
    <div class="avisos">
      <ul>
        <li>📢 Feriado na próxima quarta-feira (não haverá atendimento)</li>
        <li>✅ Novo paciente agendado para amanhã - 14h</li>
        <li>💡 Lembre-se de atualizar os dados financeiros semanalmente</li>
      </ul>
    </div>
  </div>

</div>


 

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://unpkg.com/imask"></script>
<script src="{% static '/core/js/base/scriptBase.js' %}"></script>
<script src="{% static '/core/js/pacientes/base.js' %}"></script>
<script src="{% static '/core/js/pacientes/cep.js' %}"></script>
<script src="{% static '/core/js/dashboard/chartDash.js' %}"></script>
{% endblock %}
 