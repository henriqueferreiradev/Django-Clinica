{% extends 'core/base.html' %}
{% load static %}

{% block title %}Configurações - Ponto de Equilíbrio{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/alerts.css' %}" />
<link rel="stylesheet" href="{% static 'core/css/tema.css' %}" />
<style>
    /* Container principal - seguindo o estilo da agenda */
    .content.multipage {
        background: var(--branco);
        border-radius: var(--borda-arredondada);
        padding: var(--espaco-md);
        margin-top: var(--espaco-md);
        box-shadow: var(--sombra-suave);
        height: auto;
        min-height: calc(100vh - 120px);
        max-height: none;
        overflow-y: visible;
    }

    /* Tabs - estilo moderno igual à agenda com scroll horizontal */
    .tabs {
        display: flex;
        gap: var(--espaco-xs);
        border-bottom: 2px solid var(--roxoPrincipal);
        margin-bottom: var(--espaco-lg);
        padding-bottom: 2px;
        flex-wrap: nowrap;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
        padding: var(--espaco-xs) 0;
    }

    .tabs::-webkit-scrollbar {
        display: none;
    }

    .tab {
        background: transparent;
        border: 2px solid transparent;
        border-bottom: none;
        padding: var(--espaco-sm) var(--espaco-md);
        font-weight: 600;
        font-size: 0.85rem;
        border-radius: var(--borda-radius) var(--borda-radius) 0 0;
        cursor: pointer;
        color: var(--cinza-escuro);
        transition: var(--transicao);
        display: flex;
        align-items: center;
        gap: var(--espaco-xs);
        white-space: nowrap;
        flex-shrink: 0;
    }

    .tab.active {
        background: var(--roxoPrincipal);
        color: var(--branco);
        border-color: var(--roxoPrincipal);
        transform: translateY(1px);
    }

    .tab:hover:not(.active) {
        background: var(--roxoPrincipal-hover);
        color: var(--roxoPrincipal);
        border-color: var(--roxoPrincipal);
    }

    /* Conteúdo das tabs */
    .tab-content {
        display: none;
        animation: fadeIn 0.4s ease-out forwards;
    }

    .tab-content.active {
        display: block;
    }

    /* Forms - seguindo o padrão da agenda */
    .form {
        background: var(--branco);
        border: 1px solid var(--cinza-borda);
        border-radius: var(--borda-arredondada);
        padding: var(--espaco-lg);
        margin-bottom: var(--espaco-lg);
        box-shadow: var(--sombra-suave);
        position: relative;
        overflow: hidden;
    }

    .form::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 4px;
        width: 100%;
        background: linear-gradient(to right, var(--roxoPrincipal), var(--roxo-primary-hover));
    }

    .form_titulo {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--roxoPrincipal);
        margin-bottom: var(--espaco-lg);
        display: flex;
        align-items: center;
        gap: var(--espaco-sm);
        padding-bottom: var(--espaco-sm);
        border-bottom: 2px solid var(--cinza-claro);
    }

    /* Layout de formulário grid - igual à agenda */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: var(--espaco-md);
        margin-bottom: var(--espaco-lg);
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: var(--espaco-xs);
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    .form-group label {
        color: var(--cinza-escuro);
        font-weight: 600;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: var(--espaco-xs);
    }

    /* Input fields - padrão agenda */
    .input-field {
        background: var(--branco);
        border: 2px solid var(--cinza-borda);
        border-radius: var(--borda-radius);
        padding: 0.75rem 1rem;
        color: var(--preto);
        width: 100%;
        font-size: 0.95rem;
        transition: var(--transicao);
        box-sizing: border-box;
        font-family: var(--fontePrincipal);
    }

    .input-field:focus {
        outline: none;
        border-color: var(--roxoPrincipal);
        box-shadow: var(--sombra-focus);
        transform: translateY(-1px);
    }

    .input-field:disabled {
        background-color: var(--cinza-claro);
        border-color: var(--cinza-borda);
        color: var(--cinza-medio);
        cursor: not-allowed;
        transform: none;
    }

    /* Textarea específico */
    textarea.input-field {
        resize: vertical;
        min-height: 80px;
        font-family: var(--fontePrincipal);
        line-height: 1.5;
    }

    /* Select múltiplo */
    select.input-field[multiple] {
        height: auto;
        min-height: 120px;
        padding: 0.75rem;
    }

    select.input-field[multiple] option {
        padding: 0.5rem;
        margin: 0.25rem 0;
        border-radius: var(--borda-radius-sm);
        transition: var(--transicao);
    }

    select.input-field[multiple] option:hover {
        background: var(--roxoPrincipal-hover);
    }

    select.input-field[multiple] option:checked {
        background: var(--roxoPrincipal);
        color: var(--branco);
    }

    /* Input de cor personalizado */
    .color-input-wrapper {
        display: flex;
        align-items: center;
        gap: var(--espaco-sm);
    }

    .color-input {
        width: 60px !important;
        height: 45px;
        padding: 0.2em;
        cursor: pointer;
        border: 2px solid var(--cinza-borda);
        border-radius: var(--borda-radius);
        transition: var(--transicao);
    }

    .color-input:hover {
        border-color: var(--roxoPrincipal);
        transform: scale(1.05);
    }

    .color-preview {
        width: 40px;
        height: 40px;
        border-radius: var(--borda-radius);
        border: 2px solid var(--cinza-borda);
        box-shadow: var(--sombra-suave);
        transition: var(--transicao);
    }

    /* Botões - estilo agenda */
    .btn-submit {
        background: linear-gradient(135deg, var(--roxoPrincipal), var(--roxo-primary-hover));
        border: none;
        padding: 0.875rem 1.75rem;
        border-radius: var(--borda-radius);
        font-weight: 700;
        color: var(--branco);
        cursor: pointer;
        transition: var(--transicao);
        font-size: 0.95rem;
        display: inline-flex;
        align-items: center;
        gap: var(--espaco-xs);
        box-shadow: var(--sombra-destaque);
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(127, 67, 150, 0.35);
        background: linear-gradient(135deg, var(--roxo-primary-hover), var(--roxoPrincipal));
    }

    .btn-submit:disabled {
        background: var(--cinza-medio);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* Tabelas - estilo agenda */
    .tabela-wrapper {
        border: 1px solid var(--cinza-borda);
        border-radius: var(--borda-arredondada);
        overflow: hidden;
        margin-top: var(--espaco-lg);
        box-shadow: var(--sombra-suave);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        color: var(--preto);
    }

    thead {
        background: linear-gradient(135deg, var(--roxoPrincipal), var(--roxo-primary-hover));
        color: var(--branco);
    }

    th, td {
        padding: 1rem;
        border-bottom: 1px solid var(--cinza-borda);
        text-align: left;
    }

    th {
        font-weight: 700;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    tbody tr {
        transition: var(--transicao);
    }

    tbody tr:nth-child(even) {
        background: var(--cinza-claro);
    }

    tbody tr:hover {
        background: var(--roxoPrincipal-hover);
        transform: translateX(4px);
    }

    /* Estados inativo - seguindo padrão agenda */
    .inativo {
        background-color: var(--vermelho-alerta) !important;
        opacity: 0.7;
        color: var(--branco);
    }

    .inativo td {
        color: var(--branco);
    }

    /* Status badges - estilo agenda */
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-badge.active {
        background: var(--verde-sucesso);
        color: var(--branco);
    }

    .status-badge.inactive {
        background: var(--vermelho-alerta);
        color: var(--branco);
    }

    /* Mensagens de formulário */
    .form-message {
        font-size: 0.85rem;
        margin-top: var(--espaco-xs);
        padding: 0.75rem;
        border-radius: var(--borda-radius);
        display: none;
        font-weight: 500;
    }

    .form-message.success {
        background: linear-gradient(to right, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
        border-left: 4px solid var(--verde-sucesso);
        color: var(--verde-sucesso);
        display: block;
    }

    .form-message.error {
        background: linear-gradient(to right, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
        border-left: 4px solid var(--vermelho-alerta);
        color: var(--vermelho-alerta);
        display: block;
    }

    /* Select styles - igual agenda */
    select.input-field {
        padding-right: 2.5rem;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236D398E' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
        appearance: none;
        cursor: pointer;
    }

    /* File input customizado */
    .input-field[type="file"] {
        padding: 0.5rem;
        border: 2px dashed var(--cinza-borda);
        background: var(--cinza-claro);
    }

    .input-field[type="file"]:hover {
        border-color: var(--roxoPrincipal);
        background: var(--roxoPrincipal-hover);
    }

    /* Checkbox e radio customizados */
    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: var(--espaco-sm);
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: var(--espaco-sm);
        padding: var(--espaco-sm);
        border: 1px solid var(--cinza-borda);
        border-radius: var(--borda-radius);
        transition: var(--transicao);
        cursor: pointer;
    }

    .checkbox-item:hover {
        border-color: var(--roxoPrincipal);
        background: var(--roxoPrincipal-hover);
    }

    .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--roxoPrincipal);
    }

    /* Ações na tabela */
    .acoes-cell {
        display: flex;
        gap: var(--espaco-xs);
    }

    .btn-acao {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border: none;
        border-radius: var(--borda-radius);
        background: transparent;
        color: var(--cinza-escuro);
        cursor: pointer;
        transition: var(--transicao);
        font-size: 1.1rem;
    }

    .btn-acao:hover {
        transform: translateY(-2px);
        box-shadow: var(--sombra-suave);
    }

    .btn-acao.editar:hover {
        background: var(--verde-sucesso);
        color: var(--branco);
    }

    .btn-acao.excluir:hover {
        background: var(--vermelho-alerta);
        color: var(--branco);
    }

    /* Responsividade */
    @media (max-width: 768px) {
        .content.multipage {
            padding: var(--espaco-sm);
            margin-top: var(--espaco-sm);
            border-radius: var(--borda-radius);
        }

        .tabs {
            flex-direction: row;
            gap: var(--espaco-xs);
        }

        .tab {
            border-radius: var(--borda-radius);
            border: 2px solid transparent;
            justify-content: center;
            font-size: 0.8rem;
            padding: var(--espaco-sm);
        }

        .tab.active {
            border-radius: var(--borda-radius);
            transform: none;
        }

        .form {
            padding: var(--espaco-md);
        }

        .form-grid {
            grid-template-columns: 1fr;
            gap: var(--espaco-sm);
        }

        .form_titulo {
            font-size: 1.1rem;
        }

        .tabela-wrapper {
            overflow-x: auto;
        }

        table {
            min-width: 600px;
        }
    }

    /* Animações */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Estados vazios */
    .empty-state {
        text-align: center;
        padding: var(--espaco-xl);
        color: var(--cinza-medio);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: var(--espaco-md);
        color: var(--cinza-borda);
    }

    /* Info boxes para configurações */
    .config-info {
        background: linear-gradient(to right, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
        border-left: 4px solid var(--azul);
        padding: var(--espaco-md);
        border-radius: var(--borda-radius);
        margin-bottom: var(--espaco-md);
    }

    .config-info.warning {
        background: linear-gradient(to right, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
        border-left: 4px solid var(--laranja);
    }

    .config-info.success {
        background: linear-gradient(to right, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
        border-left: 4px solid var(--verde-sucesso);
    }
</style>
{% endblock %}

<span class="text">{% block topbar_title %}Configurações{% endblock %}</span>

{% block content %}
<div class="content multipage">

    <!-- Abas -->
    <div class="tabs">
        <button class="tab active" data-target="especialidades"><i class='bx bx-book-content'></i> Especialidades</button>
        <button class="tab" data-target="servicos"><i class='bx bx-cog'></i> Serviços</button>
        <button class="tab" data-target="acessos"><i class='bx bx-user'></i> Acessos & Valores</button>
        <button class="tab" data-target="agenda"><i class='bx bx-calendar'></i> Agenda</button>
        <button class="tab" data-target="financeiro"><i class='bx bx-dollar-circle'></i> Financeiro</button>
        <button class="tab" data-target="notificacoes"><i class='bx bx-bell'></i> Notificações</button>
        <button class="tab" data-target="pacotes"><i class='bx bx-gift'></i> Pacotes & Benefícios</button>
        <button class="tab" data-target="sistema"><i class='bx bx-paint'></i> Sistema</button>
        <button class="tab" data-target="seguranca"><i class='bx bx-shield'></i> Segurança</button>
    </div>

    <!-- Aba Especialidades -->
    <div class="tab-content active" id="especialidades">
        <div class="form">
            <h2 class="form_titulo"><i class='bx bx-book-content'></i> Gerenciar Especialidades</h2>
            <form method="post" id="form-especialidade">
                {% csrf_token %}
                <input type="hidden" name="tipo" value="especialidade" />
                <div class="form-grid">
                    <div class="form-group">
                        <label for="especialidade-nome"><i class='bx bx-rename'></i> Nome da Especialidade</label>
                        <input class="input-field" id="especialidade-nome" name="nome" placeholder="Digite o nome da especialidade" type="text" required/>
                    </div>
                    <div class="form-group">
                        <label for="especialidade-cor"><i class='bx bx-palette'></i> Cor de Identificação</label>
                        <div class="color-input-wrapper">
                            <input class="input-field color-input" id="especialidade-cor" type="color" name="cor" value="#7F4396"/>
                            <div class="color-preview" id="color-preview" style="background-color: #7F4396"></div>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn-submit"><i class='bx bx-save'></i> Salvar Especialidade</button>
            </form>

            <div class="tabela-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Especialidade</th>
                            <th>Cor</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for especialidade in especialidades %}
                        <tr class="{% if not especialidade.ativo %}inativo{% endif %}">
                            <td>{{ especialidade.nome }}</td>
                            <td>
                                <div style="background-color: {{ especialidade.cor }}; width: 60px; height: 24px; border-radius: var(--borda-radius); border: 2px solid var(--cinza-borda);"></div>
                            </td>
                            <td>
                                <span class="status-badge {% if especialidade.ativo %}active{% else %}inactive{% endif %}">
                                    {{ especialidade.ativo|yesno:"Ativo,Inativo" }}
                                </span>
                            </td>
                            <td>
                                <div class="acoes-cell">
                                    <button class="btn-acao editar" title="Editar"><i class='bx bx-edit'></i></button>
                                    <button class="btn-acao excluir" title="Excluir"><i class='bx bx-trash'></i></button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="empty-state">
                                <i class='bx bx-inbox'></i>
                                <p>Nenhuma especialidade cadastrada</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Aba Serviços -->
    <div class="tab-content" id="servicos">
        <div class="form">
            <h2 class="form_titulo"><i class='bx bx-cog'></i> Gerenciar Serviços</h2>
            <form method="post" id="form-servico">
                {% csrf_token %}
                <input type="hidden" name="tipo" value="servico" />
                <div class="form-grid">
                    <div class="form-group">
                        <label for="servico-nome"><i class='bx bx-rename'></i> Nome do Serviço</label>
                        <input class="input-field" id="servico-nome" name="nome" placeholder="Digite o nome do serviço" type="text" required/>
                    </div>
                    <div class="form-group">
                        <label for="servico-sessoes"><i class='bx bx-calendar'></i> Quantidade de Sessões</label>
                        <input class="input-field" id="servico-sessoes" name="qtd_sessoes" placeholder="Número de sessões" type="number" min="1" required/>
                    </div>
                    <div class="form-group">
                        <label for="servico-valor"><i class='bx bx-dollar'></i> Valor (R$)</label>
                        <input class="input-field" id="servico-valor" name="valor" placeholder="0.00" type="number" step="0.01" min="0" required/>
                    </div>
                </div>
                <button type="submit" class="btn-submit"><i class='bx bx-save'></i> Salvar Serviço</button>
            </form>

            <div class="tabela-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Serviço</th>
                            <th>Sessões</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for servico in servicos %}
                        <tr class="{% if not servico.ativo %}inativo{% endif %}">
                            <td>{{ servico.nome }}</td>
                            <td>{{ servico.qtd_sessoes }}</td>
                            <td>R$ {{ servico.valor|floatformat:2 }}</td>
                            <td>
                                <span class="status-badge {% if servico.ativo %}active{% else %}inactive{% endif %}">
                                    {{ servico.ativo|yesno:"Ativo,Inativo" }}
                                </span>
                            </td>
                            <td>
                                <div class="acoes-cell">
                                    <button class="btn-acao editar" title="Editar"><i class='bx bx-edit'></i></button>
                                    <button class="btn-acao excluir" title="Excluir"><i class='bx bx-trash'></i></button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="empty-state">
                                <i class='bx bx-inbox'></i>
                                <p>Nenhum serviço cadastrado</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Aba Acessos -->
    <div class="tab-content" id="acessos">
        <div class="form">
            <h2 class="form_titulo"><i class='bx bx-user'></i> Gerenciar Acessos & Valores</h2>
            <form method="POST" id="form-usuario">
                {% csrf_token %}
                <input type="hidden" name="tipo" value="usuario_config"/>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="usuario-select"><i class='bx bx-user-circle'></i> Selecione o Profissional</label>
                        <select class="input-field" name="usuario_id" id="usuario-select" onchange="carregarDadosUsuario()" required>
                            <option value="" disabled selected>Selecione um profissional</option>
                            {% for u in usuarios %}
                            <option value="{{ u.id }}" data-tipo="{{ u.tipo }}" data-hora="{{ u.profissional.valor_hora|default_if_none:'' }}">
                                {{ u.get_full_name|default:u.username }} ({{ u.username }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tipo-select"><i class='bx bx-cog'></i> Tipo de Usuário</label>
                        <select class="input-field" name="tipo_usuario" id="tipo-select" disabled>
                            <option value="" disabled selected>Selecione o tipo</option>
                            {% for valor, label in user_tipo_choices %}
                            <option value="{{ valor }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="valor-hora-input"><i class='bx bx-dollar-circle'></i> Valor da Hora (R$)</label>
                        <input class="input-field" type="number" name="valor_hora" id="valor-hora-input" placeholder="0.00" step="0.01" min="0" disabled/>
                    </div>
                    <div class="form-group">
                        <label for="nova_senha"><i class='bx bx-lock-alt'></i> Nova Senha</label>
                        <input class="input-field" type="password" id="nova_senha" name="nova_senha" placeholder="Deixe em branco para manter a atual" disabled/>
                    </div>
                    <div class="form-group">
                        <label for="confirma_senha"><i class='bx bx-lock'></i> Confirmar Senha</label>
                        <input class="input-field" type="password" id="confirma_senha" name="confirma_senha" placeholder="Confirme a nova senha" disabled/>
                    </div>
                </div>
                <div id="senha-msg" class="form-message"></div>
                <button type="submit" class="btn-submit" id="btn-salvar-usuario" disabled><i class='bx bx-save'></i> Salvar Alterações</button>
            </form>
        </div>
    </div>

    <!-- Aba Agenda -->
    <div class="tab-content" id="agenda">
        <div class="form">
            <h2 class="form_titulo"><i class='bx bx-calendar'></i> Configurações de Agenda</h2>
            <div class="config-info">
                <i class='bx bx-info-circle'></i> Configure os horários padrão e dias de funcionamento da clínica.
            </div>
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="tipo" value="config_agenda" />
                <div class="form-grid">
                    <div class="form-group">
                        <label><i class='bx bx-time-five'></i> Horário de Abertura</label>
                        <input class="input-field" type="time" name="hora_abertura" value="08:00" required>
                    </div>
                    <div class="form-group">
                        <label><i class='bx bx-time'></i> Horário de Fechamento</label>
                        <input class="input-field" type="time" name="hora_fechamento" value="18:00" required>
                    </div>
                    <div class="form-group">
                        <label><i class='bx bx-refresh'></i> Intervalo Padrão (min)</label>
                        <input class="input-field" type="number" name="intervalo" min="5" value="30" required>
                    </div>
                    <div class="form-group full-width">
                        <label><i class='bx bx-calendar-week'></i> Dias de Funcionamento</label>
                        <select class="input-field" multiple name="dias_semana" required>
                            <option value="1" selected>Segunda-feira</option>
                            <option value="2" selected>Terça-feira</option>
                            <option value="3" selected>Quarta-feira</option>
                            <option value="4" selected>Quinta-feira</option>
                            <option value="5" selected>Sexta-feira</option>
                            <option value="6">Sábado</option>
                            <option value="0">Domingo</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn-submit"><i class='bx bx-save'></i> Salvar Configurações</button>
            </form>
        </div>
    </div>

    <!-- Aba Financeiro -->
    <div class="tab-content" id="financeiro">
        <div class="form">
            <h2 class="form_titulo"><i class='bx bx-dollar-circle'></i> Configurações Financeiras</h2>
            <div class="config-info">
                <i class='bx bx-info-circle'></i> Configure as opções de pagamento e taxas administrativas.
            </div>
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="tipo" value="config_financeiro" />
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label><i class='bx bx-credit-card'></i> Formas de Pagamento Aceitas</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="formas_pagamento" value="dinheiro" checked>
                                <span>Dinheiro</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="formas_pagamento" value="pix" checked>
                                <span>PIX</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="formas_pagamento" value="debito" checked>
                                <span>Cartão de Débito</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="formas_pagamento" value="credito">
                                <span>Cartão de Crédito</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="formas_pagamento" value="convenio">
                                <span>Convênio</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class='bx bx-analyse'></i> Taxa Administrativa (%)</label>
                        <input class="input-field" type="number" step="0.1" name="taxa_admin" placeholder="0.0" min="0" max="50">
                    </div>
                    <div class="form-group">
                        <label><i class='bx bx-pie-chart-alt-2'></i> Parcelamento Máximo</label>
                        <input class="input-field" type="number" name="parcelas" min="1" max="12" value="1">
                    </div>
                    <div class="form-group">
                        <label><i class='bx bx-error'></i> Multa por Atraso (%)</label>
                        <input class="input-field" type="number" step="0.1" name="multa_atraso" placeholder="0.0" min="0" max="20">
                    </div>
                </div>
                <button type="submit" class="btn-submit"><i class='bx bx-save'></i> Salvar Configurações</button>
            </form>
        </div>
    </div>

    <!-- Aba Notificações -->
    <div class="tab-content" id="notificacoes">
        <div class="form">
            <h2 class="form_titulo"><i class='bx bx-bell'></i> Configurações de Notificações</h2>
            <div class="config-info">
                <i class='bx bx-info-circle'></i> Configure os lembretes automáticos e modelos de mensagem.
            </div>
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="tipo" value="config_notificacoes" />
                <div class="form-grid">
                    <div class="form-group">
                        <label><i class='bx bx-time-five'></i> Lembrete Automático (horas antes)</label>
                        <input class="input-field" type="number" name="lembrete_horas" value="24" min="1" max="168">
                    </div>
                    <div class="form-group full-width">
                        <label><i class='bx bx-message-rounded-detail'></i> Modelo de Mensagem (WhatsApp)</label>
                        <textarea class="input-field" rows="4" name="msg_whatsapp" placeholder="Ex: Olá {{paciente}}, lembramos sua sessão dia {{data}} às {{hora}}">Olá {{paciente}}, lembramos sua sessão dia {{data}} às {{hora}}. Att, Equipe Ponto de Equilíbrio</textarea>
                    </div>
                    <div class="form-group full-width">
                        <label><i class='bx bx-envelope'></i> Assinatura E-mails</label>
                        <textarea class="input-field" rows="3" name="assinatura_email" placeholder="Equipe Clínica Ponto de Equilíbrio">Atenciosamente,\nEquipe Clínica Ponto de Equilíbrio\nTel: (11) 99999-9999</textarea>
                    </div>
                </div>
                <button type="submit" class="btn-submit"><i class='bx bx-save'></i> Salvar Configurações</button>
            </form>
        </div>
    </div>

    <!-- Aba Pacotes & Benefícios -->
    <div class="tab-content" id="pacotes">
        <div class="form">
            <h2 class="form_titulo"><i class='bx bx-gift'></i> Pacotes & Benefícios</h2>
            <div class="config-info">
                <i class='bx bx-info-circle'></i> Configure os pacotes de sessões e benefícios para clientes.
            </div>
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="tipo" value="config_pacotes" />
                <div class="form-grid">
                    <div class="form-group">
                        <label><i class='bx bx-layer'></i> Nº Sessões Padrão do Pacote</label>
                        <input class="input-field" type="number" name="qtd_sessoes" min="1" value="10">
                    </div>
                    <div class="form-group">
                        <label><i class='bx bx-timer'></i> Validade do Pacote (dias)</label>
                        <input class="input-field" type="number" name="validade_pacote" min="1" value="90">
                    </div>
                    <div class="form-group">
                        <label><i class='bx bx-purchase-tag'></i> Desconto do Pacote (%)</label>
                        <input class="input-field" type="number" step="0.1" name="desconto_pacote" value="10.0" min="0" max="50">
                    </div>
                    <div class="form-group full-width">
                        <label><i class='bx bx-star'></i> Regras de Benefício VIP</label>
                        <textarea class="input-field" rows="3" name="regras_beneficio" placeholder="Ex: Cliente VIP após 10 sessões no mês">Cliente VIP: + de 10 sessões/mês\nDesconto especial: 15%\nPrioridade em agendamentos</textarea>
                    </div>
                </div>
                <button type="submit" class="btn-submit"><i class='bx bx-save'></i> Salvar Configurações</button>
            </form>
        </div>
    </div>

    <!-- Aba Sistema -->
    <div class="tab-content" id="sistema">
        <div class="form">
            <h2 class="form_titulo"><i class='bx bx-paint'></i> Aparência do Sistema</h2>
            <div class="config-info">
                <i class='bx bx-info-circle'></i> Personalize a aparência e identidade visual do sistema.
            </div>
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="tipo" value="config_sistema" />
                <div class="form-grid">
                    <div class="form-group">
                        <label><i class='bx bx-image'></i> Logo da Clínica</label>
                        <input class="input-field" type="file" name="logo" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label><i class='bx bx-brightness'></i> Tema do Sistema</label>
                        <select class="input-field" name="tema">
                            <option value="claro">Claro</option>
                            <option value="escuro" selected>Escuro</option>
                            <option value="auto">Automático</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label><i class='bx bx-file'></i> Cabeçalho de Relatórios</label>
                        <textarea class="input-field" rows="3" name="cabecalho_relatorio">Clínica Ponto de Equilíbrio\nCNPJ: 12.345.678/0001-90\nTel: (11) 99999-9999 | www.pontodeequilibrio.com</textarea>
                    </div>
                </div>
                <button type="submit" class="btn-submit"><i class='bx bx-save'></i> Salvar Configurações</button>
            </form>
        </div>
    </div>

    <!-- Aba Segurança -->
    <div class="tab-content" id="seguranca">
        <div class="form">
            <h2 class="form_titulo"><i class='bx bx-shield'></i> Segurança</h2>
            <div class="config-info warning">
                <i class='bx bx-error-circle'></i> Configure as políticas de segurança e acesso ao sistema.
            </div>
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="tipo" value="config_seguranca" />
                <div class="form-grid">
                    <div class="form-group">
                        <label><i class='bx bx-lock'></i> Expiração de Sessão (minutos)</label>
                        <input class="input-field" type="number" name="expiracao_sessao" value="30" min="5" max="480">
                    </div>
                    <div class="form-group">
                        <label><i class='bx bx-key'></i> Comprimento mínimo da senha</label>
                        <input class="input-field" type="number" name="min_senha" value="8" min="6" max="20">
                    </div>
                    <div class="form-group">
                        <label><i class='bx bx-check-shield'></i> Exigir senha forte</label>
                        <select class="input-field" name="senha_forte">
                            <option value="1" selected>Sim - Letras + Números</option>
                            <option value="0">Não</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label><i class='bx bx-history'></i> Logs de Auditoria</label>
                        <textarea class="input-field" rows="4" disabled>Último acesso: {{ user.last_login|default:"Nunca" }}\nIP: 192.168.1.1\nNavegador: Chrome 120.0\nAtivar exibição detalhada de logs no painel administrativo</textarea>
                    </div>
                </div>
                <button type="submit" class="btn-submit"><i class='bx bx-save'></i> Salvar Configurações</button>
            </form>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    // Sistema de tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.target).classList.add('active');
        });
    });

    // Preview de cor para especialidades
    const colorInput = document.getElementById('especialidade-cor');
    const colorPreview = document.getElementById('color-preview');
    
    if (colorInput && colorPreview) {
        colorInput.addEventListener('input', function() {
            colorPreview.style.backgroundColor = this.value;
        });
    }

    // Validação de formulário de usuário
    function carregarDadosUsuario() {
        const select = document.getElementById("usuario-select");
        const selectedOption = select.options[select.selectedIndex];
        const tipoSelect = document.getElementById("tipo-select");
        const valorHoraInput = document.getElementById("valor-hora-input");
        const novaSenhaInput = document.getElementById("nova_senha");
        const confirmaSenhaInput = document.getElementById("confirma_senha");
        const btnSalvar = document.getElementById("btn-salvar-usuario");
        const senhaMsg = document.getElementById("senha-msg");

        if (select.value) {
            // Habilitar campos
            [tipoSelect, valorHoraInput, novaSenhaInput, confirmaSenhaInput].forEach(field => {
                field.disabled = false;
                field.classList.remove('error');
            });
            
            // Preencher dados
            tipoSelect.value = selectedOption.getAttribute("data-tipo");
            valorHoraInput.value = selectedOption.getAttribute("data-hora") || "";
            
            // Limpar mensagens e habilitar botão
            senhaMsg.textContent = "";
            senhaMsg.className = "form-message";
            btnSalvar.disabled = false;
            
            // Adicionar validação de senha em tempo real
            confirmaSenhaInput.addEventListener('input', validarSenha);
        } else {
            // Desabilitar campos se nenhum usuário selecionado
            [tipoSelect, valorHoraInput, novaSenhaInput, confirmaSenhaInput, btnSalvar].forEach(field => {
                field.disabled = true;
            });
        }
    }

    function validarSenha() {
        const senha = document.getElementById("nova_senha").value;
        const confirmaSenha = document.getElementById("confirma_senha").value;
        const senhaMsg = document.getElementById("senha-msg");
        const btnSalvar = document.getElementById("btn-salvar-usuario");

        if (!senha && !confirmaSenha) {
            senhaMsg.textContent = "";
            senhaMsg.className = "form-message";
            btnSalvar.disabled = false;
            return;
        }

        if (senha !== confirmaSenha) {
            senhaMsg.textContent = "As senhas não coincidem!";
            senhaMsg.className = "form-message error";
            btnSalvar.disabled = true;
        } else {
            senhaMsg.textContent = "Senhas coincidem!";
            senhaMsg.className = "form-message success";
            btnSalvar.disabled = false;
        }
    }

    // Validação básica de formulários
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(e) {
            const requiredFields = this.querySelectorAll('[required]');
            let valid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    valid = false;
                    field.style.borderColor = '#EF4444';
                } else {
                    field.style.borderColor = '';
                }
            });

            if (!valid) {
                e.preventDefault();
                const msg = document.createElement('div');
                msg.className = 'form-message error';
                msg.textContent = 'Por favor, preencha todos os campos obrigatórios.';
                this.insertBefore(msg, this.firstChild);
                
                setTimeout(() => msg.remove(), 5000);
            }
        });
    });

    // Efeitos hover nas linhas da tabela
    document.querySelectorAll('tbody tr').forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.transform = 'translateX(4px)';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.transform = 'translateX(0)';
        });
    });

    // Auto-scroll para tabs ativas em mobile
    function scrollToActiveTab() {
        const activeTab = document.querySelector('.tab.active');
        if (activeTab) {
            activeTab.scrollIntoView({
                behavior: 'smooth',
                block: 'nearest',
                inline: 'center'
            });
        }
    }

    // Inicializar scroll quando a página carregar
    document.addEventListener('DOMContentLoaded', scrollToActiveTab);
</script>
{% endblock %}