{% load static %}
<!DOCTYPE html>
<html lang="pt-br" class="light" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <script>
      (function () {
        const isDark = localStorage.getItem("theme") === "dark";
        document.documentElement.classList.toggle("dark", isDark);
      })();
    </script>

    <title>
      {% block title %}Dashboard - Ponto de Equilíbrio{% endblock %}
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      href="{% static 'core/img/icons/logoRoxoFull.png' %}"
      type="image/png"
    />

    <link rel="stylesheet" href="{% static 'core/css/base.css' %}" />
    <link rel="stylesheet" href="{% static 'core/css/tema.css' %}" />
    <link rel="stylesheet" href="{% static 'core/css/alerts.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link href="https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet"/>
  </head>

  <body>
    <!-- =========================
       SIDEBAR ORIGINAL (DESKTOP)
       ========================= -->
    <div class="sidebar close">
      <div class="logo-details">
        <img
          class="logo_img"
          src="{% static 'core/img/icons/logoRoxoFull.png' %}"
          alt="logo Ponto de Equilíbrio"
        />
        <span class="logo_name">Ponto de <strong>Equilíbrio</strong></span>
      </div>

      <ul class="nav-links">
        <li>
          <a href="{% url 'dashboard' %}">
            <i class="fas fa-tachometer-alt"></i>
            <span class="link_name">Dashboard</span>
          </a>
          <ul class="sub-menu blank">
            <li>
              <a class="link_name" href="{% url 'dashboard' %}">Dashboard</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="{% url 'dashboard_adm' %}">
            <i class="fas fa-building"></i>
            <span class="link_name">Administrativo</span>
          </a>
          <ul class="sub-menu">
            <li><a class="link_name" href="{% url 'dashboard_adm' %}">Administrativo</a></li>
            <li><a href="{% url 'dashboard_adm' %}">Dashboard</a></li>
            <li><a href="{% url 'notas_fiscais' %}">Notas Fiscais</a></li>
            <li><a href="{% url 'documentos_clinica' %}">Documentos</a></li>
          </ul>
        </li>

        <li>
          <div class="iocn-link">
            <a href="{% url 'pacientes' %}">
              <i class="fa-solid fa-users"></i>
              <span class="link_name">Pacientes</span>
            </a>
            <i class="bx bxs-chevron-down arrow"></i>
          </div>
          <ul class="sub-menu">
            <li><a class="link_name" href="#">Pacientes</a></li>
            <li><a href="{% url 'pacientes' %}">Ver Pacientes</a></li>
            <li><a href="{% url 'cadastrar_paciente' %}">Novo Paciente</a></li>
            <li>
              <a href="{% url 'gerar_link_publico_precadastro' %}"
                >Pré-Cadastro</a
              >
            </li>
            <li><a href="{% url 'status_pacientes' %}">Status mensal</a></li>
          </ul>
        </li>

        <li>
          <div class="iocn-link">
            <a href="#">
              <i class="fas fa-user-md"></i>
              <span class="link_name">Profissionais</span>
            </a>
            <i class="bx bxs-chevron-down arrow"></i>
          </div>
          <ul class="sub-menu">
            <li><a class="link_name" href="#">Profissionais</a></li>
            <li><a href="{% url 'profissionais' %}">Ver Profissionais</a></li>
            <li>
              <a href="{% url 'cadastrar_profissional' %}">Novo Profissional</a>
            </li>
          </ul>
        </li>

        <li>
          <div class="iocn-link">
            <a href="#">
              <i class="fas fa-calendar-alt"></i>
              <span class="link_name">Agenda</span>
            </a>
            <i class="bx bxs-chevron-down arrow"></i>
          </div>
          <ul class="sub-menu">
            <li><a class="link_name" href="#">Agenda</a></li>
            <li><a href="{% url 'agenda' %}">Ver agenda</a></li>
            <li><a href="{% url 'agenda_board' %}">Agenda Matriz</a></li>
            <li><a href="{% url 'lembrete_agenda' %}">Lembretes DS</a></li>
          </ul>
        </li>

        {% if request.user.tipo != 'profissional' %}
        <li>
          <div class="iocn-link">
            <a href="#">
              <i class="fas fa-dollar-sign"></i>
              <span class="link_name">Financeiro</span>
            </a>
            <i class="bx bxs-chevron-down arrow"></i>
          </div>
          <ul class="sub-menu">
            <li><a class="link_name">Financeiro</a></li>
            <li><a href="{% url 'financeiro_dashboard' %}">Dashboard</a></li>
            <li><a href="{% url 'fluxo_caixa' %}">Fluxo de Caixa</a></li>
            <li><a href="{% url 'entradas' %}">Contas a Receber</a></li>
            <li><a href="{% url 'saidas' %}">Contas a Pagar</a></li>
            <li><a href="{% url 'faturamento' %}">Faturamento</a></li>
            <li>
              <a href="{% url 'folha_pagamento' %}">Folha de pagamento</a>
            </li>
            <li><a href="{% url 'financeiro_relatorios' %}">Relatórios</a></li>
          </ul>
        </li>
        {% endif %}

        <li>
          <a href="{% url 'lembretes' %}">
            <i class="fa-solid fa-bell"></i>
            <span class="link_name">Lembretes</span>
          </a>
          <ul class="sub-menu blank">
            <li><a class="link_name" href="{% url 'lembretes' %}">Lembretes</a></li>
          </ul>
        </li>

        {% if request.user.tipo != 'profissional' %}
        <li>
          <a href="#">
            <i class="fas fa-clipboard-list"></i>
            <span class="link_name">Relatórios</span>
          </a>
          <ul class="sub-menu blank">
            <li><a class="link_name" href="#">Relatórios</a></li>
          </ul>
        </li>

        <li>
          <a href="{% url 'auditoria_logs' %}">
            <i class="fas fa-clipboard-list"></i>
            <span class="link_name">Logs</span>
          </a>
          <ul class="sub-menu blank">
            <li>
              <a class="link_name" href="{% url 'auditoria_logs' %}">Logs</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="{% url 'gestao-equipamentos' %}">
            <i class="fas fa-tools"></i>
            <span class="link_name">Gestão de Equipamentos</span>
          </a>
        </li>

        <li>
          <a href="{% url 'config' %}">
            <i class="fas fa-cog"></i>
            <span class="link_name">Configurações</span>
          </a>
          <ul class="sub-menu">
            <li>
              <a class="link_name" href="{% url 'config' %}">Configurações</a>
            </li>
            <li><a href="{% url 'config' %}">Configurações Gerais</a></li>
            <li>
              <a href="{% url 'formularios' %}">Gerenciador de Formulários</a>
            </li>
          </ul>
        </li>
        {% endif %}

        <li>
          <div class="profile-details">
            <div class="profile-content">
              {% if user.profissional.foto %}
              <img
                src="{{ user.profissional.foto.url }}"
                alt="Foto de {{ user.get_full_name }}"
              />
              {% else %}
              <img
                src="{% static 'core/img/defaultPerfil.png' %}"
                alt="Sem foto"
              />
              {% endif %}
            </div>
            <div class="name-job">
              <div class="profile_name">{{ user.get_full_name }}</div>
              <div class="job">{{user.get_tipo_display}}</div>
            </div>
          </div>
        </li>
      </ul>
    </div>

    <!-- =========================
       HOME / TOPBAR
       ========================= -->
    <section class="home-section">
      <div class="home-content">
        {% block topbar %}
        <div class="topbar">
          <div class="topbar-div">
            <i class="bx bx-menu"></i>
            <span class="text"
              >{% block topbar_title %}Dashboard{% endblock %}</span
            >
            {% block topbar_search %}{% endblock %}
          </div>

          <div class="topbar-div">
            <div class="notification-area">
              <div class="message-icon" id="messageIcon">
                <i class="fa-solid fa-message"></i>
              </div>
            </div>

            <div class="notification-area">
              <div class="bell-icon" id="bellIcon">
                <i class="fas fa-bell"></i>
                <div class="notification-count" id="notificationCount">0</div>
              </div>
            </div>

            <div class="dropdown">
              <div class="profile-button">
                {{ user.get_full_name }} <i class="bx bx-chevron-down"></i>
              </div>
              <div class="dropdown-content">
                <div class="content-btn">
                

                <button onclick="toggleDarkMode()"><i class="fas fa-moon"></i>Alternar Tema</button>
                </div>
                <div class="content-btn">
                

                <a href="{% url 'logout' %}"><i class="fas fa-sun"></i>Sair</a>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="notification-modal" id="notificationModal">
          <div class="modal-content">
            <div class="modal-header">
              <h3>Notificações da Clínica</h3>
              <div class="close-modal" id="notificationCloseModal">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <div class="modal-body">
              <!-- Notificações serão carregadas dinamicamente -->
              <div id="notificationsList"></div>

              <!-- Template para notificação (oculto) -->
              <div class="notification-item template" style="display: none">
                <div class="notification-icon">
                  <i class="fas fa-calendar-check"></i>
                </div>
                <div class="notification-text">
                  <h4>Título da Notificação</h4>
                  <p>Descrição da notificação</p>
                  <div class="notification-time">Horário</div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="mark-all-read" id="notificationMarkAllRead">
                Marcar todas como lidas
              </button>
              <button class="clear-all" id="notificationClearAll">
                Limpar todas
              </button>
            </div>
          </div>
        </div>

        <div class="message-modal" id="messageModal">
          <div class="modal-content">
            <div class="modal-header">
              <h3>Mensagens da Clínica</h3>
              <div class="close-modal" id="messageCloseModal">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <div class="modal-body">
              <input class="input-s" type="search" style="width: 100%" />

              <div id="messagesList"></div>

              <!-- Template para mensagem (oculto) -->
              <div class="message-item template" style="display: none">
                <div class="message-text">
                  <h4></h4>
                  <p></p>
                  <div class="message-time"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endblock %} {% block content %} {% include
        "core/partials/alertas.html" %} {% endblock %}
      </div>
    </section>
 
    <div class="bottom-nav-bar">
      <a
        href="{% url 'dashboard' %}"
        class="nav-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
      >
        <i class="fas fa-tachometer-alt"></i>
        <span class="nav-item-text">Dashboard</span>
      </a>
      <a
        href="{% url 'agenda' %}"
        class="nav-item {% if 'pacientes' in request.path or 'paciente' in request.path and request.resolver_match.url_name != 'dashboard' %}active{% endif %}"
      >
        <i class="fas fa-calendar-alt"></i>
        <span class="nav-item-text">Agenda</span>
      </a>
      <a
        href="{% url 'pacientes' %}"
        class="nav-item {% if 'pacientes' in request.path or 'paciente' in request.path and request.resolver_match.url_name != 'dashboard' %}active{% endif %}"
      >
        <i class="fas fa-solid fa-users"></i>
        <span class="nav-item-text">Pacientes</span>
      </a>

      <a href="#"
        class="nav-item menu-button"
        onclick="toggleMobileMenu(event)"
      >
        <i class="bx bx-menu"></i>
        <span class="nav-item-text">Menu</span>
      </a>
    </div>
    
    <div id="mobileMenuOverlay" class="mobile-menu-overlay" onclick="overlayCloseIfClickedOutside(event)">
      <div class="mobile-menu">
        <div class="mobile-menu-header">
          <strong>Menu</strong>
          <button onclick="toggleMobileMenu(event)" aria-label="Fechar">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="mobile-menu-body">
          <div class="mobile-menu-accordion">
            <button type="button" class="mobile-acc-btn" onclick="toggleSubmenu(this)">
              <span class="left">
                <i class="fas fa-calendar-alt"></i>
                <span>Agenda</span>
              </span>
              <i class="bx bx-chevron-down chevron"></i>
            </button>

            <div class="mobile-acc-panel">
              <a href="{% url 'agenda' %}">Agenda</a>
              <a href="{% url 'agenda_board' %}">Agenda Matriz</a>
              <a href="{% url 'lembrete_agenda' %}">Lembrete DS</a>
            </div>
          </div>
          <div class="mobile-menu-accordion">
            <button type="button" class="mobile-acc-btn" onclick="toggleSubmenu(this)">
              <span class="left">
                <i class="fas fa-user-md"></i>
                <span>Profissionais</span>
              </span>
              <i class="bx bx-chevron-down chevron"></i>
            </button>

            <div class="mobile-acc-panel">
              <a href="{% url 'profissionais' %}">Ver Profissionais</a>
              <a href="{% url 'cadastrar_profissional' %}">Novo Profissional</a>
            </div>
          </div>
          <div class="mobile-menu-accordion">
            <button
              type="button"
              class="mobile-acc-btn"
              onclick="toggleSubmenu(this)"
            >
              <span class="left">
                <i class="fas fa-building "></i>
                <span>Administrativo</span>
              </span>
              <i class="bx bx-chevron-down chevron"></i>
            </button>

            <div class="mobile-acc-panel">
              <a href="{% url 'dashboard_adm' %}">Dashboard</a>
              <a href="{% url 'notas_fiscais' %}">Notas Fiscais</a>
              <a href="{% url 'documentos_clinica' %}">Documentos</a>
            </div>
          </div>

          <a href="#" class="mobile-menu-item-link">
            <i class="fa-solid fa-bell"></i>
            <span>Lembretes</span>
          </a>

          {% if request.user.tipo != 'profissional' %}
          <a href="#" class="mobile-menu-item-link">
            <i class="fas fa-clipboard-list"></i>
            <span>Relatórios</span>
          </a>
          {% endif %} {% if request.user.tipo != 'profissional' %}
          <a href="{% url 'auditoria_logs' %}" class="mobile-menu-item-link">
            <i class="fas fa-clipboard-list"></i>
            <span>Logs</span>
          </a>
          {% endif %}

          <!-- Accordion: Financeiro -->
          {% if request.user.tipo != 'profissional' %}
          <div class="mobile-menu-accordion">
            <button
              type="button"
              class="mobile-acc-btn"
              onclick="toggleSubmenu(this)"
            >
              <span class="left">
                <i class="fas fa-dollar-sign"></i>
                <span>Financeiro</span>
              </span>
              <i class="bx bx-chevron-down chevron"></i>
            </button>

            <div class="mobile-acc-panel">
              <a href="{% url 'financeiro_dashboard' %}">Dashboard</a>
              <a href="{% url 'fluxo_caixa' %}">Fluxo de Caixa</a>
              <a href="{% url 'entradas' %}">Contas a Receber</a>
              <a href="{% url 'saidas' %}">Contas a Pagar</a>
              <a href="{% url 'faturamento' %}">Faturamento</a>
              <a href="{% url 'folha_pagamento' %}">Folha de pagamento</a>
              <a href="{% url 'financeiro_relatorios' %}">Relatórios</a>
            </div>
          </div>
          {% endif %}

          <!-- Accordion: Config -->
          {% if request.user.tipo != 'profissional' %}
          <div class="mobile-menu-accordion">
            <button type="button" class="mobile-acc-btn" onclick="toggleSubmenu(this)">
              <span class="left">
                <i class="fas fa-cog"></i>
                <span>Configurações</span>
              </span>
              <i class="bx bx-chevron-down chevron"></i>
            </button>

            <div class="mobile-acc-panel">
              <a href="{% url 'config' %}">Configurações Gerais</a>
              <a href="{% url 'formularios' %}">Gerenciador de Formulários</a>
            </div>
          </div>
          {% endif %}

          <div class="mobile-separator"></div>

          <!-- Perfil + Tema + Sair -->
          <a href="{% url 'config' %}" class="mobile-menu-item-link">
            <i class="bx bx-user-circle"></i>
            <span>Meu Perfil</span>
          </a>

          <button
            type="button"
            class="mobile-menu-item-btn"
            onclick="toggleDarkMode()"
          >
            <i class="fas fa-moon"></i>
            <span>Alternar Tema</span>
          </button>

          <a href="{% url 'logout' %}" class="mobile-menu-item-link danger">
            <i class="bx bx-log-out"></i>
            <span>Sair</span>
          </a>

          <div class="mobile-profile">
            <div class="avatar">
              {% if user.profissional.foto %}
              <img
                src="{{ user.profissional.foto.url }}"
                alt="Foto de {{ user.get_full_name }}"
              />
              {% else %}
              <img
                src="{% static 'core/img/defaultPerfil.png' %}"
                alt="Sem foto"
              />
              {% endif %}
            </div>
            <div class="info">
              <div class="name">{{ user.get_full_name }}</div>
              <div class="role">{{ user.get_tipo_display }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% block scripts %}{% endblock %}
    <script type="module" src="{% static 'core/js/alertas/main.js' %}"></script>
    <script src="{% static 'core/js/base/scriptBase.js' %}"></script>
    <script>
      function toggleMobileMenu(event) {
        if (event) event.preventDefault();
        const overlay = document.getElementById("mobileMenuOverlay");
        if (!overlay) return;
        overlay.classList.toggle("open");
        document.body.classList.toggle("menu-mobile-open");
      }

      function overlayCloseIfClickedOutside(event) {
        const overlay = document.getElementById("mobileMenuOverlay");
        const menu = overlay.querySelector(".mobile-menu");
        if (!menu.contains(event.target)) {
          overlay.classList.remove("open");
          document.body.classList.remove("menu-mobile-open");
        }
      }

      function toggleSubmenu(btn) {
        const wrap = btn.closest(".mobile-menu-accordion");
        wrap.classList.toggle("open");
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const bell = document.getElementById("bellIcon");
        const modal = document.getElementById("notificationModal");
        const closeBtn = document.getElementById("notificationCloseModal");
        const list = document.getElementById("notificationsList");
        const count = document.getElementById("notificationCount");
        const template = document.querySelector(".notification-item.template");

        function carregarNotificacoes() {
          fetch("/api/notificacoes/")
            .then((res) => res.json())
            .then((data) => {
              list.innerHTML = "";
              count.textContent = data.total_nao_lidas;

              data.notificacoes.forEach((n) => {
                const item = template.cloneNode(true);
                item.style.display = "flex";
                item.classList.remove("template");

                item.querySelector("h4").textContent = n.titulo;
                item.querySelector("p").textContent = n.mensagem;
                item.querySelector(".notification-time").textContent = n.tempo;

                if (!n.lida) {
                  item.classList.add("unread");
                }

                item.addEventListener("click", () => {
                  marcarComoLida(n.id);
                  if (n.url) window.location.href = n.url;
                });

                list.appendChild(item);
              });
            });
        }

        function marcarComoLida(id) {
          fetch(`/api/notificacoes/${id}/lida/`, {
            method: "POST",
            headers: {
              "X-CSRFToken": getCookie("csrftoken"),
            },
          }).then(() => carregarNotificacoes());
        }

        bell.addEventListener("click", () => {
          modal.classList.add("active");
          carregarNotificacoes();
        });

        closeBtn.addEventListener("click", () => {
          modal.classList.remove("active");
        });

        carregarNotificacoes(); // inicial
        setInterval(() => {
          if (!modal.classList.contains("active")) {
            carregarNotificacoes();
          }
        }, 30000);
      });

      // CSRF helper
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
    </script>
    {% block extra_css %}{% endblock %}
  </body>
</html>
