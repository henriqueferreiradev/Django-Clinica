{% extends 'core/base.html' %}
{% load static %}
 


{% block title %}Agenda - Ponto de Equilíbrio{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/agenda/agenda.css' %}">
<link rel="stylesheet" href="{% static 'core/css/alerts.css' %}">
<link rel="stylesheet" href="{% static 'core/css/tema.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/_agendamento_modal.css' %}">
 

{% endblock %}

{% block topbar_title %}Agenda{% endblock %}

{% block content %}
<div class="content">

    <div class="" class="sidebar" id="sidebar">
        <div class="header-sidebar">
            <h2>Agendamento</h2>
            <button id="closeBtn">&times;</button>
        </div>
        <div class="agendamento_div">
            <form id="agendamentoForm" method="post" action="{% url 'criar_agendamento' %}">
                {% csrf_token %}

                <div id="aviso-pacote"
                    style="display: none; margin: 1em 0; padding: 10px; background-color: #e6ffe6; border: 1px solid #4CAF50; border-radius: 5px;">
                    <strong style="color: #2e7d32;">Pacote ativo detectado!</strong><br>
                    <span id="mensagem-pacote" style="color: #2e7d32; font-size: 13px;"></span>
                    <button type="button" id="usar-pacote-btn"
                        style="margin-left: 10px; background-color: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                        Usar este pacote
                    </button>
                </div>
                <div  id="pacote_atual"></div>
                <div  id="info_reposicao"></div>
                <div id="aviso-desmarcacoes"
                style="display: none; margin: 1em 0; padding: 10px; background-color:rgb(255, 230, 230); border: 1px solid rgb(175, 76, 76); border-radius: 5px;">
                <strong style="color:rgb(125, 46, 46);">Saldos de sessões desmarcadas detectados!</strong><br>
                <span id="mensagem-desmarcacoes" style="color:rgb(125, 46, 46); font-size: 13px;"></span>
                <button type="button" id="usar-reposicao-btn"
                    style="margin-left: 10px; background-color:rgb(175, 76, 76); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                    Remarcar sessão
                </button>
                
            </div>
 
 
                <div class="formField input-wrapper">
                    <input class='capitalize-input' type="text" id="busca" placeholder="Buscar paciente por nome..."
                        autocomplete="off">
                    <input type="hidden" id="paciente_id" name="paciente_id">
                    <div id="sugestoes"></div>
                </div>
                <div class="radio-group">
                    <label><input type="radio" name="tipo_agendamento" value="novo" checked> Nova Sessão / Novo
                        Pacote</label>
                    <div hidden>
                        <label><input class="input-s" type="radio" name="tipo_agendamento" value="existente">
                            Sessão de Pacote Já Assinado</label>
                        <input type="text" id="pacote_codigo" name="pacote_codigo"
                            placeholder="Digite o código do pacote">
                    </div>
                    <div>
                        <label><input type="radio" name="tipo_agendamento" value="reposicao"> Reposição de
                            Sessão</label>
                    </div>
                </div>



                <div class="formField">
                    <label id='tipo_sessao'>Tipo de sessão</label>
                    <input type="hidden" id="servico_id_hidden" name="servico_id">
                    <select name="servico_id" id="pacotesInput" class="input-s" required>
                        <option value="" disabled selected>Selecione um serviço</option>
                        {% for servico in servicos %}
                        <option  value="{{ servico.id }}" data-valor="{{ servico.valor }}" class="servico-banco">
                            {{ servico.nome }} - R$ {{ servico.valor }}
                        </option>

                        {% endfor %}
                        <option value="d" class="servico-reposicao" data-valor="0.00">Reposição - D </option>
                        <option value="dcr" class="servico-reposicao" data-valor="0.00">Reposição - DCR </option>
                        <option value="fcr" class="servico-reposicao" data-valor="0.00">Reposição - FCR </option>
                    </select>
                </div>

                <div class="formRow">
                    <div class="formField">
                        <label>Especialidade</label>
                        <select name="especialidade_id" id="especialidadeInput" class="input-s" required>
                            <option value="" disabled selected>Selecione uma especialidade</option>
                            {% for esp in especialidades %}
                            <option value="{{ esp.id }}">
                                {{ esp.nome }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="formField">
                        <label>Profissional 1</label>
                        <select name="profissional1_id" id="profissional1Input" class="input-s" required>
                            <option value="" disabled selected>Selecione um profissional</option>
                            {% for profissional in profissionais %}
                            <option value="{{ profissional.id }}">
                                {{ profissional.nome }} {{ profissional.sobrenome }} - {{ profissional.especialidade }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="formRow">
                    <div class="formField">
                        <label>Data</label>
                        <input type="date" name="data" id="dataInput">
                    </div>
                    <div class="formField">
                        <label>Início</label>
                        <input type="time" name="hora_inicio" id="horaInicioInput" min="06:00" max="00:00" required>
                    </div>
                    <div class="formField">
                        <label>Fim</label>
                        <input type="time" name="hora_fim" id="horaFimInput" min="06:00" max="00:00" required>
                    </div>
                </div>
                <div class="formRow">
                    <div class="formField">
                        <label><input type="checkbox" name="recorrente" id="recorrente"> Agendamento Recorrente</label>
                    </div>
                    <div class="formField">
                        <label>Recorrência</label>
                        <select name="recorrencia_dia" id="recorrencia_dia">
                            <option value="" disabled selected>Selecione...</option>
                            <option value="0">Todas segundas</option>
                            <option value="1">Todas terças</option>
                            <option value="2">Todas quartas</option>
                            <option value="3">Todas quintas</option>
                            <option value="4">Todas sextas</option>
                            <option value="5">Todos sábados</option>
                        </select>
                    </div>
                </div>
                <div id='formValor' class="formRow">
                    <div class="formField">
                        <label>Valor Pacote</label>
                        <input id="valor_pacote" name="valor_pacote" type="number" step="0.01"
                            oninput="calcularDesconto()" readonly>
                    </div>

                    <div class="formField">
                        <label id='desconto_label'>Desconto (%)</label>
                        <div class="input-wrapper">
                            <input id="desconto" name="desconto" type="number" step="0.01" oninput="calcularDesconto()">
                            <input type="hidden" id="modo_desconto" name="modo_desconto" value="%">
                            <button type="button" id='desconto_button' class="modo_desconto"
                                onclick="alternarModoDesconto()">R$</button>
                        </div>
                    </div>

                    <div class="formField">
                        <label for="valor_final">Valor final</label>
                        <input id="valor_final" name="valor_final" type="number" step="0.01" oninput="alterarDesconto()"
                            required>
                        <input type="hidden" id="valor_pago_atual" name="valor_pago_atual" value="0.00">
                    </div>
                </div>

                <div class="formRow">
                    <div class="formField">
                        <label>Valor pago</label>
                        <input type="number" name="valor_pago" placeholder="Valor pago" step="0.01">

                    </div>
                    <div class="formField">
                        <label>Forma de pagamento</label>
                        <select name="forma_pagamento">
                            <option value="" disabled selected>Selecione...</option>
                            <option value="pix">Pix</option>
                            <option value="credito">Cartão de Crédito</option>
                            <option value="debito">Cartão de Débito</option>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>

                </div>
                <div id="info_pacote" class="hidden">
                    <table class="table-auto w-full text-sm text-left border border-gray-300 mb-4">
                        <tbody>
                            <tr class="border-b">
                                <th class="px-2 py-1 font-medium bg-gray-100">Código do Pacote</th>
                                <td class="px-2 py-1" id="codigo_pacote_display"></td>
                            </tr>
                            <tr class="border-b">
                                <th class="px-2 py-1 font-medium bg-gray-100">Valor Pago</th>
                                <td class="px-2 py-1">R$ <span id="valor_pago_display"></span></td>
                            </tr>
                            <tr class="border-b">
                                <th class="px-2 py-1 font-medium bg-gray-100">Valor Restante</th>
                                <td class="px-2 py-1">R$ <span id="valor_restante_display"></span></td>
                            </tr>
                            <tr>
                                <th class="px-2 py-1 font-medium bg-gray-100">Sessão Atual</th>
                                <td class="px-2 py-1">
                                    <span id="sessao_atual_display"></span> de <span id="total_sessoes_display"></span>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                </div>

                <div class="formField">
                    <label>Ambiente / Sala</label>
                    <select name="ambiente">
                        <option value="">Selecione...</option>
                        <option value="Andar 1 - Sala 1">Andar 1 - Sala 1</option>
                        <option value="Andar 1 - Sala 2">Andar 1 - Sala 2</option>
                        <option value="Andar 1 - Sala 3">Andar 1 - Sala 3</option>
                        <option value="Andar 1 - Sala externa">Andar 1 - Sala externa</option>
                        <option value="Andar 1 - Personal">Andar 1 - Personal</option>
                        <option value="Andar 2 - Sala 1">Andar 2 - Sala 1</option>
                        <option value="Andar 2 - Sala 2">Andar 2 - Sala 2</option>
                        <option value="Andar 2 - Sala 3">Andar 2 - Sala 3</option>
                    </select>

                </div>

                <div class="formField">
                    <label>Status de agendamento</label>
                    <select name="status">
                        <option value="" disabled selected>Selecione...</option>
                        <option value="agendado">✅ Agendado</option>
                        <option value="pre">✅ Pré-Agendado</option>

                    </select>
                </div>

                <div class="formField">
                    <label>OBSERVAÇÕES / NOTAS INTERNAS</label>
                    <textarea class="textarea-large" name="observacoes"></textarea>
                </div>
        </div>
        <div class="footer">
            <button class="btn-footer" type="submit">Agendar</button>
            <button class="btn-footer" type="submit">Gerar recibo</button>
        </div>
        </form>
    </div>
    <div class="content-header">
        <h2>Todas as consultas</h2>
        <form method="get" class="search-form">
            <div class="buttons_header" >
                
                
              
                        <input type="text" name="q" value="{{ query }}" placeholder="Buscar por paciente ou profissional aqui">
              
                        <input type="date" name="data_inicio" value="{{ data_inicio }}">
               
                        <input type="date" name="data_fim" value="{{ data_fim }}">
               
               
                <button class="btn-add" name="filtrar" value="1">Filtrar</button>
        </form>
 
        
    </div>
    <button type='button' id="openBtn" class="btn-add"> Novo Agendamento</button>

</div>

<div id="lista-agendamentos">
    
    {% for data, agendamentos in agendamentos_agrupados.items %}
    <div class="agenda-data-group">{{ data }}</div>

    {% for ag in agendamentos %}
    <div class="agenda-item">
        <div class="time-col">
            <div class="agenda-hora">
                <div style="background-color: {{ ag.cor_especialidade }};" class="bolinha"></div>
                <span>{{ ag.hora_inicio }} – {{ ag.hora_fim }} </span>

            </div>
        </div>


        <div class="info-col">
            <span class="paciente">{{ ag.paciente }}</span>
            <span class="profissional">{{ ag.especialidade }} com {{ ag.profissional }} </span>
            {% if ag.sessao_atual %}
            {% if ag.codigo|slice:":3" == "REP" %}
                <span class="sessao vermelho">Sessão de Reposição | {{ ag.codigo }}</span>
                {% else %}
            <span class="sessao verde">
                Sessão {{ ag.sessao_atual }} de {{ ag.sessoes_total }} | {{ ag.sessoes_restantes }} restante(s) | {{ ag.codigo }}
            </span>
            {% endif %}
        {% endif %}
        </div>

        <div class="status-col">
            <form method="post" action="{% url 'alterar_status_agendamento' ag.id %}">
                {% csrf_token %}
                <select name="status" class="status-select">
                    <option value="pre" {% if ag.status == 'pre' %}selected{% endif %}>✅ Pré-Agendado</option>
                    <option value="agendado" {% if ag.status == 'agendado' %}selected{% endif %}>✅ Agendado</option>
                    <option value="finalizado" {% if ag.status == 'finalizado' %}selected{% endif %}>✅ Consulta finalizada!</option>
                    <option value="desistencia" {% if ag.status == 'desistencia' %}selected{% endif %}>❌ D - Desmarcação</option>
                    <option value="desistencia_remarcacao" {% if ag.status == 'desistencia_remarcacao' %}selected{% endif %}>⚠️ DCR - Desmarcação com reposição</option>
                    <option value="falta_remarcacao" {% if ag.status == 'falta_remarcacao' %}selected{% endif %}>⚠️ FCR - Falta com reposição</option>
                    <option value="falta_cobrada" {% if ag.status == 'falta_cobrada' %}selected{% endif %}>❌ FC - Falta cobrada</option>
            </select>
        </div>
        <div class="actions-col">
            <button type="submit"  class="action-btn tooltip" ><i class='bx  bx-save'  ></i><span class="tooltiptext">Salvar Status</span> </button>
            <a href="{% url 'confirmacao_agendamento' ag.id %}">
                <button type="button" class="action-btn tooltip"><i class='bx  bx-send'  ></i><span class="tooltiptext">Ver detalhes</span>  </button>
            </a>
            <button data-id="{{ ag.id }}" type="button" id="openBtnEdit"
                class="btn-editar-agendamento action-btn tooltip" ><i class='bx  bxs-edit'  ></i><span class="tooltiptext">Editar agendamento</span>  </button>
              
        </div>
        </form>

    </div>
    {% endfor %}
    {% endfor %}
</div>



{% include "core/partials/modal_edit_agenda.html" %}
{% include "core/partials/alertas.html" %}
{% endblock %}

{% block scripts %}
  
  
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/imask"></script>
<script src="{% static 'core/js/base/MaskAndInputsBase.js' %}"></script>
<script src="{% static 'core/js/agenda/baseAgenda.js' %}"></script>
<script src="{% static 'core/js/base/scriptBase.js' %}"></script>


<script src="{% static 'core/js/profissionais/baseProfissionais.js' %}"></script>

{% endblock %}