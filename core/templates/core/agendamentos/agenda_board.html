{% load static %}
<!DOCTYPE html>

<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="{% static 'core/img/icons/logoRoxoFull.png' %}" type="image/png" />
  <title>Agenda Matrix - Ponto de Equilibro </title>
  <link rel="stylesheet" href="{% static 'core/css/tema.css' %}">
  <link rel="stylesheet" href="{% static 'core/css/agenda/agenda_matriz.css' %}">
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  

</head>
<body>
  <div class="professional-filter">
    <div class="date-picker">
      <input type="date" id="date-selector" value="{{ selected_date }}">
      <button id="today-btn">Hoje</button>
    </div>
    <select id="profissional-select" class="prof-select">
      <option value="">Todos os profissionais</option>
      {% for prof in profissionais %}
        <option value="{{ prof.id }}">{{ prof.nome }}</option>
      {% endfor %}
    </select>
    <div class="working-today">
      <label class='checkbox-option'>
        <input type="checkbox" id="working-today-check">
        Trabalha neste dia
      </label>
    </div>
  </div>

  <div class="date-filter">
    <div class="date-controls">
      <button id="prev-day"><i class="fas fa-chevron-left"></i></button>
      <h2 id="current-date">
        {% if is_today %}
          Hoje, {{ selected_date }}
        {% else %}
          {{ selected_date }}
        {% endif %}
      </h2>
      <button id="next-day"><i class="fas fa-chevron-right"></i></button>
    </div>

  </div>

  <div class="agenda-board">
    <!-- Coluna de Profissionais -->
    <div class="profissionais" id="profissionais-list">
      {% for prof in profissionais %}
        <div class="prof-card {% if not prof.tem_agenda %}sem-agenda{% endif %}" 
             data-prof-id="{{ prof.id }}"
             data-prof-name="{{ prof.nome }}">
          <i class="fas fa-user-md"></i> 
          <span>{{ prof.nome }}</span>
          {% if prof.tem_agenda %}
            <span style="font-size: 0.7rem; margin-left: auto; color: var(--roxoPrincipal);">●</span>
          {% endif %}
        </div>
      {% empty %}
        <div style="color: var(--text-light); text-align: center; padding: 20px;">
          Nenhum profissional encontrado
        </div>
      {% endfor %}
    </div>
  <!-- Área de horários -->
  <div class="horarios">
      <div class="table-container">
          <table id="agenda-table">
              <thead>
                  <tr>
                      <th class="horario-col">Horário</th>
                      {% for prof in profissionais %}
                          <th data-prof-id="{{ prof.id }}" data-prof-name="{{ prof.nome }}">
                              {{ prof.nome|truncatechars:20 }}
                          </th>
                      {% endfor %}
                  </tr>
              </thead>
              <tbody id="agenda-body">
                  {% for hora in horarios %}
                      <tr>
                          <td class="horario-col" data-hora="{{ hora }}">{{ hora }}</td>
                          {% for prof in profissionais %}
                              <td data-prof-id="{{ prof.id }}" data-hora="{{ hora }}">
                                  {% for ag in agendamentos %}
                                      {% if ag.profissional_1.id == prof.id and hora in ag.horarios_ocupados %}

                                          <div class="paciente" 
                                              style="background: {{ ag.especialidade.cor|default:'#8b5cf6' }}; border:1px solid {{ ag.especialidade.cor|default:'#8b5cf6' }}"
                                              data-agendamento-id="{{ ag.id }}"
                                              onclick="abrirDetalhesAgendamento({{ ag.id }})"
                                              title="Clique para ver detalhes">
                                              <i class="fas fa-user"></i> {{ ag.paciente.nome|truncatechars:15 }} - ID {{ ag.id }}

                                          </div>
                                      {% endif %}
                                  {% endfor %}
                              </td>
                          {% endfor %}
                      </tr>
                  {% endfor %}
              </tbody>
          </table>
      </div>
  </div>
 
  </div>
  <div id="agendamento-modal" class="modal-overlay">

  </div>
  {% block scripts %}

  <script type="module" src="{% static 'core/js/alertas/main.js' %}"></script>
  <script src="{% static 'core/js/base/scriptBase.js' %}"></script>
  <script>
// Date handling
let currentDate = new Date("{{ selected_date }}");

function formatarDataParaBR(date) {
    const diasSemana = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
    const meses = ['janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];
    
    const diaSemana = diasSemana[date.getDay()];
    const dia = date.getDate();
    const mes = meses[date.getMonth()];
    const ano = date.getFullYear();
    
    return `${diaSemana}, ${dia} de ${mes} de ${ano}`;
}

function updateDateDisplay() {
    const dateStr = formatarDataParaBR(currentDate);
    const hoje = new Date();
    const isToday = currentDate.toDateString() === hoje.toDateString();
    
    if (isToday) {
        document.getElementById('current-date').innerHTML = dateStr + ' <span style="color: var(--roxoPrincipal);"> - Hoje</span>';
    } else {
        document.getElementById('current-date').textContent = dateStr;
    }
    document.getElementById('date-selector').valueAsDate = currentDate;
}

// Navegação por data
document.getElementById('prev-day').addEventListener('click', () => {
    currentDate.setDate(currentDate.getDate() - 1);
    navigateToDate(currentDate);
});

document.getElementById('next-day').addEventListener('click', () => {
    currentDate.setDate(currentDate.getDate() + 1);
    navigateToDate(currentDate);
});

document.getElementById('today-btn').addEventListener('click', () => {
    currentDate = new Date();
    navigateToDate(currentDate);
});

document.getElementById('date-selector').addEventListener('change', (e) => {
    currentDate = new Date(e.target.value);
    navigateToDate(currentDate);
});

function navigateToDate(date) {
    const formattedDate = date.toISOString().split('T')[0];
    window.location.href = `?date=${formattedDate}`;
}

// Filtro por profissional - SIMPLIFICADO
document.getElementById('profissional-select').addEventListener('change', function() {
    const selectedProfId = this.value;
    
    // Resetar todos os cards primeiro
    document.querySelectorAll('.prof-card').forEach(card => {
        card.classList.remove('active');
        card.style.background = '';
        card.style.color = '';
        card.querySelector('i').style.color = '';
        
        if (card.classList.contains('sem-agenda')) {
            card.style.opacity = '0.6';
        }
    });
    
    // Mostrar/ocultar colunas da tabela
    document.querySelectorAll('th[data-prof-id]').forEach(th => {
        if (selectedProfId === '' || th.dataset.profId === selectedProfId) {
            th.style.display = '';
        } else {
            th.style.display = 'none';
        }
    });
    
    // Mostrar/ocultar células da tabela
    document.querySelectorAll('td[data-prof-id]').forEach(td => {
        const row = td.parentNode;
        const colIndex = Array.from(row.children).indexOf(td);
        const header = document.querySelector(`th:nth-child(${colIndex + 1})`);
        
        if (selectedProfId === '' || (header && header.dataset.profId === selectedProfId)) {
            td.style.display = '';
        } else {
            td.style.display = 'none';
        }
    });
    
    // Destacar profissional selecionado na sidebar
    if (selectedProfId !== '') {
        const selectedCard = document.querySelector(`.prof-card[data-prof-id="${selectedProfId}"]`);
        if (selectedCard) {
            selectedCard.classList.add('active');
        }
    }
});

// Click nos cards de profissional (sidebar)
document.querySelectorAll('.prof-card').forEach(card => {
    card.addEventListener('click', function() {
        const profId = this.dataset.profId;
        const select = document.getElementById('profissional-select');
        select.value = profId;
        select.dispatchEvent(new Event('change'));
    });
});

// Filtro "Trabalha hoje" - SIMPLIFICADO
document.getElementById('working-today-check').addEventListener('change', function() {
    document.querySelectorAll('.prof-card').forEach(card => {
        if (this.checked) {
            // Mostrar apenas quem trabalha (simulação)
            // Aqui você pode integrar com sua lógica real
            const trabalhaHoje = Math.random() > 0.3; // 70% trabalham
            if (!trabalhaHoje) {
                card.style.opacity = '0.3';
                card.style.pointerEvents = 'none';
            } else {
                card.style.opacity = '1';
                card.style.pointerEvents = 'auto';
            }
        } else {
            // Mostrar todos
            card.style.opacity = '1';
            card.style.pointerEvents = 'auto';
        }
    });
});



// Destacar hora atual - SIMPLIFICADO
function highlightCurrentTime() {
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    const currentDateStr = now.toISOString().split('T')[0];
    const selectedDateStr = "{{ selected_date }}";
    
    // Só destacar se for a data selecionada
    if (currentDateStr !== selectedDateStr) {
        document.querySelectorAll('.horario-col').forEach(td => {
            td.classList.remove('hora-atual');
        });
        return;
    }
    
    // Arredondar para o bloco de 30 minutos mais próximo
    const roundedMinute = Math.floor(currentMinute / 30) * 30;
    const currentTimeString = 
        String(currentHour).padStart(2, '0') + ':' + 
        String(roundedMinute).padStart(2, '0');
    
    // Remover destaque anterior
    document.querySelectorAll('.horario-col').forEach(td => {
        td.classList.remove('hora-atual');
    });
    
    // Destacar hora atual
    const currentTd = document.querySelector(`.horario-col[data-hora="${currentTimeString}"]`);
    if (currentTd) {
        currentTd.classList.add('hora-atual');
    }
}

// Inicializar
updateDateDisplay();
highlightCurrentTime();

// Atualizar hora atual periodicamente
setInterval(highlightCurrentTime, 1000 * 30); // Atualizar a cada 30 segundos

// Melhoria: Ajustar altura da tabela ao redimensionar
window.addEventListener('resize', function() {
    const agendaBoard = document.querySelector('.agenda-board');
    const profissionais = document.querySelector('.profissionais');
    const horarios = document.querySelector('.horarios');
    
    if (agendaBoard && profissionais && horarios) {
        const availableHeight = window.innerHeight - 120; // Subtrai altura dos filtros
        agendaBoard.style.height = `${availableHeight}px`;
    }
});

// Executar ajuste inicial de altura
setTimeout(() => {
    window.dispatchEvent(new Event('resize'));
}, 100);

// Melhoria: Scroll suave para a hora atual
function scrollToCurrentTime() {
    const now = new Date();
    const currentHour = now.getHours();
    const currentDateStr = now.toISOString().split('T')[0];
    const selectedDateStr = "{{ selected_date }}";
    
    if (currentDateStr === selectedDateStr) {
        const currentTimeString = String(currentHour).padStart(2, '0') + ':00';
        const currentRow = document.querySelector(`td.horario-col[data-hora="${currentTimeString}"]`);
        
        if (currentRow && currentRow.parentElement) {
            currentRow.parentElement.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }
    }
}

// Adicionar botão para ir para hora atual
    const scrollToNowBtn = document.createElement('button');
    scrollToNowBtn.innerHTML = '<i class="fas fa-clock"></i>';
    scrollToNowBtn.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--roxoPrincipal);
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        z-index: 100;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    `;
    scrollToNowBtn.addEventListener('click', scrollToCurrentTime);
    document.body.appendChild(scrollToNowBtn);
    async function abrirDetalhesAgendamento(agendamentoId) {
        const response = await fetch(`/api/agendamento/detalhar/${agendamentoId}/`);
        const data = await response.json()
        const container =  document.getElementById('agendamento-modal')
        container.classList.add('active');
        container.innerHTML = `
                    <div class="modal-card">
                            <!-- Cabeçalho do modal -->
                            <div class="modal-header">
                                <h3><i class="fas fa-calendar-check"></i> Detalhes do Agendamento</h3>
                                <button class="modal-close" id="close-modal">&times;</button>
                            </div>
                            
                            <!-- Corpo do modal -->
                            <div class="modal-body">
                                <div class="paciente-info">
                                    <!-- Foto e informações principais -->
                                    <div class="paciente-foto-container">
                                        <div class="paciente-foto" id="paciente-foto">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="paciente-dados">
                                            <h4 id="paciente-nome">${data.paciente_nome_completo}</h4>
                                            <div class="paciente-meta">
                                                <span><i class="fas fa-id-card"></i> <span id="paciente-codigo">ID: ${data.id}</span></span>
                                                <span><i class="fas fa-phone"></i> <span id="paciente-telefone">${data.paciente_celular}</span></span>
                                                <span><i class="fas fa-envelope"></i> <span id="paciente-email">${data.paciente_email}</span></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Informações do agendamento -->
                                    <div class="agendamento-detalhes">
                                        <div class="info-row">
                                            <div class="info-item">
                                                <i class="fas fa-calendar-day"></i>
                                                <div>
                                                    <small>Data</small>
                                                    <p id="agendamento-data">${data.data}</p>
                                                </div>
                                            </div>
                                            <div class="info-item">
                                                <i class="fas fa-clock"></i>
                                                <div>
                                                    <small>Horário</small>
                                                    <p id="agendamento-horario">${data.hora_inicio} - ${data.hora_fim}</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="info-row">
                                            <div class="info-item">
                                                <i class="fas fa-user-md"></i>
                                                <div>
                                                    <small>Profissional</small>
                                                    <p id="agendamento-profissional">${data.profissional_nome_completo}</p>
                                                </div>
                                            </div>
                                            <div class="info-item">
                                                <i class="fas fa-stethoscope"></i>
                                                <div>
                                                    <small>Especialidade</small>
                                                    <p id="agendamento-especialidade">${data.especialidade}</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Sessões -->
                                        <div class="sessoes-info">
                                            <h5><i class="fas fa-list-ol"></i> Sessões</h5>
                                            <div class="sessoes-container">
                                                <div class="sessao-item">
                                                    <i class="fas fa-play-circle"></i>
                                                    <div>
                                                        <small>Sessão Atual</small>
                                                        <p id="sessao-atual">${data.sessao_atual}</p>
                                                    </div>
                                                </div>
                                                <div class="sessao-item">
                                                    <i class="fas fa-hourglass-half"></i>
                                                    <div>
                                                        <small>Sessões Restantes</small>
                                                        <p id="sessoes-restantes">${data.sessoes_restantes}</p>
                                                    </div>
                                                </div>
                                                <div class="sessao-item">
                                                    <i class="fas fa-flag-checkered"></i>
                                                    <div>
                                                        <small>Total de Sessões</small>
                                                        <p id="total-sessoes">${data.qtd_sessoes}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Status -->
                                        <div class="status-container">
                                            <h5><i class="fas fa-info-circle"></i> Status</h5>
                                            <div class="status-badge em-andamento" id="status-badge">
                                                <span id="status-text">Em Andamento</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Observações -->
                                        <div class="observacoes-container">
                                            <h5><i class="fas fa-clipboard"></i> Observações</h5>
                                            <p id="agendamento-observacoes" class="observacoes-text">${data.observacoes}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Rodapé do modal -->
                            <div class="modal-footer">
                                <button class="btn-secundario" id="btn-editar">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn-principal" id="btn-confirmar">
                                    <i class="fas fa-check-circle"></i> Confirmar Presença
                                </button>
                            </div>
                        </div>
        `;
    
    }
  </script>
  {% endblock %}
</body>
</html>