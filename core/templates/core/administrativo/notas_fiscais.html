{% extends 'core/base.html' %}
{% load static %}

{% block title %}Notas Fiscais - Ponto de Equilíbrio{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/administrativo/notas_fiscais.css' %}">
<link rel="stylesheet" href="{% static 'core/css/tema.css' %}">

{% endblock %}

{% block topbar_title %}Pendências de Nota Fiscal{% endblock %}

{% block content %}

    <div class="content">
        <!-- Cabeçalho da página -->
        <header class="page-header">
            <div class="page-title">
                <p>Notas fiscais pendentes de emissão ou regularização</p>
            </div>
            <div class="page-actions">
                <div class="pendencies-counter">
                    <span class="counter-number">{{nf_pendente_count}}</span>
                    <span>Pendências em Aberto</span>
                </div>
            </div>
        </header>

        <!-- Cards de resumo -->
        <section class="summary-cards">
 
            <div class="card open">
                <div class="card-header">
                    <div>
                        <div class="card-title">Pendências Abertas Hoje</div>
                        <div class="card-value">{{ nf_pendente_count_hoje }}</div>
                    </div>
                    <div class="card-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
                <div class="card-description">Aguardando emissão</div>
            </div>
            <div class="card overdue">
                <div class="card-header">
                    <div>
                        <div class="card-title">Pendências Vencidas</div>
                        <div class="card-value">{{nf_atrasado_count}}</div>
                    </div>
                    <div class="card-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="card-description">Fora do prazo</div>
            </div>
            
            <div class="card value">
                <div class="card-header">
                    <div>
                        <div class="card-title">Valor Total Pendente</div>
                        <div class="card-value">R$ {{ nf_pendente_soma|floatformat:2 }}</div>
                    </div>
                    <div class="card-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                </div>
                <div class="card-description">Soma das pendências</div>
            </div>
            
            <div class="card resolved">
                <div class="card-header">
                    <div>
                        <div class="card-title">Resolvidas Hoje</div>
                        <div class="card-value">{{nf_emitidas_hoje_count}}</div>
                    </div>
                    <div class="card-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                <div class="card-description">Notas emitidas hoje</div>
            </div>
        </section>

        <!-- Filtros -->
        <form method="GET">
            <section class="filters-section">
                <div class="filters-header">
                    <div class="filters-title">Filtrar Pendências</div>
                    <button type="button" class="clear-filters"
                            onclick="window.location.href='{% url 'notas_fiscais' %}'">
                        <i class="fas fa-times"></i> Limpar filtros
                    </button>

                </div>
                <div class="filters-grid">

                    

                    <div class="filter-group">
                        <label class="filter-label">Paciente</label>
                        <input  type="search" class="filter-input" name='paciente' placeholder='Buscar pacientes' value='{{ request.GET.paciente }}'>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Prazo</label>
                        <input type="date" class="filter-input" name='prazo' value='{{ request.GET.prazo }}'>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select name='status' class="filter-select">
                            <option value="">Todos os status</option>
                            <option value="pendente"{% if request.GET.status == 'pendente' %}selected{% endif %} >Pendente</option>
                            <option value="emitida" {% if request.GET.status == 'emitida' %}selected{% endif %}>Emitida</option>
                            <option value="atrasado" {% if request.GET.status == 'atrasado' %}selected{% endif %}>Atrasado</option>
                            <option value="cancelada" {% if request.GET.status == 'cancelada' %}selected{% endif %}>Cancelada</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Finalidade</label>
                        <select name='finalidade' class="filter-select">
                            <option value="">Todas as finalidades</option>
                            <option value="nf_reembolso_plano" {% if request.GET.status == 'nf_reembolso_plano' %}selected{% endif %}>Reembolso Plano</option>
                            <option value="nf_imposto_renda" {% if request.GET.status == 'nf_imposto_renda' %}selected{% endif %}>Imposto de Renda</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>

            </section>
        </form>
        <form style="display:none">{% csrf_token %}</form>
        <input type="hidden" id="notaId">
        <!-- Tabela principal -->
        <section class="table-container">
            <div class="table-header">
                <div class="table-title">Pendências de Nota Fiscal</div>
                <div class="table-actions">
                    <button class="btn btn-secondary">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                    <button class="btn btn-primary" onclick="openEmitModal()" id="btnNewPayment">
                        <i class="fas fa-plus"></i> Novo Lançamento
                    </button>
                </div>
            </div>
            {% if nf_pendente_lista %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Paciente</th>
                        <th>Produto/Serviço</th>
                        <th>Valor</th>
                        <th>Data Pag.</th>
                        <th>Finalidade</th>
                        <th>Prazo (D+3)</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    
                    {% for nota in nf_pendente_lista %}

                    <tr>
                        <td>{{ nota.paciente.nome }} {{ nota.paciente.sobrenome }}</td>
                        <td>{{ nota.receita.pacote.servico.nome }} | {{ nota.receita.pacote.servico.qtd_sessoes }} sessões</td>
                        <td>R$ {{ nota.receita.valor }}</td>
                        <td>{{ nota.receita.ultimo_pagamento|date:"d/m/Y" }}</td>
                        <td>
                            {% if nota.paciente.nf_reembolso_plano %}
                            <span class="note-type nfse"><i class="fas fa-file-invoice"></i> Reembolso Plano </span></td>
                            {% elif nota.paciente.nf_imposto_renda %}
                            <span class="note-type nfe"><i class="fas fa-file-invoice"></i> Imposto de Renda </span></td>
                            {% else %}
                            <strong><i class="fas fa-file-invoice"></i>Erro! Sem Finalidade</strong>
                            {% endif %}
                        </td>
                        <td class="editable" data-field="previsao_emissao" data-id='{{nota.id}}' data-model="nota">
                            <span class="display-text">{{ nota.previsao_emissao|date:'d/m/Y' }}</span>
                            <input type="date"
                                            class="edit-input"
                                            value="{{ nota.previsao_emissao|date:'Y-m-d' }}"
                                            style="display:none">
                        </td>
                    
                        <td>
                            {% if nota.status == 'pendente' %}
                            <span class="status-badge status-pending">Pendente </span></td>
                            {% elif nota.status == 'emitida' %}
                            <span class="status-badge status-emitted">Emitida </span></td>
                            {% elif nota.status == 'atrasado' %}
                            <span class="status-badge status-overdue">Atrasado </span></td>
                            {% elif nota.status == 'cancelada' %}
                            <span class="status-badge status-cancelled">Cancelada </span></td>
                            {% else %}
                            <span class="status-badge status-avoled"></i>Não Infomado</span>
                            {% endif %}
                        </td>
 

                        <td>
                            <div class="action-buttons">
                                {% if nota.status == 'emitida' or nota.status == 'cancelada' %}
                                    <button class="action-btn resolve" title="Ver nota"  data-nota-id='{{ nota.id }}' onclick="openInfoModal(this)">
                                        <i class="fas fa-file-invoice"></i>
                                    </button>
                                {% else %}
                                    <button class="action-btn resolve" title="Marcar como Resolvido"  data-nota-id='{{ nota.id }}' onclick="openResolveModal(this)">
                                        <i class="fas fa-file-invoice"></i>
                                    </button>
                                    <button class="action-btn cancel" title="Justificar/Cancelar" data-nota-id='{{ nota.id }}' onclick="openCancelModal(this)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button class="btn-acao salvar" title="Salvar" style="display: none;"
                                        onclick="salvarEdicao(this)">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn-acao cancelar" title="Cancelar" style="display: none;"
                                        onclick="cancelarEdicao(this)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button class="btn-acao editar" title="Editar" onclick="iniciarEdicao(this)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
 
                </tbody>
            </table>
            {% else %}
             
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="far fa-check-circle"></i>
                </div>
                <h3 class="empty-title">Nenhuma pendência encontrada</h3>
                <p class="empty-description">Parabéns! Todas as notas fiscais estão regularizadas. Novas pendências aparecerão aqui automaticamente quando um pagamento exigir emissão de nota.</p>
            </div>
            {% endif %}
        </section>
    </div>

    <!-- Modal Emitir Nota -->

    <div class="modal-overlay" id="emitModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Nova Nota Fiscal</div>
                <button class="modal-close" onclick="closeModal('emitModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="position: relative;">
                    <label class="form-label" for="busca">Paciente</label>
                    <input id="busca" class="form-input" type="text">
                    <input type="hidden" id="paciente_id">
                    <div id="sugestoes"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Serviço</label>
                    <select id="servicoSelect" class="form-input">
                        <option value="">Selecione um paciente primeiro</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Valor</label>
                        <input type="text" class="form-input" id='valorPago'>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data do pagamento</label>
                        <input type="text" class="form-input" id='dataPag'>
                    </div>
                </div>
                

                

                
                <div class="form-group">
                    <label class="form-label">Tipo de nota *</label>
                    <select class="form-input">
                        <option value="">Selecione o tipo de nota</option>
                        <option value="nf_reembolso_plano">Reembolso Plano</option>
                        <option value="nf_imposto_renda">Imposto de Renda</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('emitModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="emitNote()">Salvar Nota</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="infoModal">

        <div class="modal">
            
            <div class="modal-header">
                <div class="modal-title">
                    <h2>Informações da Nota Fiscal</h2>
                    <span>Clique em cima das informações para copiar</span>
                </div>
                <button class="modal-close" onclick="closeModal('infoModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Paciente</label>
                        <p id='nfPaciente' type="text"   class="form-input" ></p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Documento</label>
                        <p id='nfDocumento' type="text"   class="form-input" ></p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Número da nota *</label>
                    <p id='nfNumero' type="text"   class="form-input"></p>
                </div>
                <div class="form-group" onclick="copiarTextoMensagem(this)">
                    <label class="form-label">Link da nota *</label>
                    <p id='nfLink' type="text"   class="form-input"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Data de emissão *</label>
                    <p id='nfData' class="form-input"></p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Observação (opcional)</label>
                    <p id='nfObs' class="form-textarea"></p>
                </div>
            </div>

        </div>
    </div>
    <!-- Modal Resolver Pendência -->
    <div class="modal-overlay" id="resolveModal">

        <div class="modal">
            
            <div class="modal-header">
                <div class="modal-title">Marcar como Resolvido</div>
                <button class="modal-close" onclick="closeModal('resolveModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Número da nota *</label>
                    <input id='numero_nota' type="text" name='numero_nota' class="form-input" placeholder="Informe o número da nota fiscal" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Link da nota *</label>
                    <input id='link_nota' type="text" name='link_nota' class="form-input" placeholder="Informe o link da nota fiscal" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Data de emissão *</label>
                    <input id='emissao_nota' type="date" name='emissao_nota' class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Observação (opcional)</label>
                    <textarea id='observacao_nota' class="form-textarea" name='observacao_nota' placeholder="Adicione observações sobre a resolução"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('resolveModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="resolvePendency()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Cancelar/Justificar -->
    <div class="modal-overlay" id="cancelModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Justificar / Cancelar Pendência</div>
                <button class="modal-close" onclick="closeModal('cancelModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Motivo *</label>
                    <select id='motivo_canc' class="form-input" required>
                        <option value="">Selecione o motivo</option>
                        <option value="p_desconto">Pagamento com desconto</option>
                        <option value="p_nao_quis">Paciente não quis</option>
                        <option value="outro">Outro motivo</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Observação *</label>
                    <textarea id='obs_canc' class="form-textarea" placeholder="Descreva o motivo do cancelamento/justificativa" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('cancelModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="cancelPendency()">Salvar</button>
            </div>
        </div>
    </div>

{% include "core/partials/alertas.html" %}
{% endblock %}

{% block scripts %}
<script src="{% static '/core/js/administrativo/nfBase.js' %}"></script>
 
{% endblock %}