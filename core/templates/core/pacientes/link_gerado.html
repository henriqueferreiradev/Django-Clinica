{% extends 'core/base.html' %}
{% load static %}

{% block title %}Link de Pr√©-Cadastro{% endblock %}
{% block topbar_title %}Link de Pr√©-Cadastro{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/pacientes/link_gerado.css' %}">
<link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
{% endblock %}

{% block content %}
<div class="content">
  <div class="right_content">

    <h2><i class='bx bx-link-alt'></i> Link de Pr√©-Cadastro</h2>

    <div class="steps">
      <p>üìã <strong>Passo 1:</strong> Copie o link ou use os bot√µes abaixo</p>
      <p>üì§ <strong>Passo 2:</strong> Envie por WhatsApp ou outro canal</p>
      <p>üì± <strong>Passo 3:</strong> O paciente preenche no celular</p>
    </div>

    <div class="right_link">
      <div class="right_link-link">
        <input type="text" id="link" value="{{ link_tokenizado }}" readonly>
        <button onclick="copiarLink()" class="btn-save">
          <i class='bx bx-copy'></i>
        </button>
      </div>

      <div class="social-buttons">
        <button onclick="enviarWhatsapp()"><i class='bx bxl-whatsapp'></i></button>
        <button onclick="window.open('https://telegram.me/share/url?url=' + encodeURIComponent(link))"><i class='bx bxl-telegram'></i></button>
        <button onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(link))"><i class='bx bxl-facebook'></i></button>
        <button><i class='bx bxl-instagram'></i></button> <!-- Apenas visual, pois o Instagram n√£o aceita links -->
      </div>
    </div>

    <p>Ou leia o QR Code</p>
    <img src="data:image/png;base64,{{ qrcode_base64 }}" alt="QR Code do Link">

    <p style="color:#888; font-size:13px; margin-top:20px;">
      üí° O preenchimento pode ser feito no consult√≥rio ou de casa.  
      Em caso de d√∫vidas, a recep√ß√£o est√° √† disposi√ß√£o.
    </p>
  </div>
  <div class="left_content">
    <div class="table-container" style="max-height: calc(100vh - 220px); overflow-y: auto;">
      <table>
  
        <thead >
          <tr>
            <th>Nome</th>
            <th>CPF</th>
            <th>Celular</th>
            <th>Nascimento</th>
            <th>Cadastro</th>
            <th>Situa√ß√£o</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% for paciente in pacientes %}
          <tr>
            <td>{{ paciente.nome }}</td>
            <td>{{ paciente.cpf }}</td>
            <td>{{ paciente.celular }}</td>
            <td>{{ paciente.data_nascimento|date:"d/m/Y" }}</td>
            <td>{{ paciente.data_cadastro|date:"d/m/Y" }}</td>
            <td>{% if paciente.pre_cadastro %}
                <span class="status-pendente">Pendente</span>
              {% endif %}
            </td>
      <td>
    <div class="dropdown-wrapper">
      <button class="action-btn" onclick="toggleDropdown(this)">‚ãÆ</button>
      <div class="dropdown_menu">
        <a href="{% url 'perfil_paciente' paciente.id %}">
          <button type="button">Ver detalhes</button>
        </a>
        <button onclick="window.location.href='{% url 'editar_paciente' paciente.id %}'">Editar</button>
        <button onclick="abrirFicha('{% url 'ficha_paciente' paciente.id %}')">Gerar Ficha</button>
        <button onclick="abrirFicha('{% url 'ficha_paciente' paciente.id %}')">Novo Agendamento</button>
        <form method="POST" action="{% url 'pacientes' %}" style="margin: 0;">
          {% csrf_token %}
          <input type="hidden" name="delete_id" value="{{ paciente.id }}">
          <button type="submit" onclick="return confirm('Deseja realmente inativar este paciente?')">
            Inativar
          </button>
        </form>
      </div>
    </div>
  </td>
  
          </tr>
          {% endfor %}
        </table>
        </tbody>
 
  </div>
</div>

<div id="copiado" class="toast">‚úÖ Link copiado com sucesso!</div>

<script>
  const link = document.getElementById("link").value;

  function copiarLink() {
    navigator.clipboard.writeText(link);
    const toast = document.getElementById("copiado");
    toast.style.display = 'block';
    setTimeout(() => toast.style.display = 'none', 3000);
  }

  function enviarWhatsapp() {
    const mensagem = `Ol√°! Para agilizar seu atendimento, preencha o formul√°rio: ${encodeURIComponent(link)}`;
    window.open(`https://wa.me/?text=${mensagem}`, "_blank");
  }
</script>
{% endblock %}
