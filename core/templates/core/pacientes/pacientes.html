{% extends 'core/base.html' %}

{% load static %}
{% block title %}Pacientes - Ponto de Equilíbrio{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/pacientes.css' %}">
<link rel="stylesheet" href="{% static 'core/css/tema.css' %}">
{% endblock %}
{% block topbar_title %} <i class="fas fa-users"></i> Pacientes{% endblock %}

{% block content %}

{% include "core/partials/_confirm_modal.html" %}

<div class="content">
{% include "core/partials/_loader.html" %}
{% include "core/partials/filtros/filtro_propac.html" %}
 
  <!-- Table Container -->
  <div class="table-container">
 

    <div class="table-content">
      <div class="table-scroll">
        <table class="table">
          <thead>
            <tr>
              <th>Nome</th>
              <th>CPF</th>
              <th>Celular</th>
              <th>Nascimento</th>
              <th>Cadastro</th>
              <th>Status no mês</th>
              <th>Situação</th>
              <th>Consentimentos</th>
              <th class="text-center">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for paciente in page_obj %}
            <tr class="
              {% if not paciente.ativo %}inativo{% endif %}
              {% if paciente.pre_cadastro and not paciente.conferido %}linha-pendente{% endif %}">
              <td>
                <div class="tooltip-wrapper"
                     onmouseenter="mostrarPopupComDelay(this)"
                     onmouseleave="ocultarPopup(this)">
              <span> {{ paciente.nome }} {{ paciente.sobrenome }}</span> <br>


                  <div class="tooltip-popup">
                    <div class="info">
                      {% if paciente.foto %}
                        <img src="{{ paciente.foto.url }}" alt="Foto">
                      {% else %}
                        <img src="https://via.placeholder.com/50" alt="Sem foto">
                      {% endif %}
                      <div>
                        <strong>{{ paciente.nome }} {{ paciente.sobrenome }} </strong><br>
                        {{ paciente.celular }}
                      </div>
                    </div>
                  </div>
                </div>
              </td>
              <td>{{ paciente.cpf }}</td>
              <td>{{ paciente.celular }}</td>
              <td class='nascimento-chip'>{{ paciente.data_nascimento|date:"d/m/Y" }} 
                  {% if paciente.eh_menor %}
                    <span data-tooltip="Paciente menor de idade." class="chip chip-menor">M</span>
                  {% endif %}
              </td>

              <td>{{ paciente.data_cadastro|date:"d/m/Y" }}</td>
              <td>
                {% if paciente.status_atual == "primeiro_mes" %}
                  <span class="badge badge-primeiro_mes">1º Mês</span>
                {% elif paciente.status_atual == "premium" %}
                  <span class="badge badge-premium">Premium</span>
                {% elif paciente.status_atual == "vip" %}
                  <span class="badge badge-vip">VIP</span>
                {% elif paciente.status_atual == "plus" %}
                  <span class="badge badge-plus">Plus</span>
                {% else %}
                  <span class="badge badge-indefinido">Indefinido</span>
                {% endif %}
              </td>

              <td>
                {% if paciente.ativo and paciente.conferido %}
                  <span class="badge status-conferido">Ativo</span>
                {% elif paciente.pre_cadastro and not paciente.conferido %}
                  <span class="badge status-pendente">Pendente</span>
                {% else %}
                  <span class="badge status-inativo">Inativo</span>
                {% endif %}
              </td>
              <td class="consent-col">
                <div class="consent-stack">

                  {# Tratamento #}
                  {% if paciente.consentimento_tratamento %}
                    <span class="consent-badge ok icon-only" data-tooltip="Tratamento: consentimento registrado">
                      <i class="fa-solid fa-image"></i>
                      <i class="fa-solid fa-circle-check sub-ico"></i>
                    </span>
                  {% else %}
                    <span class="consent-badge pendente icon-only" data-tooltip="Tratamento: sem consentimento">
                      <i class="fa-solid fa-image"></i>
                      <i class="fa-solid fa-circle-xmark sub-ico"></i>
                    </span>
                  {% endif %}

                  {# LGPD #}
                  {% if paciente.consentimento_lgpd %}
                    <span class="consent-badge ok icon-only" data-tooltip="LGPD: consentimento registrado">
                      <i class="fa-solid fa-shield-halved"></i>
                      <i class="fa-solid fa-circle-check sub-ico"></i>
                    </span>
                  {% else %}
                    <span class="consent-badge pendente icon-only" data-tooltip="LGPD: sem consentimento">
                      <i class="fa-solid fa-shield-halved"></i>
                      <i class="fa-solid fa-circle-xmark sub-ico"></i>
                    </span>
                  {% endif %}

                  {# Marketing #}
                  {% if paciente.consentimento_marketing %}
                    <span class="consent-badge ok icon-only" data-tooltip="Marketing: consentimento registrado">
                      <i class="fa-solid fa-bullhorn"></i>
                      <i class="fa-solid fa-circle-check sub-ico"></i>
                    </span>
                  {% else %}
                    <span class="consent-badge pendente icon-only" data-tooltip="Marketing: sem consentimento">
                      <i class="fa-solid fa-bullhorn"></i>
                      <i class="fa-solid fa-circle-xmark sub-ico"></i>
                    </span>
                  {% endif %}

                </div>
              </td>



              <td class="text-center">
                {% include "core/partials/_paciente_dropdown.html" %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center">
 
            <div class="empty-state">
                        <div class="empty-icon">
                            <i class="far fa-check-circle"></i>
                        </div>
                        <h3 class="empty-title">Nenhum paciente encontrado</h3>
                        <p class="empty-description">
                        Não encontramos pacientes com os critérios informados. 
                        Tente ajustar os filtros ou realizar um novo cadastro.
                        </p>
                    </div> 
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="pagination">
      <div class="pagination-info">
        Mostrando {{ page_obj.start_index }} - {{ page_obj.end_index }} de {{ page_obj.paginator.count }} registros
      </div>
      <div class="pagination-controls">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if situacao %}&situacao={{ situacao }}{% endif %}{% if data_inicio %}&data_inicio={{ data_inicio }}{% endif %}{% if data_fim %}&data_fim={{ data_fim }}{% endif %}{% if mostrar_todos %}&mostrar_todos=on{% endif %}{% if filtra_inativo %}&filtra_inativo=on{% endif %}" 
           class="pagination-btn">Anterior</a>
        {% else %}
        <button class="pagination-btn disabled">Anterior</button>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
          <button class="pagination-btn active">{{ num }}</button>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <a href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if situacao %}&situacao={{ situacao }}{% endif %}{% if data_inicio %}&data_inicio={{ data_inicio }}{% endif %}{% if data_fim %}&data_fim={{ data_fim }}{% endif %}{% if mostrar_todos %}&mostrar_todos=on{% endif %}{% if filtra_inativo %}&filtra_inativo=on{% endif %}" 
             class="pagination-btn">{{ num }}</a>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if situacao %}&situacao={{ situacao }}{% endif %}{% if data_inicio %}&data_inicio={{ data_inicio }}{% endif %}{% if data_fim %}&data_fim={{ data_fim }}{% endif %}{% if mostrar_todos %}&mostrar_todos=on{% endif %}{% if filtra_inativo %}&filtra_inativo=on{% endif %}" 
           class="pagination-btn">Próxima</a>
        {% else %}
        <button class="pagination-btn disabled">Próxima</button>
        {% endif %}
      </div>
    </div>
  </div>
 

{% include "core/partials/alertas.html" %}
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/imask"></script>
<script src="{% static 'core/js/base/abrirFiltro.js' %}"></script>
<script src="{% static '/core/js/pacientes/base.js' %}"></script>
<script src="{% static '/core/js/pacientes/cep.js' %}"></script>
{% endblock %}