{% extends 'core/base.html' %}

{% load static %}
{% block title %}Pacientes - Ponto de Equilíbrio{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/pacientes.css' %}">
{% endblock %}




{% block topbar %}
<div class="topbar">
  <div class="topbar-div">
    <i class='bx bx-menu'></i>
    <span class="text">Pacientes</span>
    <form method="GET" action="{% url 'pacientes' %}" class="search-form" type="search">
      <input type="text" name="q" value="{{ query|default:'' }}" placeholder="Buscar paciente aqui">
    </form>
  </div>
  <div class="topbar-div">
    <div class="name-job">
      <div class="profile_name">Olá, {{ user.get_full_name }}</div>
    </div>
    <a href="{% url 'logout' %}">
      <i class='bx btn-sair bx-log-out'></i>
    </a>
  </div>
</div>
{% endblock %}
{% block content %}
{% if messages %}
<div class="messages-container" id="alert-container">
    {% for message in messages %}
    <div class="alert {{ message.tags }}">
        <span class="icon">
            {% if message.tags == 'success' %}
            ✅
            {% elif message.tags == 'warning' %}
            ⚠️
            {% elif message.tags == 'error' %}
            ❌
            {% elif message.tags == 'info' %}
            ℹ️
            {% endif %}
        </span>
        {{ message }}

    </div>
    {% endfor %}
</div>
{% endif %}
<div class="content">
  <div class="content-header">
    <h2>Lista de Pacientes</h2>
    <div class='header_buttons'>
    <form method="get">
      <select clas='select-s' name="periodo" id="periodo">
        <option value="semana">Última semana</option>
        <option value="mes">Este mês</option>
        <option value="semestre">Este semestre</option>
        <option value="ano">Este ano</option>
      </select>
      <button type="submit">Filtrar</button>
    </form>
    <button  onclick="window.location.href='{% url 'cadastrar_paciente' %}'">+ Add Paciente</button>
  </div>
  </div>
  <div class="table-container" style="max-height: calc(100vh - 220px); overflow-y: auto;">
    <table>

      <thead >
        <tr>
          <th>Nome</th>
          <th>CPF</th>
          <th>Celular</th>
          <th>Nascimento</th>
          <th>Cadastro</th>
          <th>Classe</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for paciente in pacientes %}
        <tr class="{% if not paciente.ativo %} inativo{% endif %}">
          <td>
            <div class="tooltip-wrapper"
                 onmouseenter="mostrarPopupComDelay(this)"
                 onmouseleave="ocultarPopup(this)">
              <span>{{ paciente.nome }} {{ paciente.sobrenome }}</span>
              <div class="tooltip-popup">
                <div class="info">
                  {% if paciente.foto %}
                    <img src="{{ paciente.foto.url }}" alt="Foto">
                  {% else %}
                    <img src="https://via.placeholder.com/50" alt="Sem foto">
                  {% endif %}
                  <div>
                    <strong>{{ paciente.nome }} {{ paciente.sobrenome }}</strong><br>
                    {{ paciente.celular }}
                  </div>
                </div>
              </div>
            </div>
          </td>
          <td>{{ paciente.cpf }}</td>
          <td>{{ paciente.celular }}</td>
          <td>{{ paciente.data_nascimento|date:"d/m/Y" }}</td>
          <td>{{ paciente.data_cadastro|date:"d/m/Y" }}</td>
          <td><span class="badge grade-simples">Premium</span></td>
          <td><button class="action-btn" onclick="toggleDropdown(this)">⋮</button>
            <div class="dropdown">
              <button onclick="abrirModal({{ paciente.id }})">Ver detalhes</button>
              <button onclick="window.location.href='{% url 'editar_paciente' paciente.id %}'">Editar</button>
              <button onclick="abrirFicha('{% url 'ficha_paciente' paciente.id %}')">Gerar Ficha</button>
              <button onclick="abrirFicha('{% url 'ficha_paciente' paciente.id %}')">Novo Agendamento</button>
              <form method="POST" action="{% url 'pacientes' %}" style="margin: 0;">
                {% csrf_token %}
                <input type="hidden" name="delete_id" value="{{ paciente.id }}">
                <button type="submit" onclick="return confirm('Deseja realmente inativar este paciente?')">
                  Excluir
                </button>
          
              </form>
            


            </div>
          </td>
        </tr>
        {% endfor %}
      </table>
      </tbody>
      <div class="tabela_infos-dados">
        <p>Mostrando: {{ total_filtrados }} de {{ total_ativos }}</p>
        <form method="get" style="display: inline;">
          <label class="label_inativos">
            <input type="checkbox" name="mostrar_todos" onchange="this.form.submit()" 
            {% if mostrar_todos %}checked{% endif %}>
            Mostrar inativos
          </label>
        </form>
        <form method="get" style="display: inline;">
          <label class="label_inativos">
            <input type="checkbox" name="filtra_inativo" onchange="this.form.submit()" 
            {% if filtra_inativo %}checked{% endif %}>
            Mostrar apenas inativos
          </label>
        </form>
      </div>
    </div>
    </table>
  </div>



<div id="modalOverlay" class="overlay" style="display: none;">
  <div class="modal">
    <div class="perfil_topbar">
      <div  class="patient-header">
        <h2 id="pacienteNome"></h2>
        <span class="birth" id="pacienteNascimento"></span> 
        <span class="birth" id="pacienteIdade"></span>
      </div>
      <span class="fechar" onclick="fecharModal()">×</span>
    </div>
    <div class="patient-card">
      <div class="patient-photo">
        <img id="pacienteFoto" src="" alt="Foto do paciente">
      </div>
      <div class="patient-info-table">
        <table>
          <tbody>
            <tr>
              <th>RG</th>
              <td id="pacienteRg"></td>
              <th>CPF</th>
              <td id="pacienteCpf"></td>
            </tr>
            <tr>
              <th>Telefone</th>
              <td id="pacienteTelefone"></td>
              <th>Celular</th>
              <td id="pacienteCelular"></td>
            </tr>
            <tr>
              <th>Cor</th>
              <td id="pacienteCor"></td>
              <th>Sexo</th>
              <td id="pacienteSexo"></td>
            </tr>
            <tr>
              <th>Estado Civil</th>
              <td id="pacienteEstadoCivil"></td>
              <th>Email</th>
              <td id="pacienteEmail"></td>
            </tr>
            <tr>
              <th>Endereço</th>
              <td colspan="3" id="pacienteEndereco"></td>
            </tr>
            <tr>
              <th>Observação</th>
              <td colspan="3" id="pacienteObs"></td>
            </tr>
          </tbody>
        </table>
      
 
        </div>
      </div>
    </div>
  </div>
</div>


</div>

{% endblock %}

{% block scripts %}
 
  
<script src="https://unpkg.com/imask"></script>

<script src="{% static '/core/js/pacientes/base.js' %}"></script>
<script src="{% static '/core/js/pacientes/cep.js' %}"></script>
{% endblock %}