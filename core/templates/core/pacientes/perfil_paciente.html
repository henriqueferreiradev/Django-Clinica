{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
      <script>
 
    (function() {
      const isDark = localStorage.getItem('theme') === 'dark';
      document.documentElement.classList.toggle('dark', isDark);
    })();
  </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{% static 'core/img/icons/logoRoxoFull.png' %}" type="image/png"/>
    <title>Perfil do Paciente | Ponto de Equilíbrio</title>.
    
    <link rel="stylesheet" href="{% static 'core/css/tema.css' %}">
    <link rel="stylesheet" href="{% static 'core/css/pacientes/perfil_paciente.css' %}">
    <link href="https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
 
</head>             
<body>
    <div class="container">
        <!-- Header Section -->
        <header>
            <div class="header-content">
                <div class="patient-info">
                    <div class="patient-avatar">
                    {% if paciente.foto %}
                    <img src="{{ paciente.foto.url }}" alt="Foto de {{ paciente.nome }}">
                    {% else %}
                    <img src="{% static 'core/img/defaultPerfil.png' %}" alt="Sem foto">
                    {% endif %}                    </div>
                    <div>
                        <h1 class="patient-name">{{ paciente.nome }} {{ paciente.sobrenome }}</h1>
                        <p class="patient-id">ID: {{ paciente.id }}</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="window.location.href='{% url 'editar_paciente' paciente.id %}'">
                        <i class="fas fa-edit"></i> Editar Dados
                    </button>
                    <button class="btn btn-secondary">
                        <i class="fas fa-plus"></i> Adicionar Observação
                    </button>
                    <button class="btn btn-gray">
                        <i class="fas fa-calendar"></i> Voltar para Agenda
                    </button>
                </div>
            </div>
        </header>

        <div class="grid-container">
            <!-- Left Column -->
            <div class="space-y-6">
                <!-- Section 1: Dados Cadastrais -->
                <section class="section">
                    <h2 class="section-title">Dados Cadastrais</h2>
                    <div class="data-grid">
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Nome Completo</label>
                            <p class="font-medium" > {{ paciente.nome }} {{ paciente.sobrenome }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Nome Social</label>
                            <p class="font-medium" > {{ paciente.nomeSocial }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">CPF/RG</label>
                            <p class="font-medium" >{{ paciente.cpf }} / {{paciente.rg }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Data de Nascimento</label>
                            <p class="font-medium" >{{ paciente.data_nascimento }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Idade</label>
                            <p class="font-medium">{{ paciente.idade_formatada}}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Telefone</label>
                            <p class="font-medium" > {{ paciente.telefone }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">WhatsApp</label>
                            <div class="flex items-center gap-2">
                                <p class="font-medium" >{{ paciente.celular }}</p>
 
                            </div>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">E-mail</label>
                            <p class="font-medium" >{{paciente.email}}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Endereço</label>
                            <p class="font-medium" >{{ paciente.endereco_formatado }} </p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Cor/Raça</label>
                            <p class="font-medium" >{{ paciente.get_cor_raca_display }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Sexo/Gênero</label>
                            <p class="font-medium" >{{ paciente.get_sexo_display }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Estado Civil</label>
                            <p class="font-medium" >{{ paciente.get_estado_civil_display }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Profissão</label>
                            <p class="font-medium" >{{ paciente.profissao }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Como nos conheceu?</label>
                            <p class="font-medium" >{{ paciente.get_midia_display }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Rede Social</label>
                            <p class="font-medium" >{{ paciente.redeSocial }}</p>
                        </div>
                    </div>
                </section>

                <!-- Section 2: Dados de Atendimento -->
                <section class="section">
                    <h2 class="section-title">Dados de Atendimento</h2>
                    <div class="data-grid data-grid-3">
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Primeiro Atendimento</label>
                            <p class="font-medium">{% if primeiro_agendamento %} {{primeiro_agendamento|date:"d/m/Y"}} {% else %} Sem registros {% endif %}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Último Atendimento</label>
                            <p class="font-medium">{% if ultimo_agendamento %} {{ultimo_agendamento|date:"d/m/Y"}} {% else %} Sem registros {% endif %}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Status</label>
                            <span class="badge badge-success">{% if paciente.ativo %} Ativo {% else %} Inativo {% endif %}</span>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Frequência Semanal</label>
                            <p class="font-medium">{% if frequencia_semanal %} {{ frequencia_semanal }}x/Semana {% else %} 0x/Semana {% endif %}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Total de Sessões</label>
                            <p class="font-medium">{{quantidade_agendamentos}}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Sessões Faltadas</label>
                            <p class="font-medium">{{quantidade_faltas}}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Sessões Remarcadas</label>
                            <p class="font-medium">{{quantidade_repostas}}</p>
                        </div>
                    </div>
                </section>

                <!-- Section 3: Pacotes e Sessões -->
                <section class="section">
                    <h2 class="section-title">Pacotes e Sessões</h2>
                    
                    <div class="mb-6">
                        <h3 class="font-medium text-gray-700 mb-2">Pacote Ativo</h3>
                        {% if pacote_ativo %}
                        <div class="package-card">
                            <div class="package-header">
                                <h4 class="package-title">{{pacote_ativo}} ({{qtd_total}} sessões)</h4>
                                <span class="badge badge-info">{% if pacote_ativo.ativo %} Ativo {% else %} Inativo {% endif %}</span>
                            </div>
                            <p class="package-description">Inclui: Sessões de 50min com psicólogo</p>
                            
                            <div class="progress-container">
                                <div class="progress-info">
                                    <span>Progresso: {{sessao_atual}}/{{qtd_total}} sessões</span>
                                    <span>{{progresso}}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: {{progresso}}%"></div>
                                </div>
                            </div>
                            
                            <div class="data-grid">
                                <div>
                                    <p class="text-gray-500 text-sm">Início</p>
                                    <p class="font-medium">{{data_inicio_pacote_ativo}}</p>
                                </div>
                                <div>
                                    <p class="text-gray-500 text-sm">Vencimento</p>
                                    <p class="font-medium">Sem vencimento</p>
                                </div>
                            </div>
                        </div>
                        {% else %}
                            <h4 class="package-title text-sm">Não há informações no momento.</h4>    
                        {% endif %}
                    </div>
                    
                    <h3 class="font-medium text-gray-700 mb-2">Histórico de Pacotes</h3>
                    
                    <div class="space-y-3">
                    {% if pacotes_dados %}
                        {% for pacote in pacotes_dados %}
                            <div class="note-card">
                                <div class="package-header">
                                    <h4 class="package-title text-sm">
                                        {{ pacote.pacote.servico.nome }} ({{ pacote.qtd_total }} sessões)
                                    </h4>
                                    <span class="badge {% if item.status == 'Ativo' %}badge-success{% else %}badge-gray{% endif %}">
                                        {{ pacote.status }}
                                    </span>
                                </div>
                    
                                <p class="text-gray-600 text-sm mb-1">
                                    {{ pacote.data_inicio|date:"d/m/Y" }}
                                    {% if pacote.data_fim %}
                                        - {{ pacote.data_fim|date:"d/m/Y" }}
                                    {% endif %}
                                </p>
                    
                                <p class="text-gray-600 text-sm">
                                    {{ pacote.sessoes_realizadas }}/{{ pacote.qtd_total }} sessões realizadas
                                </p>
                            </div>
                        {% endfor %}
                    {% else %}
                     <h4 class="package-title text-sm">Não há informações no momento.</h4>
                     {% endif %}
                    </div>
                    
                </section>

                <!-- Section 4: Serviços Mais Contratados -->
                <section class="section">
                
                    <h2 class="section-title">Serviços Mais Contratados</h2>
                    <div class="data-grid">
                    {% if mais_contratados %}
                        {% for especialidade in mais_contratados %}
                        <div class="note-card">
                            
                            <div class="package-header">
                                <h3 class="package-title text-sm"> {{especialidade.nome}}</h3>
                                <span class="badge badge-info" style= ' color:white; background:{{especialidade.cor}}'>{% if especialidade.total == 1 %}{{especialidade.total}} sessão {% else %} {{especialidade.total}} sessões {% endif %}</span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <h4 class="package-title text-sm">Não há informações no momento.</h4>    
                    {% endif %}

                    </div>
                </section>

                 <section class="section">
                
                    <h2 class="section-title">Histórico de Status</h2>
                    <div class="data-grid">
                    {% if historico_status %}
                        {% for status in historico_status %}
                        <div class="note-card">
                            
                            <div class="package-header">
                                <h3 class="package-title text-sm"> {{status.mes}}/{{status.ano}}</h3>
                                <h3 class="package-title text-sm"> </h3>
                                <td>
                                    {% if status.status == "primeiro_mes" %}
                                        <span class="badge badge-primeiro_mes">1º Mês</span>
                                    {% elif status.status == "premium" %}
                                        <span class="badge badge-premium">Premium</span>
                                    {% elif status.status == "vip" %}
                                        <span class="badge badge-vip">VIP</span>
                                    {% elif status.status == "plus" %}
                                        <span class="badge badge-plus">Plus</span>
                                    {% else %}
                                        <span class="badge badge-indefinido">Indefinido</span>
                                    {% endif %}
                                </td>

                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <h4 class="package-title text-sm">Não há informações no momento.</h4>    
                    {% endif %}

                    </div>
                </section>
                <section class="section">
                    <h2 class="section-title">Formulários Respondidos</h2>
                    <div class="data-grid">
                    {% if respostas_formularios %}
                        {% for resposta in respostas_formularios %}
                        <div class="data-card">
                            <div class="form-header">
                                <h3 class="package-title text-sm">{{ resposta.formulario.titulo }}</h3>
                                 
                                    <span class="badge badge-info">
                                        Respondido em {{ resposta.enviado_em|date:"d/m/Y" }} às {{ resposta.enviado_em|date:"H:i" }}
                                    </span>
                                    <a href="{% url 'visualizar_respostas' resposta.id %}"> <i class="bx bx-show"></i>Ver respostas</a>
                                
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <h4 class="package-title text-sm">Não há respostas no momento.</h4>    
                    {% endif %}
                    </div>
                </section>

            </div>

            <!-- Right Column -->
            <div class="space-y-6">
                <!-- Section 5: Profissionais que mais atenderam -->
                <section class="section">
                    <h2 class="section-title">Profissionais que mais atenderam</h2>
                    <h2 class="section-subtitle">Como Condutor da Sessão</h2>
                    <div class="space-y-4">
                    {% if profissional_principal %}
                        {% for profissional in profissional_principal %}
                            <div class="professional-card">
                                <div class="professional-avatar">
                                    {% if profissional.profissional_1__foto %}
                                        <img src="{{ profissional.foto_url }}" alt="Foto de {{ profissional.nome }}" width="150">
                                    {% else %}
                                        <div class="profile-placeholder">
                                            {{ profissional.nome|slice:":1" }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div>
                                    <h3 class="professional-name">{{profissional.profissional_1__nome}}</h3>
                                    <p class="professional-sessions">{{profissional.total}} atendimentos | {{profissional.tempo_sessao}} totais</p>
                            
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <h3 class="professional-name">Não há informações no momento.</h3>
                    {% endif %}
                        <h2 class="section-subtitle">Como Apoio na Sessão</h2>
                    {% if profissional_auxiliar %}
                    {% for profissional in profissional_auxiliar %}
                        <div class="professional-card">
                            <div class="professional-avatar">
                                {% if profissional.profissional_1__foto %}
                                    <img src="{{ profissional.foto_url }}" alt="Foto de {{ profissional.nome }}" width="150">
                                {% else %}
                                    <div class="profile-placeholder">
                                        {{ profissional.nome|slice:":1" }}
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                <h3 class="professional-name">{{profissional.profissional_2__nome}}</h3>
                                <p class="professional-sessions">{{profissional.total}} atendimentos | {{profissional.tempo_sessao}} totais</p>
                            </div>
                        </div>
                     {% endfor %}
                    {% else %}
                        <h3 class="professional-name">Não há informações no momento.</h3>
                    {% endif %}
                    </div>
                </section>

                <!-- Section 6: Histórico de Agendamentos -->
                <section class="section">
                    <h2 class="section-title">Histórico de Agendamentos</h2>
                    <ul class="timeline space-y-4">
                    {% if tres_ultimos_agendamentos %}
                    {% for agendamento in tres_ultimos_agendamentos %}
                    
                        <li class="timeline-item">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                            
                                <div class="timeline-header">
                                    <div>
                                        <h3 class="timeline-title"> {{agendamento.paciente.nome}} </h3>
                                        <p class="timeline-date text-sm">{{agendamento.data|date:"d/m/Y"}} - {{ agendamento.hora_inicio|time:"H:i" }} / {{ agendamento.hora_fim|time:"H:i" }}</p>
                                    </div>
                                    <span class="badge badge-success">{{agendamento.get_status_display}}</span>
                                </div>
                                <p class="timeline-meta text-sm">{{agendamento.profissional_1.nome}}</p>
                                {% if not agendamento.observacoes %}
                                <p class="timeline-note">Paciente ainda não possui observações nessa consulta.</p>
                                {% else %}
                                <p class="timeline-note">{{agendamento.observacoes}}</p>
                                {%endif%}
                            </div>
                        </li>

                    {% endfor %}

                        <button style='width: 100%;' class="btn btn-primary">
                            Ver histórico completo
                        </button>
                    {% else %}
                        <h3 class="professional-name">Não há informações no momento.</h3>
                    {% endif %}
                    </ul>
                </section>

                <!-- Section 7: Observações Gerais -->
                <section class="section">
                    <h2 class="section-title">Prontuários</h2>
                    <div class="space-y-3">
                    {% if ultimos_agendamentos %}
                    <form style='display:none' id="obs-container" method="POST" action="">
                        {% csrf_token %}
                        
                        <div  class="observacao-div space-y-2">
                            <select name="agendamento_id" id="agendamento_id" required>
                                <option disabled selected>-- Selecione o agendamento --</option>
                                {% for agendamento in ultimos_agendamentos %}
                                    <option value="{{ agendamento.id }}">
                                        {{ agendamento.data|date:"d/m/Y" }} - {{ agendamento.hora_inicio|time:"H:i" }} com {{ agendamento.profissional_1.nome }}
                                    </option>
                                {% endfor %}
                            </select>
                    
                            <textarea name="observacao" id="observacao" rows="4" required></textarea>
 
                        </div>
                    

                    <div style='display:flex; width: 100%; gap: 1em; margin-top:1em;'>
                    <button  id="btnCancelObs" style="display: block; width: 50%;" onclick="toggleObservacao()" class="btn btn-primary">
                            Cancelar
                        </button>
                        <button  type="submit" style=' display:none; width:50%' id='btnSave' class="btn btn-primary">Salvar</button>
                    </div>
                    </form>
                    <button  id="btnToggleObs" onclick="toggleObservacao()" class="btn btn-primary">Adicionar nova observação</button>


                    {% for agendamento in ultimos_agendamentos %}
                    {% if agendamento.observacoes %}
                    <div class="note-card">
                    {% if agendamento.observacoes %}
                        <div class="note-header">
                            {% if agendamento.observacao_autor %}
                            <p class="note-author"> {{ agendamento.observacao_autor.get_full_name|default:agendamento.observacao_autor.username }}</p>
                            {% else %}
                            <p class="note-author">Sem usuário</p>
                            {% endif %}
                            <p class="note-date">{{ agendamento.observacao_data|date:"d/m/Y" }}</p>
                            </div>
                            <p class="note-content">{{agendamento.observacoes}}</p>
                    </div>
                        {% else %}
                             <h3 class="professional-name">Não há informações no momento.</h3>
                        {% endif %}
                        {% endif %}
                        {% endfor %}
                
                    {% else %}
                        <h3 class="professional-name">Não há informações no momento.</h3>
                    {% endif %}

                    </div>
                </section>

                <!-- Section 8: Dados Financeiros -->
                <section class="section">
                    <h2 class="section-title">Dados Financeiros</h2>
                    <div class="space-y-4">
                        <div>
                            <p class="financial-label">Total gasto</p>
                            <p class="financial-total">{{soma_pagamentos}}</p>
                        </div>
                        
                        <div class="payment-ranking">
                            <p class="financial-label label-title">Ranking de Pagamentos</p>
                            <div class="table-wrapper">
                                <table class="ranking-table">
                                    <thead>
                                        <tr>
                                            <th>Ícone</th>
                                            <th>Pagamento</th>
                                            <th>Quantidade</th>
                                            <th>Porcentagem</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if top_forma_pagamento %}
                                        {% for pagamento in top_forma_pagamento %}
                                        <tr>
                                            <td>
                                                <div class="{% if pagamento.forma_pagamento == 'pix' %}payment-icon blue
                                                          {% elif pagamento.forma_pagamento == 'dinheiro' %}payment-icon green
                                                          {% elif pagamento.forma_pagamento == 'credito' %}payment-icon yellow
                                                          {% elif pagamento.forma_pagamento == 'debito' %}payment-icon purple
                                                          {% else %}payment-icon red{% endif %}">
                                                    <i class="{% if pagamento.forma_pagamento == 'pix' %}fas fa-qrcode blue
                                                             {% elif pagamento.forma_pagamento == 'dinheiro' %}fas fa-money-bill-wave green
                                                             {% elif pagamento.forma_pagamento == 'credito' %}fas fa-credit-card yellow
                                                             {% elif pagamento.forma_pagamento == 'debito' %}fas fa-money-check purple
                                                             {% else %}fas fa-question-circle red{% endif %}"></i> 
                                                </div>
                                            </td>
                                            <td>{{ pagamento.forma_pagamento|title }}</td>
                                            <td>{{ pagamento.quantidade }}x</td>
                                            <td>{{ pagamento.porcentagem }}%</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    {% else %}
                                    <tr>
                                        <td colspan="3" >Não há informações no momento</td>
                                    </tr>
                                {% endif %}
                                </table>
                            </div>
                        </div>
                
                        <div>
                            <p class="financial-label">Débitos pendentes</p>
                            {% if total_debito %}
                            <p class="financial-total font-medium text-green-600">R$ {{total_debito}}</p>
                            {% else %}
                            <p class="font-medium text-green-600">Nenhum débito pendente</p>
                            {% endif %}
                        </div>
                        
                        <div class="payment-list">
                            <h3 class="label-title">Últimos pagamentos</h3>
                            <div class="table-wrapper">
                                <table class="ranking-table">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Forma de Pagamento</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if ultimos_pagamentos %}
                                            {% for pagamento in ultimos_pagamentos %}
                                            <tr>
                                                <td>{{ pagamento.data|date:'d/m/Y' }}</td>
                                                <td>{{ pagamento.get_forma_pagamento_display }}</td>
                                                <td class="text-green-600 font-medium">R$ {{ pagamento.valor }}</td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="3" >Não há informações no momento</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Quick Actions Footer -->
        <div class="quick-actions">
            <button class="action-btn action-btn-primary">
                <i class="fas fa-calendar-plus"></i>
            </button>
            <button class="action-btn action-btn-success">
                <i class="fab fa-whatsapp"></i>
            </button>
            <button class="action-btn action-btn-instagram" onclick="window.open('https://instagram.com/{{ paciente.redeSocial }}', '_blank')">
                <i class="fab fa-instagram"></i>
            </button>
            <button  class="action-btn action-btn-dark" onclick="abrirFicha('{% url 'ficha_paciente' paciente.id %}')">
                <i class="fas fa-file-pdf"></i>
            </button>
        </div>
    </div>
    {% include "core/partials/alertas.html" %}

    {% block scripts %}
<script>


const btnToggleObs = document.getElementById('btnToggleObs');
const btnCancelObs = document.getElementById('btnCancelObs');
const obsContainer = document.getElementById('obs-container');
const btnSave = document.getElementById('btnSave');

function toggleObservacao() {
    const isVisible = obsContainer.style.display === 'block';

    if (isVisible) {
        // Ocultar observação
        obsContainer.style.display = 'none';
        btnSave.style.display = 'none';
        btnToggleObs.style.display = 'inline-block';
    } else {
        // Mostrar observação
        obsContainer.style.display = 'block';
        btnSave.style.display = 'block';
        btnToggleObs.style.display = 'none';
    }
}

</script>
  
<script src="https://unpkg.com/imask"></script>

<script src="{% static '/core/js/pacientes/base.js' %}"></script>
<script src="{% static '/core/js/base/base.js' %}"></script>
<script src="{% static '/core/js/pacientes/cep.js' %}"></script>
{% endblock %}
</body>

</html>