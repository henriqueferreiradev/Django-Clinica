{% extends 'core/base.html' %}
{% load static %}

{% block title %}Perfil - {{ paciente.nome }}{% endblock %}

{% block extra_css %}
 
    <link rel="stylesheet" href="{% static 'core/css/tema.css' %}">
        <link rel="stylesheet" href="{% static 'core/css/pacientes/perfil_paciente.css' %}">
    <link href="https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

{% endblock %}

{% block topbar_title %}Pendências de Nota Fiscal{% endblock %}

{% block content %}
    <div class="content">
        <!-- Header Section -->
        <header>
            <div class="header-content">
                <div class="patient-info">
                    <div class="patient-avatar">
                    {% if paciente.foto %}
                    <img src="{{ paciente.foto.url }}" alt="Foto de {{ paciente.nome }}">
                    {% else %}
                    <img src="{% static 'core/img/defaultPerfil.png' %}" alt="Sem foto">
                    {% endif %}                    </div>
                    <div>
                        <h1 class="patient-name">{{ paciente.nome }} {{ paciente.sobrenome }}</h1>
                        <p class="patient-id">ID: {{ paciente.id }}</p>
                        <p class="patient-id">
                            Finalidade NF:
                            {% if paciente.nf_imposto_renda %} Imposto de Renda
                            {% elif paciente.nf_reembolso_plano %} Reembolso Plano de Saúde
                            {% elif paciente.nf_nao_aplica %} Não necessita de NF
                            {% else %} Sem finalidade cadastrada. <a class='finalidade_link' href='/pacientes/editar/{{paciente.id}}/'>Cadastre agora!</a>
                            {% endif %}
                            
                        </p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="window.location.href='{% url 'editar_paciente' paciente.id %}'">
                        <i class="fas fa-edit"></i> Editar Dados
                    </button>
                    <button class="btn btn-secondary">
                        <i class="fas fa-plus"></i> Adicionar Observação
                    </button>
                    <button class="btn btn-gray">
                        <i class="fas fa-calendar"></i> Voltar para Agenda
                    </button>
                </div>
            </div>
        </header>

        <div class="grid-container">

            <div class="space-y-6">

                <section class="section">
                    <h2 class="section-title">Dados Cadastrais</h2>
                    <div class="data-grid">
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Nome Completo</label>
                            <p class="font-medium" > {{ paciente.nome }} {{ paciente.sobrenome }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Nome Social</label>
                            <p class="font-medium" > {{ paciente.nomeSocial }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">CPF/RG</label>
                            <p class="font-medium" >{{ paciente.cpf }} / {{paciente.rg }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Data de Nascimento</label>
                            <p class="font-medium" >{{ paciente.data_nascimento }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Idade</label>
                            <p class="font-medium">{{ paciente.idade_formatada}}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Telefone</label>
                            <p class="font-medium" > {{ paciente.telefone }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">WhatsApp</label>
                            <div class="flex items-center gap-2">
                                <p class="font-medium" >{{ paciente.celular }}</p>
 
                            </div>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">E-mail</label>
                            <p class="font-medium" >{{paciente.email}}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Endereço</label>
                            <p class="font-medium" >{{ paciente.endereco_formatado }} </p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Cor/Raça</label>
                            <p class="font-medium" >{{ paciente.get_cor_raca_display }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Sexo/Gênero</label>
                            <p class="font-medium" >{{ paciente.get_sexo_display }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Estado Civil</label>
                            <p class="font-medium" >{{ paciente.get_estado_civil_display }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Profissão</label>
                            <p class="font-medium" >{{ paciente.profissao }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Como nos conheceu?</label>
                            <p class="font-medium" >{{ paciente.get_midia_display }}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Rede Social</label>
                            <p class="font-medium" >{{ paciente.redeSocial }}</p>
                        </div>
                    </div>
                </section>

                <section class="section">
                    <h2 class="section-title">Dados de Atendimento</h2>
                    <div class="data-grid data-grid-3">
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Primeiro Atendimento</label>
                            <p class="font-medium">{% if primeiro_agendamento %} {{primeiro_agendamento|date:"d/m/Y"}} {% else %} Sem registros {% endif %}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Último Atendimento</label>
                            <p class="font-medium">{% if ultimo_agendamento %} {{ultimo_agendamento|date:"d/m/Y"}} {% else %} Sem registros {% endif %}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Status</label>
                            <span class="badge badge-success">{% if paciente.ativo %} Ativo {% else %} Inativo {% endif %}</span>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Frequência Semanal</label>
                            <p class="font-medium">{% if frequencia_semanal %} {{ frequencia_semanal }}x/Semana {% else %} 0x/Semana {% endif %}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Total de Sessões</label>
                            <p class="font-medium">{{quantidade_agendamentos}}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Sessões Faltadas</label>
                            <p class="font-medium">{{quantidade_faltas}}</p>
                        </div>
                        <div class="data-card">
                            <label class="text-sm text-gray-500">Sessões Remarcadas</label>
                            <p class="font-medium">{{quantidade_repostas}}</p>
                        </div>
                    </div>
                </section>

                <section class="section">
                    <h2 class="section-title">Pacotes e Sessões</h2>
                    
                    <div class="mb-6">
                        <h3 class="font-medium text-gray-700 mb-2">Pacote Ativo</h3>
                        {% if pacote_ativo %}
                        <div class="package-card">
                            <div class="package-header">
                                <h4 class="package-title">{{pacote_ativo}} ({{qtd_total}} sessões)</h4>
                                <span class="badge badge-info">{% if pacote_ativo.ativo %} Ativo {% else %} Inativo {% endif %}</span>
                            </div>
                            <p class="package-description"></p>
                            
                            <div class="progress-container">
                                <div class="progress-info">
                                    <span>Progresso: {{sessao_atual}}/{{qtd_total}} sessões</span>
                                    <span>{{progresso}}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: {{progresso}}%"></div>
                                </div>
                            </div>
                            
                            <div class="data-grid">
                                <div>
                                    <p class="text-gray-500 text-sm">Início</p>
                                    <p class="font-medium">{{data_inicio_pacote_ativo}}</p>
                                </div>
                                <div>
                                    <p class="text-gray-500 text-sm">Vencimento</p>
                                    <p class="font-medium">Sem vencimento</p>
                                </div>
                            </div>
                        </div>
                        {% else %}
                            <h4 class="package-title text-sm">Não há informações no momento.</h4>    
                        {% endif %}
                    </div>
                    
                    <h3 class="font-medium text-gray-700 mb-2">Histórico de Pacotes</h3>
                    
                    <div class="space-y-3">
                    {% if pacotes_dados %}
                        {% for pacote in pacotes_dados %}
                            <div class="note-card">
                                <div class="package-header">
                                    <h4 class="package-title text-sm">
                                        {{ pacote.pacote.servico.nome }} ({{ pacote.qtd_total }} sessões)
                                    </h4>
                                    <span class="badge {% if item.status == 'Ativo' %}badge-success{% else %}badge-gray{% endif %}">
                                        {{ pacote.status }}
                                    </span>
                                </div>
                    
                                <p class="text-gray-600 text-sm mb-1">
                                    {{ pacote.data_inicio|date:"d/m/Y" }}
                                    {% if pacote.data_fim %}
                                        - {{ pacote.data_fim|date:"d/m/Y" }}
                                    {% endif %}
                                </p>
                    
                                <p class="text-gray-600 text-sm">
                                    {{ pacote.sessoes_realizadas }}/{{ pacote.qtd_total }} sessões realizadas
                                </p>
                            </div>
                        {% endfor %}
                    {% else %}
                     <h4 class="package-title text-sm">Não há informações no momento.</h4>
                     {% endif %}
                    </div>
                    
                </section>

                <section class="section">
                
                    <h2 class="section-title">Serviços Mais Contratados</h2>
                    <div class="data-grid">
                    {% if mais_contratados %}
                        {% for especialidade in mais_contratados %}
                        <div class="note-card">
                            
                            <div class="package-header">
                                <h3 class="package-title text-sm"> {{especialidade.nome}}</h3>
                                <span class="badge badge-info" style= ' color:white; background:{{especialidade.cor}}'>{% if especialidade.total == 1 %}{{especialidade.total}} sessão {% else %} {{especialidade.total}} sessões {% endif %}</span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <h4 class="package-title text-sm">Não há informações no momento.</h4>    
                    {% endif %}

                    </div>
                </section>

                <section class="section">
                    <h2 class="section-title">Prontuários • Evoluções • Avaliações</h2>
                    <div class='section-hist'>
                    <div class='div-section'>
                        <h2 class="section-subtitle">Prontuários</h2>
                        <a  href="{% url 'visualizar_prontuarios_paciente' paciente.id %}" class="ver-tudo">Ver todos<i class="fa-solid fa-arrow-right"></i></a>

                    </div>
                        <div class="space-y-3">
                        {% if prontuarios %}
                            {% for prontuario in prontuarios %}
                                <div class="note-card">
                                    <div class="package-header">
                                        <h4 class="package-title text-sm">
                                            Data consulta: {{ prontuario.agendamento.data }}
                                        </h4>
                                        <span class="badge badge-gray"> <i class="fas fa-hashtag"></i>{{ prontuario.agendamento.id }}
                                        </span>
                                    </div>
                        
                                    <div class='prontuario-detalhes'>
                                        <div >
                                            <p class="text-gray-600 text-sm">
                                                Criado por: {{ prontuario.profissional.nome }} {{ prontuario.profissional.sobrenome }}
                                            </p>
                                            <p class="text-gray-600 text-sm">
                                                Criado em: {{ prontuario.data_criacao|date:"d/m/Y" }} às {{ prontuario.data_criacao|time:"H:i" }}
                                            </p>
                                        </div>
                                        <button type="button"
                                                onclick="renderizarDetalhesProntuario('{{ prontuario.agendamento.id }}')"
                                                data-tooltip="Ver Prontuário"
                                                class="ver-detalhes btn-sem-estilo">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                        

                                </div>
                                
                            {% endfor %}
                            {% else %}
                            <h4 class="package-title text-sm">Não há informações no momento.</h4>
                            {% endif %}
                            
                        </div>
                    </div>
                    <div class='section-hist'>
                        <div class='div-section'>
                        <h2 class="section-subtitle">Evoluções</h2>
                        <a href="{% url 'visualizar_evolucoes_paciente' paciente.id %}" class="ver-tudo">Ver todos<i class="fa-solid fa-arrow-right"></i></a>

                    </div>
                        <div class="space-y-3">
                        {% if evolucoes %}
                            {% for evolucao in evolucoes %}
                                <div class="note-card">
                                    <div class="package-header">
                                        <h4 class="package-title text-sm">
                                            Data consulta: {{ evolucao.agendamento.data|date:"d/m/Y" }}
                                        </h4>
                                        <span class="badge badge-gray">
                                            <i class="fas fa-hashtag"></i>{{ evolucao.agendamento.id }}
                                        </span>
                                    </div>
    
                                    <div class='prontuario-detalhes'>
                                        <div >
                                            <p class="text-gray-600 text-sm">
                                                Criado por: {{ prontuario.profissional.nome }} {{ prontuario.profissional.sobrenome }}
                                            </p>
                                            <p class="text-gray-600 text-sm">
                                                Criado em: {{ prontuario.data_criacao|date:"d/m/Y" }} às {{ prontuario.data_criacao|time:"H:i" }}
                                            </p>
                                        </div>
                                        <button type="button"
                                                onclick="renderizarDetalhesEvolucao('{{ evolucao.agendamento.id }}')"
                                                data-tooltip="Ver Evolução"
                                                class="ver-detalhes btn-sem-estilo">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                        <h4 class="package-title text-sm">Não há informações no momento.</h4>
                        {% endif %}
                        </div>
                     </div>
                    <div class='section-hist'>
                        <div class='div-section'>
                            <h2 class="section-subtitle">Avaliações Fisioterapêuticas</h2>
                            <a href="{% url 'visualizar_avaliacoes_paciente' paciente.id %}" class="ver-tudo">Ver todos<i class="fa-solid fa-arrow-right"></i></a>

                        </div>                        
                        <div class="space-y-3">
                        {% if avaliacoes %}
                            {% for avaliacao in avaliacoes %}
                                <div class="note-card">
                                    <div class="package-header">
                                        <h4 class="package-title text-sm">
                                            Data consulta: {{ avaliacao.agendamento.data|date:"d/m/Y" }}
                                        </h4>
                                        <span class="badge badge-gray">
                                            <i class="fas fa-hashtag"></i>{{ avaliacao.agendamento.id }}
                                        </span>
                                    </div>
    
                                    <div class='prontuario-detalhes'>
                                        <div >
                                            <p class="text-gray-600 text-sm">
                                                Criado por: {{ avaliacao.profissional.nome }} {{ avaliacao.profissional.sobrenome }}
                                            </p>
                                            <p class="text-gray-600 text-sm">
                                                Criado em: {{ avaliacao.data_criacao|date:"d/m/Y" }} às {{ avaliacao.data_criacao|time:"H:i" }}
                                            </p>
                                        </div>
                                        <button type="button"
                                                onclick="renderizarDetalhesAvaliacao('{{ avaliacao.agendamento.id }}')"
                                                data-tooltip="Ver Avaliação"
                                                class="ver-detalhes btn-sem-estilo">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                        <h4 class="package-title text-sm">Não há informações no momento.</h4>
                        {% endif %}
                        </div>
                     </div>
                </section>
                
                <section class="section">
                
                    <h2 class="section-title">Histórico de Status</h2>
                    <div class="data-grid">
                    {% if historico_status %}
                        {% for status in historico_status %}
                        <div class="note-card">
                            
                            <div class="package-header">
                                <h3 class="package-title text-sm"> {{status.mes}}/{{status.ano}}</h3>
                                <h3 class="package-title text-sm"> </h3>
                                <td>
                                    {% if status.status == "primeiro_mes" %}
                                        <span class="badge badge-primeiro_mes">1º Mês</span>
                                    {% elif status.status == "premium" %}
                                        <span class="badge badge-premium">Premium</span>
                                    {% elif status.status == "vip" %}
                                        <span class="badge badge-vip">VIP</span>
                                    {% elif status.status == "plus" %}
                                        <span class="badge badge-plus">Plus</span>
                                    {% else %}
                                        <span class="badge badge-indefinido">Indefinido</span>
                                    {% endif %}
                                </td>

                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <h4 class="package-title text-sm">Não há informações no momento.</h4>    
                    {% endif %}

                    </div>
                </section>

                <section class="section">
                    <h2 class="section-title">Formulários Respondidos</h2>
                    <div class="data-grid">
                    {% if respostas_formularios %}
                        {% for resposta in respostas_formularios %}
                        <div class="data-card">
                            <div class="form-header">
                                <h3 class="package-title text-sm">{{ resposta.formulario.titulo }}</h3>
                                <div class='form-link'>
                                    <span class="badge badge-info">
                                        Respondido em {{ resposta.enviado_em|date:"d/m/Y" }} às {{ resposta.enviado_em|date:"H:i" }}
                                    </span>
                                    <a href="{% url 'visualizar_respostas' resposta.id %}" data-tooltip='Ver Respostas'  class="ver-detalhes"><i class="fas fa-eye"></i></a>                                
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <h4 class="package-title text-sm">Não há respostas no momento.</h4>    
                    {% endif %}
                    </div>
                </section>

            </div>

            <div class="space-y-6">
                <section class="section">
                    <h2 class="section-title">Vínculos Familiares</h2>

                    <ul class="timeline space-y-4">

                        {% if vinculos_dependente %}
                            {% for vinculo in vinculos_dependente %}
                                <li class="timeline-item">
                                    <div class="timeline-dot"></div>

                                    <div class="timeline-content">
                                        <div class="timeline-header">
                                            <div>
                                                <h3 class="timeline-title">
                                                    {{ paciente.nome }} {{ paciente.sobrenome }}
                                                </h3>

                                                <p class="timeline-date text-sm">
                                                    {% if vinculo.tipo == 'pai' or vinculo.tipo == 'mae' %}
                                                        Filho(a) de
                                                    {% elif vinculo.tipo == 'avo' %}
                                                        Neto(a) de
                                                    {% elif vinculo.tipo == 'tio' %}
                                                        Sobrinho(a) de
                                                    {% elif vinculo.tipo == 'irmao' %}
                                                        Irmão(ã) de
                                                    {% elif vinculo.tipo == 'conjuge' %}
                                                        Cônjuge de
                                                    {% elif vinculo.tipo == 'responsavel_legal' %}
                                                        Sob responsabilidade de
                                                    {% else %}
                                                        Vinculado(a) a
                                                    {% endif %}
                                                    {{ vinculo.familiar.nome }} {{ vinculo.familiar.sobrenome }}
                                                </p>
                                            </div>

                                            <span class="badge badge-info">
                                                {{ vinculo.get_tipo_display }}
                                            </span>
                                        </div>

                                        <p class="timeline-meta text-sm">
                                            Responsável / Familiar
                                        </p>

                                        <p class="timeline-note">
                                            <a href="{% url 'ficha_paciente' vinculo.familiar.id %}">
                                                Ver ficha de {{ vinculo.familiar.nome }}
                                            </a>
                                        </p>
                                    </div>
                                </li>
                            {% endfor %}

                        {% elif vinculos_responsavel %}
                        {% for vinculo in vinculos_responsavel %}
                            <li class="timeline-item">
                            <div class="timeline-dot"></div>

                            <div class="timeline-content">
                                <div class="timeline-header">
                                <div>
                                    <h3 class="timeline-title">
                                    {{ vinculo.paciente.nome }} {{ vinculo.paciente.sobrenome }}
                                    </h3>

                                    <p class="timeline-date text-sm">
                                    {% if vinculo.tipo == 'pai' or vinculo.tipo == 'mae' %}
                                        Filho(a)
                                    {% elif vinculo.tipo == 'avo' %}
                                        Neto(a)
                                    {% elif vinculo.tipo == 'tio' %}
                                        Sobrinho(a)
                                    {% elif vinculo.tipo == 'irmao' %}
                                        Irmão(ã)
                                    {% elif vinculo.tipo == 'conjuge' %}
                                        Cônjuge
                                    {% elif vinculo.tipo == 'responsavel_legal' %}
                                        Dependente legal
                                    {% else %}
                                        Familiar
                                    {% endif %}
                                    </p>
                                </div>

                                <span class="badge badge-success">
                                    {% if vinculo.tipo == 'pai' or vinculo.tipo == 'mae' %}
                                    Filho(a)
                                    {% elif vinculo.tipo == 'avo' %}
                                    Neto(a)
                                    {% elif vinculo.tipo == 'tio' %}
                                    Sobrinho(a)
                                    {% elif vinculo.tipo == 'irmao' %}
                                    Irmão(ã)
                                    {% elif vinculo.tipo == 'conjuge' %}
                                    Cônjuge
                                    {% elif vinculo.tipo == 'responsavel_legal' %}
                                    Dependente legal
                                    {% else %}
                                    Familiar
                                    {% endif %}
                                </span>
                                </div>

                                <p class="timeline-meta text-sm">
                                Dependente
                                </p>

                                <p class="timeline-note">
                                <a href="{% url 'ficha_paciente' vinculo.paciente.id %}">
                                    Ver ficha de {{ vinculo.paciente.nome }}
                                </a>
                                </p>
                            </div>
                            </li>
                        {% endfor %}
                        
                        {% else %}
                            <h3 class="professional-name">
                                Não há vínculos familiares cadastrados.
                            </h3>
                        {% endif %}

                    </ul>
                </section>

                <section class="section">
                    <h2 class="section-title">Profissionais que mais atenderam</h2>
                    <h2 class="section-subtitle">Como Condutor da Sessão</h2>
                    <div class="space-y-4">
                    {% if profissional_principal %}
                        {% for profissional in profissional_principal %}
                            <div class="professional-card">
                                <div class="professional-avatar">
                                    {% if profissional.profissional_1__foto %}
                                        <img src="{{ profissional.foto_url }}" alt="Foto de {{ profissional.nome }}" width="150">
                                    {% else %}
                                        <div class="profile-placeholder">
                                            {{ profissional.nome|slice:":1" }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div>
                                    <h3 class="professional-name">{{profissional.profissional_1__nome}}</h3>
                                    <p class="professional-sessions">{{profissional.total}} atendimentos | {{profissional.tempo_sessao}} totais</p>
                            
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <h3 class="professional-name">Não há informações no momento.</h3>
                    {% endif %}
                        <h2 class="section-subtitle">Como Apoio na Sessão</h2>
                    {% if profissional_auxiliar %}
                    {% for profissional in profissional_auxiliar %}
                        <div class="professional-card">
                            <div class="professional-avatar">
                                {% if profissional.profissional_1__foto %}
                                    <img src="{{ profissional.foto_url }}" alt="Foto de {{ profissional.nome }}" width="150">
                                {% else %}
                                    <div class="profile-placeholder">
                                        {{ profissional.nome|slice:":1" }}
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                <h3 class="professional-name">{{profissional.profissional_2__nome}}</h3>
                                <p class="professional-sessions">{{profissional.total}} atendimentos | {{profissional.tempo_sessao}} totais</p>
                            </div>
                        </div>
                     {% endfor %}
                    {% else %}
                        <h3 class="professional-name">Não há informações no momento.</h3>
                    {% endif %}
                    </div>
                </section>

                <section class="section">
                    <h2 class="section-title">Histórico de Agendamentos</h2>
                    <ul class="timeline space-y-4">
                    {% if tres_ultimos_agendamentos %}
                    {% for agendamento in tres_ultimos_agendamentos %}
                    
                        <li class="timeline-item">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                            
                                <div class="timeline-header">
                                    <div>
                                        <h3 class="timeline-title"> {{agendamento.paciente.nome}} </h3>
                                        <p class="timeline-date text-sm">{{agendamento.data|date:"d/m/Y"}} - {{ agendamento.hora_inicio|time:"H:i" }} / {{ agendamento.hora_fim|time:"H:i" }}</p>
                                    </div>
                                    <span class="badge badge-success">{{agendamento.get_status_display}}</span>
                                </div>
                                <p class="timeline-meta text-sm">{{agendamento.profissional_1.nome}}</p>
                                {% if not agendamento.observacoes %}
                                <p class="timeline-note">Paciente ainda não possui observações nessa consulta.</p>
                                {% else %}
                                <p class="timeline-note">{{agendamento.observacoes}}</p>
                                {%endif%}
                            </div>
                        </li>

                    {% endfor %}

                        <button style='width: 100%;' class="btn btn-primary">
                            Ver histórico completo
                        </button>
                    {% else %}
                        <h3 class="professional-name">Não há informações no momento.</h3>
                    {% endif %}
                    </ul>
                </section>

                <section class="section">
                    <h2 class="section-title">Prontuários</h2>
                    <div class="space-y-3">
                    {% if ultimos_agendamentos %}
                    <form style='display:none' id="obs-container" method="POST" action="">
                        {% csrf_token %}
                        
                        <div  class="observacao-div space-y-2">
                            <select name="agendamento_id" id="agendamento_id" required>
                                <option disabled selected>-- Selecione o agendamento --</option>
                                {% for agendamento in ultimos_agendamentos %}
                                    <option value="{{ agendamento.id }}">
                                        {{ agendamento.data|date:"d/m/Y" }} - {{ agendamento.hora_inicio|time:"H:i" }} com {{ agendamento.profissional_1.nome }}
                                    </option>
                                {% endfor %}
                            </select>
                    
                            <textarea name="observacao" id="observacao" rows="4" required></textarea>
 
                        </div>
                    

                    <div style='display:flex; width: 100%; gap: 1em; margin-top:1em;'>
                    <button  id="btnCancelObs" style="display: block; width: 50%;" onclick="toggleObservacao()" class="btn btn-primary">
                            Cancelar
                        </button>
                        <button  type="submit" style=' display:none; width:50%' id='btnSave' class="btn btn-primary">Salvar</button>
                    </div>
                    </form>
                    <button  id="btnToggleObs" onclick="toggleObservacao()" class="btn btn-primary">Adicionar nova observação</button>


                    {% for agendamento in ultimos_agendamentos %}
                    {% if agendamento.observacoes %}
                    <div class="note-card">
                    {% if agendamento.observacoes %}
                        <div class="note-header">
                            {% if agendamento.observacao_autor %}
                            <p class="note-author"> {{ agendamento.observacao_autor.get_full_name|default:agendamento.observacao_autor.username }}</p>
                            {% else %}
                            <p class="note-author">Sem usuário</p>
                            {% endif %}
                            <p class="note-date">{{ agendamento.observacao_data|date:"d/m/Y" }}</p>
                            </div>
                            <p class="note-content">{{agendamento.observacoes}}</p>
                    </div>
                        {% else %}
                             <h3 class="professional-name">Não há informações no momento.</h3>
                        {% endif %}
                        {% endif %}
                        {% endfor %}
                
                    {% else %}
                        <h3 class="professional-name">Não há informações no momento.</h3>
                    {% endif %}

                    </div>
                </section>

                <section class="section">
                    <h2 class="section-title">Dados Financeiros</h2>
                    <div class="space-y-4">
                        <div>
                            <p class="section-subtitle">Total pago</p>
                            <p class="financial-total green">{{soma_pagamentos}}</p>
                        </div>
                        <div>
                            <p class="section-subtitle">Total em aberto</p>
                            {% if total_debito %}
                            <p class="financial-total red">R$ {{total_debito}}</p>
                            {% else %}
                            <p class="font-medium text-green-600">Nenhum débito pendente</p>
                            {% endif %}
                        </div>
                        <div class="payment-ranking">
                            <p class="financial-label label-title">Ranking de Pagamentos</p>
                            <div class="table-wrapper">
                                <table class="ranking-table">
                                    <thead>
                                        <tr>
                                            <th>Ícone</th>
                                            <th>Pagamento</th>
                                            <th>Quantidade</th>
                                            <th>Porcentagem</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if top_forma_pagamento %}
                                        {% for pagamento in top_forma_pagamento %}
                                        <tr>
                                            <td>
                                                <div class="{% if pagamento.forma_pagamento == 'pix' %}payment-icon blue
                                                          {% elif pagamento.forma_pagamento == 'dinheiro' %}payment-icon green
                                                          {% elif pagamento.forma_pagamento == 'credito' %}payment-icon yellow
                                                          {% elif pagamento.forma_pagamento == 'debito' %}payment-icon purple
                                                          {% else %}payment-icon red{% endif %}">
                                                    <i class="{% if pagamento.forma_pagamento == 'pix' %}fas fa-qrcode blue
                                                             {% elif pagamento.forma_pagamento == 'dinheiro' %}fas fa-money-bill-wave green
                                                             {% elif pagamento.forma_pagamento == 'credito' %}fas fa-credit-card yellow
                                                             {% elif pagamento.forma_pagamento == 'debito' %}fas fa-money-check purple
                                                             {% else %}fas fa-question-circle red{% endif %}"></i> 
                                                </div>
                                            </td>
                                            <td>{{ pagamento.forma_pagamento|title }}</td>
                                            <td>{{ pagamento.quantidade }}x</td>
                                            <td>{{ pagamento.porcentagem }}%</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    {% else %}
                                    <tr>
                                        <td colspan="4" >Não há informações no momento</td>
                                    </tr>
                                {% endif %}
                                </table>
                            </div>
                        </div>
                

                        
                        <div class="payment-list">
                            <h3 class="label-title">Últimos pagamentos</h3>
                            <div class="table-wrapper">
                                <table class="ranking-table">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Forma de Pagamento</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if ultimos_pagamentos %}
                                            {% for pagamento in ultimos_pagamentos %}
                                            <tr>
                                                <td>{{ pagamento.data|date:'d/m/Y' }}</td>
                                                <td>{{ pagamento.get_forma_pagamento_display }}</td>
                                                <td class="green">R$ {{ pagamento.valor }}</td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="4" >Não há informações no momento</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <div class="quick-actions">
            <button class="action-btn action-btn-primary">
                <i class="fas fa-calendar-plus"></i>
            </button>
            <button class="action-btn action-btn-success">
                <i class="fab fa-whatsapp"></i>
            </button>
            <button class="action-btn action-btn-instagram" onclick="window.open('https://instagram.com/{{ paciente.redeSocial }}', '_blank')">
                <i class="fab fa-instagram"></i>
            </button>
            <button  class="action-btn action-btn-dark" onclick="abrirFicha('{% url 'ficha_paciente' paciente.id %}')">
                <i class="fas fa-file-pdf"></i>
            </button>
        </div>
    </div>
 
{% include "core/partials/alertas.html" %}
{% include "core/partials/_view_prontuario_modal.html" %}
{% endblock %}

{% block scripts %}
<script>


    const btnToggleObs = document.getElementById('btnToggleObs');
    const btnCancelObs = document.getElementById('btnCancelObs');
    const obsContainer = document.getElementById('obs-container');
    const btnSave = document.getElementById('btnSave');

    function toggleObservacao() {
        const isVisible = obsContainer.style.display === 'block';

        if (isVisible) {
            // Ocultar observação
            obsContainer.style.display = 'none';
            btnSave.style.display = 'none';
            btnToggleObs.style.display = 'inline-block';
        } else {
            // Mostrar observação
            obsContainer.style.display = 'block';
            btnSave.style.display = 'block';
            btnToggleObs.style.display = 'none';
        }
    }

</script>
  
<script src="https://unpkg.com/imask"></script>

<script src="{% static '/core/js/pacientes/base.js' %}"></script>
<script src="{% static '/core/js/prontuarios/formularios.js' %}"></script>
<script src="{% static '/core/js/base/base.js' %}"></script>
<script src="{% static '/core/js/pacientes/cep.js' %}"></script>
 
{% endblock %}