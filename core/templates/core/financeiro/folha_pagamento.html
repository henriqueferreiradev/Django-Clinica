{% extends 'core/base.html' %}
{% load static %}
{% block title %}Comissões e Folha de Pagamento - Ponto de Equilíbrio{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/tema.css' %}">
<link rel="stylesheet" href="{% static 'core/css/financeiro/folha_pagamento.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
 
{% endblock %}

{% block topbar_title %}<span class="text">Comissões e Folha de Pagamento</span>{% endblock %}

{% block content %}
{% include "core/partials/_confirm_modal.html" %}
<div class="content">
    <div class="header">
        <h2><i class="fas fa-users me-2"></i> </h2>
        <div class="buttons">
            <button class="btn btn-primary me-2" id="btnLancarHolerite">
                <i class="fas fa-file-invoice me-1"></i> Lançar Holerites
            </button>
            <button class="btn btn-outline-secondary">
                <i class="fas fa-print me-1"></i> Imprimir
            </button>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="filter-card mb-4">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Período</label>
                <select class="form-select">
                    <option>Este Mês</option>
                    <option>Mês Anterior</option>
                    <option>Trimestre</option>
                    <option>Personalizado</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">De</label>
                <input type="date" class="form-control" value="2023-05-01">
            </div>
            <div class="col-md-3">
                <label class="form-label">Até</label>
                <input type="date" class="form-control" value="2023-05-31">
            </div>
            <div class="col-md-3 d-flex align-items-center" style="align-items: flex-end;">
                <button class="btn btn-primary w-100"><i class="fas fa-filter me-1"></i> Filtrar</button>
            </div>
        </div>
    </div>
    
    <!-- Cards Resumo -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card card-comissao card-pendente">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Comissões Pendentes</h6>
                            <h3 class="card-title text-warning">R$ 8.400,00</h3>
                            <small class="text-muted">15 profissionais</small>
                        </div>
                        <i class="fas fa-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-comissao card-pago">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Comissões Pagas</h6>
                            <h3 class="card-title text-success">R$ 12.600,00</h3>
                            <small class="text-muted">25 profissionais</small>
                        </div>
                        <i class="fas fa-check-circle text-success" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-comissao card-total">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Total Folha</h6>
                            <h3 class="card-title text-primary">R$ 21.000,00</h3>
                            <small class="text-muted">Salários + Comissões</small>
                        </div>
                        <i class="fas fa-dollar-sign text-primary" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gráficos -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card card-comissao">
                <div class="card-body">
                    <h5 class="card-title">Distribuição de Comissões</h5>
                    <div class="chart-container">
                        <canvas id="comissoesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card card-comissao">
                <div class="card-body">
                    <h5 class="card-title">Evolução Mensal</h5>
                    <div class="chart-container">
                        <canvas id="evolucaoChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabela de Comissões -->
    <div class="card card-comissao mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Comissões por Profissional</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2"><i class="fas fa-download me-1"></i> Exportar</button>
                    <button class="btn btn-sm btn-outline-secondary"><i class="fas fa-filter me-1"></i> Filtrar</button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Profissional</th>
                            <th>Especialidade</th>
                            <th class="text-end">Atendimentos</th>
                            <th class="text-end">Valor Bruto</th>
                            <th class="text-end">% Comissão</th>
                            <th class="text-end">Valor Comissão</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Profissional 1 -->
                        <tr class="status-pendente">
                            <td>Dra. Ana Silva</td>
                            <td><span class="badge bg-primary badge-especialidade">Fisioterapia</span></td>
                            <td class="text-end">42</td>
                            <td class="text-end">R$ 8.400,00</td>
                            <td class="text-end">40%</td>
                            <td class="text-end">R$ 3.360,00</td>
                            <td><span class="badge bg-warning text-dark">Pendente</span></td>
                            <td>
                                <button class="btn btn-sm btn-success me-1" title="Pagar"><i class="fas fa-money-bill"></i></button>
                                <button class="btn btn-sm btn-outline-primary" title="Detalhes"><i class="fas fa-eye"></i></button>
                            </td>
                        </tr>
                        <!-- Profissional 2 -->
                        <tr class="status-pago">
                            <td>Dr. Carlos Mendes</td>
                            <td><span class="badge bg-success badge-especialidade">Nutrição</span></td>
                            <td class="text-end">35</td>
                            <td class="text-end">R$ 7.000,00</td>
                            <td class="text-end">40%</td>
                            <td class="text-end">R$ 2.800,00</td>
                            <td><span class="badge bg-success">Pago</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" title="Recibo"><i class="fas fa-receipt"></i></button>
                            </td>
                        </tr>
                        <!-- Profissional 3 -->
                        <tr class="status-pendente">
                            <td>Dra. Juliana Costa</td>
                            <td><span class="badge bg-info badge-especialidade">Psicologia</span></td>
                            <td class="text-end">28</td>
                            <td class="text-end">R$ 5.600,00</td>
                            <td class="text-end">40%</td>
                            <td class="text-end">R$ 2.240,00</td>
                            <td><span class="badge bg-warning text-dark">Pendente</span></td>
                            <td>
                                <button class="btn btn-sm btn-success me-1" title="Pagar"><i class="fas fa-money-bill"></i></button>
                                <button class="btn btn-sm btn-outline-primary" title="Detalhes"><i class="fas fa-eye"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Folha de Pagamento -->
    <div class="card card-comissao">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Folha de Pagamento</h5>
                <div>
                    <button class="btn btn-sm btn-primary me-2"><i class="fas fa-money-bill me-1"></i> Processar Folha</button>
                    <button class="btn btn-sm btn-outline-secondary"><i class="fas fa-file-pdf me-1"></i> Gerar Holerites</button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Funcionário</th>
                            <th>Cargo</th>
                            <th class="text-end">Salário Base</th>
                            <th class="text-end">Comissões</th>
                            <th class="text-end">Descontos</th>
                            <th class="text-end">Benefícios</th>
                            <th class="text-end">Total</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Funcionário 1 -->
                        <tr>
                            <td>Maria Souza</td>
                            <td>Recepcionista</td>
                            <td class="text-end">R$ 2.500,00</td>
                            <td class="text-end">R$ 0,00</td>
                            <td class="text-end">- R$ 200,00</td>
                            <td class="text-end">R$ 300,00</td>
                            <td class="text-end">R$ 2.600,00</td>
                            <td><span class="badge bg-success">Pago</span></td>
                        </tr>
                        <!-- Funcionário 2 -->
                        <tr>
                            <td>João Oliveira</td>
                            <td>Secretário</td>
                            <td class="text-end">R$ 2.200,00</td>
                            <td class="text-end">R$ 0,00</td>
                            <td class="text-end">- R$ 180,00</td>
                            <td class="text-end">R$ 300,00</td>
                            <td class="text-end">R$ 2.320,00</td>
                            <td><span class="badge bg-success">Pago</span></td>
                        </tr>
                        <!-- Profissional 1 -->
                        <tr>
                            <td>Dra. Ana Silva</td>
                            <td>Fisioterapeuta</td>
                            <td class="text-end">R$ 3.000,00</td>
                            <td class="text-end">R$ 3.360,00</td>
                            <td class="text-end">- R$ 500,00</td>
                            <td class="text-end">R$ 500,00</td>
                            <td class="text-end">R$ 6.360,00</td>
                            <td><span class="badge bg-warning text-dark">Pendente</span></td>
                        </tr>
                    </tbody>
                    <tfoot class="table-secondary">
                        <tr>
                            <th colspan="6">Total da Folha</th>
                            <th class="text-end">R$ 11.280,00</th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Folha de Pagamento -->
<div class="modal" id="modalFolhaPagamento">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Lançamento de Folha - <span id="monthYear">Julho/2025</span> - <span id="employeeName">Dra. Ana Silva</span></h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Informações Básicas -->
            <div class="form-grid">
                <div class="form-group">
                    <label for="monthYearSelect">Mês/Ano</label>
                    <select id="monthYearSelect" class="form-select">
                        <option value="1/2025">Janeiro/2025</option>
                        <option value="2/2025">Fevereiro/2025</option>
                        <option value="3/2025">Março/2025</option>
                        <option value="4/2025">Abril/2025</option>
                        <option value="5/2025">Maio/2025</option>
                        <option value="6/2025">Junho/2025</option>
                        <option value="7/2025" selected>Julho/2025</option>
                        <option value="8/2025">Agosto/2025</option>
                        <option value="9/2025">Setembro/2025</option>
                        <option value="10/2025">Outubro/2025</option>
                        <option value="11/2025">Novembro/2025</option>
                        <option value="12/2025">Dezembro/2025</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="employeeNameInput">Colaborador</label>
                    <input type="text" id="employeeNameInput" class="form-control" value="Dra. Ana Silva">
                </div>
                <div class="form-group">
                    <label for="hourlyRate">Valor/Hora (R$)</label>
                    <input type="text" id="hourlyRate" class="form-control currency-input" value="R$ 150,00">
                </div>
            </div>

            <!-- Observações -->
            <div class="form-group">
                <label for="observations">Observações</label>
                <textarea id="observations" class="form-control" rows="2"></textarea>
            </div>

            <!-- Proventos -->
            <h4 class="section-title">Proventos</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label for="workedHours">Horas trabalhadas</label>
                    <input type="text" id="workedHours" class="form-control time-input" value="160:00">
                </div>
                <div class="form-group">
                    <label for="workedHoursValue">Horas trabalhadas em valores (R$)</label>
                    <input type="text" id="workedHoursValue" class="form-control currency-input" readonly>
                </div>
                <div class="form-group">
                    <label for="transportDays">Dias de passagens (quantidade)</label>
                    <input type="number" id="transportDays" class="form-control" min="0">
                </div>
                <div class="form-group">
                    <label for="thirteenthFirst">13º – 1ª parcela (R$)</label>
                    <input type="text" id="thirteenthFirst" class="form-control currency-input">
                </div>
                <div class="form-group">
                    <label for="thirteenthSecond">13º – 2ª parcela (R$)</label>
                    <input type="text" id="thirteenthSecond" class="form-control currency-input">
                </div>
                <div class="form-group">
                    <label for="referralCommission">Comissão por indicação (R$)</label>
                    <input type="text" id="referralCommission" class="form-control currency-input">
                </div>
                <div class="form-group">
                    <label for="vacationBonus">Férias + 1/3 (R$)</label>
                    <input type="text" id="vacationBonus" class="form-control currency-input">
                </div>
                <div class="form-group">
                    <label for="costHelp">Ajuda de custo (R$)</label>
                    <input type="text" id="costHelp" class="form-control currency-input">
                </div>
                <div class="form-group">
                    <label for="familySalary">Salário família (R$)</label>
                    <input type="text" id="familySalary" class="form-control currency-input">
                </div>
                <div class="form-group">
                    <label for="bonus">Gratificação (R$)</label>
                    <input type="text" id="bonus" class="form-control currency-input">
                </div>
            </div>
            <div class="total-row">
                <span>TOTAL PROVENTOS (R$)</span>
                <span id="totalEarnings">R$ 0,00</span>
            </div>

            <!-- Descontos -->
            <h4 class="section-title">Descontos</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label for="discount">Desconto (R$)</label>
                    <input type="text" id="discount" class="form-control currency-input">
                </div>
                <div class="form-group">
                    <label for="inssDiscount">Desconto INSS (R$)</label>
                    <input type="text" id="inssDiscount" class="form-control currency-input">
                </div>
                <div class="form-group">
                    <label for="irrfDiscount">IRRF folha (R$)</label>
                    <input type="text" id="irrfDiscount" class="form-control currency-input">
                </div>
                <div class="form-group">
                    <label for="storeDiscount">Desconto lojinha (R$)</label>
                    <input type="text" id="storeDiscount" class="form-control currency-input">
                </div>
                <div class="form-group">
                    <label for="healthPlan">Plano de saúde (R$)</label>
                    <input type="text" id="healthPlan" class="form-control currency-input">
                </div>
                <div class="form-group">
                    <label for="mei">MEI (R$)</label>
                    <input type="text" id="mei" class="form-control currency-input">
                </div>
                <div class="form-group">
                    <label for="otherDiscounts">Outros (adiantamento) (R$)</label>
                    <input type="text" id="otherDiscounts" class="form-control currency-input">
                </div>
            </div>
            <div class="total-row">
                <span>TOTAL DESCONTOS (R$)</span>
                <span id="totalDeductions">R$ 0,00</span>
            </div>

            <!-- Resultado Final -->
            <div class="total-row" style="background-color: #e3f2fd; color: #0d47a1;">
                <span>Total Salário (R$)</span>
                <span id="netSalary">R$ 0,00</span>
            </div>

            <!-- Anexos -->
            <h4 class="section-title">Anexos do mês</h4>
            <div class="form-group">
                <label>Arquivo (PDF ou imagem: JPG/PNG)</label>
                <div class="file-upload" id="fileUploadArea">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                    <p>Clique para selecionar ou arraste um arquivo</p>
                    <input type="file" id="fileUpload" style="display: none;" accept=".pdf,.jpg,.jpeg,.png">
                </div>
                <div class="file-info" id="fileInfo">
                    <div>
                        <span id="fileName"></span>
                        <small id="fileSize"></small>
                    </div>
                    <button type="button" id="removeFileBtn" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-times"></i> Remover
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" id="cancelBtn">Cancelar</button>
            <button class="btn btn-primary" id="saveBtn">Salvar</button>
            <button class="btn btn-success" id="saveAndGenerateBtn">Salvar e Gerar Comprovante</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
    // Gráfico de Distribuição de Comissões
    const comCtx = document.getElementById('comissoesChart').getContext('2d');
    const comChart = new Chart(comCtx, {
        type: 'doughnut',
        data: {
            labels: ['Fisioterapia', 'Nutrição', 'Psicologia', 'Educação Física', 'Outros'],
            datasets: [{
                data: [3360, 2800, 2240, 1600, 1000],
                backgroundColor: [
                    'rgba(13, 110, 253, 0.7)',
                    'rgba(25, 135, 84, 0.7)',
                    'rgba(13, 202, 240, 0.7)',
                    'rgba(255, 193, 7, 0.7)',
                    'rgba(108, 117, 125, 0.7)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                }
            }
        }
    });

    // Gráfico de Evolução Mensal
    const evoCtx = document.getElementById('evolucaoChart').getContext('2d');
    const evoChart = new Chart(evoCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai'],
            datasets: [
                {
                    label: 'Comissões',
                    data: [8000, 8500, 9200, 10500, 11000],
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Folha de Pagamento',
                    data: [15000, 15500, 16000, 18000, 21000],
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    mode: 'index',
                    intersect: false,
                },
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Controle do Modal de Folha de Pagamento
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('modalFolhaPagamento');
        const btnAbrir = document.getElementById('btnLancarHolerite');
        const btnFechar = document.querySelector('.modal-close');
        const btnCancelar = document.getElementById('cancelBtn');
        
        // Abrir modal
        btnAbrir.addEventListener('click', function() {
            modal.classList.add('show');
            calculateTotals();
        });
        
        // Fechar modal
        btnFechar.addEventListener('click', function() {
            modal.classList.remove('show');
        });
        
        btnCancelar.addEventListener('click', function() {
            modal.classList.remove('show');
        });
        
        // Fechar modal clicando fora dele
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.classList.remove('show');
            }
        });
        
        // Máscaras para os campos
        $('.currency-input').mask('R$ #.##0,00', {reverse: true});
        $('.time-input').mask('00:00');
        
        // Upload de arquivo
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileUpload');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const removeFileBtn = document.getElementById('removeFileBtn');
        
        fileUploadArea.addEventListener('click', function() {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileInfo.style.display = 'flex';
            }
        });
        
        removeFileBtn.addEventListener('click', function() {
            fileInput.value = '';
            fileInfo.style.display = 'none';
        });
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Calcular valor das horas trabalhadas
        const workedHoursInput = document.getElementById('workedHours');
        const hourlyRateInput = document.getElementById('hourlyRate');
        const workedHoursValueInput = document.getElementById('workedHoursValue');
        
        function calculateWorkedHoursValue() {
            const hoursStr = workedHoursInput.value;
            const rateStr = hourlyRateInput.value;
            
            if (hoursStr && rateStr) {
                // Parse hours (HH:MM)
                const [hours, minutes] = hoursStr.split(':').map(Number);
                const totalHours = hours + (minutes / 60);
                
                // Parse rate (R$ X.XXX,XX)
                const rate = parseFloat(rateStr.replace('R$ ', '').replace('.', '').replace(',', '.')) || 0;
                
                // Calculate value
                const value = totalHours * rate;
                
                // Format and display
                workedHoursValueInput.value = 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
        }
        
        workedHoursInput.addEventListener('input', calculateWorkedHoursValue);
        hourlyRateInput.addEventListener('input', calculateWorkedHoursValue);
        
        // Calcular totais
        function calculateTotals() {
            let totalEarnings = 0;
            let totalDeductions = 0;
            
            // Sum all earnings
            document.querySelectorAll('.currency-input').forEach(input => {
                const id = input.id;
                if (id && ['workedHoursValue', 'thirteenthFirst', 'thirteenthSecond', 'referralCommission', 
                          'vacationBonus', 'costHelp', 'familySalary', 'bonus'].includes(id)) {
                    const value = parseFloat(input.value.replace('R$ ', '').replace('.', '').replace(',', '.')) || 0;
                    totalEarnings += value;
                }
            });
            
            // Sum all deductions
            document.querySelectorAll('.currency-input').forEach(input => {
                const id = input.id;
                if (id && ['discount', 'inssDiscount', 'irrfDiscount', 'storeDiscount', 
                          'healthPlan', 'mei', 'otherDiscounts'].includes(id)) {
                    const value = parseFloat(input.value.replace('R$ ', '').replace('.', '').replace(',', '.')) || 0;
                    totalDeductions += value;
                }
            });
            
            // Update totals
            document.getElementById('totalEarnings').textContent = 'R$ ' + totalEarnings.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('totalDeductions').textContent = 'R$ ' + totalDeductions.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('netSalary').textContent = 'R$ ' + (totalEarnings - totalDeductions).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        
        // Recalcular totais quando os valores mudam
        document.querySelectorAll('.currency-input').forEach(input => {
            if (input.id !== 'workedHoursValue') {
                input.addEventListener('input', calculateTotals);
            }
        });
        
        // Atualizar título quando mês/ano ou nome do colaborador mudar
        const monthYearSelect = document.getElementById('monthYearSelect');
        const employeeNameInput = document.getElementById('employeeNameInput');
        const monthYearSpan = document.getElementById('monthYear');
        const employeeNameSpan = document.getElementById('employeeName');
        
        function updateTitle() {
            monthYearSpan.textContent = monthYearSelect.options[monthYearSelect.selectedIndex].text;
            employeeNameSpan.textContent = employeeNameInput.value;
        }
        
        monthYearSelect.addEventListener('change', updateTitle);
        employeeNameInput.addEventListener('input', updateTitle);
        
        // Botões de salvar
        document.getElementById('saveBtn').addEventListener('click', function() {
            savePayrollData(false);
        });
        
        document.getElementById('saveAndGenerateBtn').addEventListener('click', function() {
            savePayrollData(true);
        });
        
        function savePayrollData(generatePDF) {
            // Validação básica
            if (!monthYearSelect.value || !employeeNameInput.value || !hourlyRateInput.value) {
                alert('Por favor, preencha todos os campos obrigatórios (Mês/Ano, Colaborador e Valor/Hora).');
                return;
            }
            
            // Aqui você normalmente enviaria os dados para o servidor
            if (generatePDF) {
                generatePayrollPDF();
            }
            
            alert(`Dados ${generatePDF ? 'salvos e comprovante gerado' : 'salvos'} com sucesso!`);
            modal.classList.remove('show');
        }
        
        function generatePayrollPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título
            doc.setFontSize(18);
            doc.text('COMPROVANTE DE FOLHA DE PAGAMENTO', 105, 15, { align: 'center' });
            
            // Informações do cabeçalho
            doc.setFontSize(12);
            doc.text(`Colaborador: ${employeeNameInput.value}`, 15, 25);
            doc.text(`Mês/Ano: ${monthYearSelect.options[monthYearSelect.selectedIndex].text}`, 15, 30);
            doc.text(`Valor/Hora: ${hourlyRateInput.value}`, 15, 35);
            
            // Observações
            const observations = document.getElementById('observations').value;
            if (observations) {
                doc.text(`Observações: ${observations}`, 15, 45);
            }
            
            // Tabela de Proventos
            doc.setFontSize(14);
            doc.text('PROVENTOS', 15, 55);
            
            const earningsData = [
                ['Horas trabalhadas', document.getElementById('workedHours').value || '00:00', document.getElementById('workedHoursValue').value || 'R$ 0,00'],
                ['13º - 1ª parcela', '', document.getElementById('thirteenthFirst').value || 'R$ 0,00'],
                ['13º - 2ª parcela', '', document.getElementById('thirteenthSecond').value || 'R$ 0,00'],
                ['Comissão por indicação', '', document.getElementById('referralCommission').value || 'R$ 0,00'],
                ['Férias + 1/3', '', document.getElementById('vacationBonus').value || 'R$ 0,00'],
                ['Ajuda de custo', '', document.getElementById('costHelp').value || 'R$ 0,00'],
                ['Salário família', '', document.getElementById('familySalary').value || 'R$ 0,00'],
                ['Gratificação', '', document.getElementById('bonus').value || 'R$ 0,00'],
                ['TOTAL PROVENTOS', '', document.getElementById('totalEarnings').textContent]
            ];
            
            doc.autoTable({
                startY: 60,
                head: [['Descrição', 'Horas/Dias', 'Valor (R$)']],
                body: earningsData,
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185] },
                margin: { left: 15 }
            });
            
            // Tabela de Descontos
            doc.setFontSize(14);
            doc.text('DESCONTOS', 15, doc.autoTable.previous.finalY + 15);
            
            const deductionsData = [
                ['Desconto', document.getElementById('discount').value || 'R$ 0,00'],
                ['INSS', document.getElementById('inssDiscount').value || 'R$ 0,00'],
                ['IRRF', document.getElementById('irrfDiscount').value || 'R$ 0,00'],
                ['Lojinha', document.getElementById('storeDiscount').value || 'R$ 0,00'],
                ['Plano de saúde', document.getElementById('healthPlan').value || 'R$ 0,00'],
                ['MEI', document.getElementById('mei').value || 'R$ 0,00'],
                ['Outros', document.getElementById('otherDiscounts').value || 'R$ 0,00'],
                ['TOTAL DESCONTOS', document.getElementById('totalDeductions').textContent]
            ];
            
            doc.autoTable({
                startY: doc.autoTable.previous.finalY + 20,
                head: [['Descrição', 'Valor (R$)']],
                body: deductionsData,
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185] },
                margin: { left: 15 }
            });
            
            // Resultado final
            doc.setFontSize(16);
            doc.text(`TOTAL LÍQUIDO: ${document.getElementById('netSalary').textContent}`, 15, doc.autoTable.previous.finalY + 20);
            
            // Rodapé
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('Gerado em: ' + new Date().toLocaleString('pt-BR'), 15, 285);
            
            // Salvar o PDF
            doc.save(`Folha_${employeeNameInput.value}_${monthYearSelect.options[monthYearSelect.selectedIndex].text}.pdf`);
        }
        
        // Cálculos iniciais
        calculateWorkedHoursValue();
        calculateTotals();
    });
</script>
{% endblock %}